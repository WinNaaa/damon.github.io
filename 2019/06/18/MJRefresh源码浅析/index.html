<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>MJRefresh源码浅析 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="MJRefresh 是一个功能强大的 iOS 上拉下拉刷新组件。有很多大厂App（抖音、快手、京东、喜马拉雅等）都在使用，所以是一个很值得学习的库。 原理先简单说明上拉下拉刷新的原理再去详细分析 MJRefresh 框架结构以及具体实现。 header&#x2F;footer的位置首先 header&#x2F;footer 是添加到 UIScrollView 上的，是它的子控件，比如 header 的高度是40，那么">
<meta property="og:type" content="article">
<meta property="og:title" content="MJRefresh源码浅析">
<meta property="og:url" content="http://example.com/2019/06/18/MJRefresh%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="MJRefresh 是一个功能强大的 iOS 上拉下拉刷新组件。有很多大厂App（抖音、快手、京东、喜马拉雅等）都在使用，所以是一个很值得学习的库。 原理先简单说明上拉下拉刷新的原理再去详细分析 MJRefresh 框架结构以及具体实现。 header&#x2F;footer的位置首先 header&#x2F;footer 是添加到 UIScrollView 上的，是它的子控件，比如 header 的高度是40，那么">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/mjrefresh_1.png">
<meta property="article:published_time" content="2019-06-18T13:14:09.000Z">
<meta property="article:modified_time" content="2020-09-15T01:59:35.280Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/mjrefresh_1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-MJRefresh源码浅析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/06/18/MJRefresh%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2019-06-18T13:14:09.000Z" itemprop="datePublished">2019-06-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      MJRefresh源码浅析
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://github.com/CoderMJLee/MJRefresh">MJRefresh</a> 是一个功能强大的 iOS 上拉下拉刷新组件。有很多大厂App（抖音、快手、京东、喜马拉雅等）都在使用，所以是一个很值得学习的库。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>先简单说明上拉下拉刷新的原理再去详细分析 <code>MJRefresh</code> 框架结构以及具体实现。</p>
<h3 id="header-footer的位置"><a href="#header-footer的位置" class="headerlink" title="header/footer的位置"></a>header/footer的位置</h3><p>首先 header/footer 是添加到 <code>UIScrollView</code> 上的，是它的子控件，比如 header 的高度是40，那么它的y值就是 <code>-40 </code> ，footer的y值就是 <code>contentSizeHeight</code>。</p>
<h3 id="下拉-上拉悬停"><a href="#下拉-上拉悬停" class="headerlink" title="下拉/上拉悬停"></a>下拉/上拉悬停</h3><p>上拉或者下拉到一定程度，松手后就会进入刷新状态，这时候 header/footer 都在显示在可见范围悬停，这是通过设置 UIScrollView 的 <code>contentInset.top</code> 和 <code>contentInset.bottom</code> 来实现，刷新结束后，再重置回来。</p>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>上面介绍了一些上拉下拉的原理，其实很简单， 接下去具体看一下 <code>MJRefresh</code> 是如何做的。</p>
<h3 id="结构设计"><a href="#结构设计" class="headerlink" title="结构设计"></a>结构设计</h3><p><img src="/images/mjrefresh_1.png"></p>
<p><code>MJRefreshComponent</code> 是header和footer 的基类，实际都是使用最后一层的类。接下来具体看每个类的具体职责和实现。</p>
<h3 id="MJRefreshComponent"><a href="#MJRefreshComponent" class="headerlink" title="MJRefreshComponent"></a>MJRefreshComponent</h3><p>这个类作为基类，主要的职责就是：</p>
<h4 id="1-声明刷新控件的状态，刷新的回调，交给子类去实现的函数"><a href="#1-声明刷新控件的状态，刷新的回调，交给子类去实现的函数" class="headerlink" title="1. 声明刷新控件的状态，刷新的回调，交给子类去实现的函数"></a>1. 声明刷新控件的状态，刷新的回调，交给子类去实现的函数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** 刷新控件的状态 *&#x2F;</span><br><span class="line">typedef NS_ENUM(NSInteger, MJRefreshState) &#123;</span><br><span class="line">    &#x2F;** 普通闲置状态 *&#x2F;</span><br><span class="line">    MJRefreshStateIdle &#x3D; 1,</span><br><span class="line">    &#x2F;** 松开就可以进行刷新的状态 *&#x2F;</span><br><span class="line">    MJRefreshStatePulling,</span><br><span class="line">    &#x2F;** 正在刷新中的状态 *&#x2F;</span><br><span class="line">    MJRefreshStateRefreshing,</span><br><span class="line">    &#x2F;** 即将刷新的状态 *&#x2F;</span><br><span class="line">    MJRefreshStateWillRefresh,</span><br><span class="line">    &#x2F;** 所有数据加载完毕，没有更多的数据了 *&#x2F;</span><br><span class="line">    MJRefreshStateNoMoreData</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;** 刷新用到的回调类型 *&#x2F;</span><br><span class="line">typedef void (^MJRefreshComponentAction)(void);</span><br><span class="line"></span><br><span class="line">#pragma mark - 交给子类们去实现</span><br><span class="line">&#x2F;** 初始化 *&#x2F;</span><br><span class="line">- (void)prepare NS_REQUIRES_SUPER;</span><br><span class="line">&#x2F;** 摆放子控件frame *&#x2F;</span><br><span class="line">- (void)placeSubviews NS_REQUIRES_SUPER;</span><br><span class="line">&#x2F;** 当scrollView的contentOffset发生改变的时候调用 *&#x2F;</span><br><span class="line">- (void)scrollViewContentOffsetDidChange:(nullable NSDictionary *)change NS_REQUIRES_SUPER;</span><br><span class="line">&#x2F;** 当scrollView的contentSize发生改变的时候调用 *&#x2F;</span><br><span class="line">- (void)scrollViewContentSizeDidChange:(nullable NSDictionary *)change NS_REQUIRES_SUPER;</span><br><span class="line">&#x2F;** 当scrollView的拖拽状态发生改变的时候调用 *&#x2F;</span><br><span class="line">- (void)scrollViewPanStateDidChange:(nullable NSDictionary *)change NS_REQUIRES_SUPER;</span><br></pre></td></tr></table></figure>
<h4 id="2-获取-UIScrollView，记录最开始的-contentInset"><a href="#2-获取-UIScrollView，记录最开始的-contentInset" class="headerlink" title="2. 获取 UIScrollView，记录最开始的 contentInset"></a>2. 获取 UIScrollView，记录最开始的 contentInset</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)willMoveToSuperview:(<span class="built_in">UIView</span> *)newSuperview</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> willMoveToSuperview:newSuperview];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果不是UIScrollView，不做任何事情</span></span><br><span class="line">    <span class="keyword">if</span> (newSuperview &amp;&amp; ![newSuperview isKindOfClass:[<span class="built_in">UIScrollView</span> <span class="keyword">class</span>]]) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 旧的父控件移除监听</span></span><br><span class="line">    [<span class="keyword">self</span> removeObservers];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (newSuperview) &#123; <span class="comment">// 新的父控件</span></span><br><span class="line">        <span class="comment">// 记录UIScrollView</span></span><br><span class="line">        _scrollView = (<span class="built_in">UIScrollView</span> *)newSuperview;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置宽度</span></span><br><span class="line">        <span class="keyword">self</span>.mj_w = _scrollView.mj_w;</span><br><span class="line">        <span class="comment">// 设置位置</span></span><br><span class="line">        <span class="keyword">self</span>.mj_x = -_scrollView.mj_insetL;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 设置永远支持垂直弹簧效果</span></span><br><span class="line">        _scrollView.alwaysBounceVertical = <span class="literal">YES</span>;</span><br><span class="line">        <span class="comment">// 记录UIScrollView最开始的contentInset</span></span><br><span class="line">        _scrollViewOriginalInset = _scrollView.mj_inset;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加监听</span></span><br><span class="line">        [<span class="keyword">self</span> addObservers];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记录 <code>ContentInset</code> 在 iOS11之后是获取 <code>adjustedContentInset</code> 属性。顺便看下设置 <code>contentInset</code> 的实现</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setMj_insetT:(<span class="built_in">CGFloat</span>)mj_insetT</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIEdgeInsets</span> inset = <span class="keyword">self</span>.contentInset;</span><br><span class="line">    inset.top = mj_insetT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __IPHONE_11_0</span></span><br><span class="line">    <span class="keyword">if</span> (respondsToAdjustedContentInset_) &#123;</span><br><span class="line">        inset.top -= (<span class="keyword">self</span>.adjustedContentInset.top - <span class="keyword">self</span>.contentInset.top);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">self</span>.contentInset = inset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-添加监听"><a href="#3-添加监听" class="headerlink" title="3. 添加监听"></a>3. 添加监听</h4><p>监听 contentOffset、contentSize、panGestureRecognizer的state。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addObservers</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservingOptions</span> options = <span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span>;</span><br><span class="line">    [<span class="keyword">self</span>.scrollView addObserver:<span class="keyword">self</span> forKeyPath:MJRefreshKeyPathContentOffset options:options context:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="keyword">self</span>.scrollView addObserver:<span class="keyword">self</span> forKeyPath:MJRefreshKeyPathContentSize options:options context:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">self</span>.pan = <span class="keyword">self</span>.scrollView.panGestureRecognizer;</span><br><span class="line">    [<span class="keyword">self</span>.pan addObserver:<span class="keyword">self</span> forKeyPath:MJRefreshKeyPathPanState options:options context:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>监听实现，<strong>具体处理交给子类</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 遇到这些情况就直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.userInteractionEnabled) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这个就算看不见也需要处理</span></span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:MJRefreshKeyPathContentSize]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> scrollViewContentSizeDidChange:change];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 看不见</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.hidden) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:MJRefreshKeyPathContentOffset]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> scrollViewContentOffsetDidChange:change];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:MJRefreshKeyPathPanState]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> scrollViewPanStateDidChange:change];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)scrollViewContentOffsetDidChange:(<span class="built_in">NSDictionary</span> *)change&#123;&#125;</span><br><span class="line">- (<span class="keyword">void</span>)scrollViewContentSizeDidChange:(<span class="built_in">NSDictionary</span> *)change&#123;&#125;</span><br><span class="line">- (<span class="keyword">void</span>)scrollViewPanStateDidChange:(<span class="built_in">NSDictionary</span> *)change&#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-开始刷新和结束刷新"><a href="#4-开始刷新和结束刷新" class="headerlink" title="4. 开始刷新和结束刷新"></a>4. 开始刷新和结束刷新</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)beginRefreshing</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:MJRefreshFastAnimationDuration animations:^&#123;</span><br><span class="line">        <span class="keyword">self</span>.alpha = <span class="number">1.0</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">      <span class="comment">// 初始化 拖拽的百分比</span></span><br><span class="line">    <span class="keyword">self</span>.pullingPercent = <span class="number">1.0</span>;</span><br><span class="line">    <span class="comment">// 只要正在刷新，就完全显示</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.window) &#123;</span><br><span class="line">        <span class="keyword">self</span>.state = MJRefreshStateRefreshing;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 预防正在刷新中时，调用本方法使得header inset回置失败</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.state != MJRefreshStateRefreshing) &#123;</span><br><span class="line">            <span class="keyword">self</span>.state = MJRefreshStateWillRefresh;</span><br><span class="line">            <span class="comment">// 刷新(预防从另一个控制器回到这个控制器的情况，回来要重新刷新一下)</span></span><br><span class="line">            [<span class="keyword">self</span> setNeedsDisplay];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)endRefreshing</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshDispatchAsyncOnMainQueue(<span class="keyword">self</span>.state = MJRefreshStateIdle;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark 是否正在刷新</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isRefreshing</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.state == MJRefreshStateRefreshing || <span class="keyword">self</span>.state == MJRefreshStateWillRefresh;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MJRefreshHeader"><a href="#MJRefreshHeader" class="headerlink" title="MJRefreshHeader"></a>MJRefreshHeader</h3><p>MJRefreshHeader 是所有 header 的父类，它的职责是：</p>
<h4 id="1-初始化设置"><a href="#1-初始化设置" class="headerlink" title="1.  初始化设置"></a>1.  初始化设置</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)prepare</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> prepare];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置key</span></span><br><span class="line">    <span class="keyword">self</span>.lastUpdatedTimeKey = MJRefreshHeaderLastUpdatedTimeKey;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置高度</span></span><br><span class="line">    <span class="keyword">self</span>.mj_h = MJRefreshHeaderHeight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-设置y值"><a href="#2-设置y值" class="headerlink" title="2. 设置y值"></a>2. 设置y值</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)placeSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> placeSubviews];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置y值(当自己的高度发生改变了，肯定要重新调整Y值，所以放到placeSubviews方法中设置y值)</span></span><br><span class="line">    <span class="keyword">self</span>.mj_y = - <span class="keyword">self</span>.mj_h - <span class="keyword">self</span>.ignoredScrollViewContentInsetTop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>ignoredScrollViewContentInsetTop</code> 一般很少用到</p>
<h4 id="3-监听到-contentOffset-改变的具体实现"><a href="#3-监听到-contentOffset-改变的具体实现" class="headerlink" title="3. 监听到 contentOffset 改变的具体实现"></a>3. 监听到 contentOffset 改变的具体实现</h4><p>主要是根据偏移量来决定松手时候可刷新，还有就是<strong>悬停操作</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)scrollViewContentOffsetDidChange:(<span class="built_in">NSDictionary</span> *)change</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> scrollViewContentOffsetDidChange:change];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在刷新的refreshing状态</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">        [<span class="keyword">self</span> resetInset];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 跳转到下一个控制器时，contentInset可能会变</span></span><br><span class="line">    _scrollViewOriginalInset = <span class="keyword">self</span>.scrollView.mj_inset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 当前的contentOffset</span></span><br><span class="line">    <span class="built_in">CGFloat</span> offsetY = <span class="keyword">self</span>.scrollView.mj_offsetY;</span><br><span class="line">    <span class="comment">// 头部控件刚好出现的offsetY</span></span><br><span class="line">    <span class="built_in">CGFloat</span> happenOffsetY = - <span class="keyword">self</span>.scrollViewOriginalInset.top;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果是向上滚动到看不见头部控件，直接返回</span></span><br><span class="line">    <span class="comment">// &gt;= -&gt; &gt;</span></span><br><span class="line">    <span class="keyword">if</span> (offsetY &gt; happenOffsetY) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 普通 和 即将刷新 的临界点</span></span><br><span class="line">    <span class="built_in">CGFloat</span> normal2pullingOffsetY = happenOffsetY - <span class="keyword">self</span>.mj_h;</span><br><span class="line">    <span class="built_in">CGFloat</span> pullingPercent = (happenOffsetY - offsetY) / <span class="keyword">self</span>.mj_h;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.scrollView.isDragging) &#123; <span class="comment">// 如果正在拖拽</span></span><br><span class="line">        <span class="keyword">self</span>.pullingPercent = pullingPercent;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStateIdle &amp;&amp; offsetY &lt; normal2pullingOffsetY) &#123;</span><br><span class="line">            <span class="comment">// 转为即将刷新状态</span></span><br><span class="line">            <span class="keyword">self</span>.state = MJRefreshStatePulling;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStatePulling &amp;&amp; offsetY &gt;= normal2pullingOffsetY) &#123;</span><br><span class="line">            <span class="comment">// 转为普通状态</span></span><br><span class="line">            <span class="keyword">self</span>.state = MJRefreshStateIdle;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStatePulling) &#123;<span class="comment">// 即将刷新 &amp;&amp; 手松开</span></span><br><span class="line">        <span class="comment">// 开始刷新</span></span><br><span class="line">        [<span class="keyword">self</span> beginRefreshing];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pullingPercent &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.pullingPercent = pullingPercent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个方法最主要是记录临界点 <code>CGFloat normal2pullingOffsetY = happenOffsetY - self.mj_h;</code> ，用 <code>isDragging</code> 属性来判断用户是否已经松手，如果没松手，就根据 <code>contentOffset</code> 来设置状态（提示松手可刷新或者取消），如果收松开并且状态是 <code>MJRefreshStatePulling</code> 就调用 <code>beginRefreshing</code> 开始刷新。header 并没有重写 <code>beginRefreshing</code> ，所以是调用基类的。</p>
<p>还有一个主要功能是<strong>悬停操作</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在刷新的refreshing状态</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">  [<span class="keyword">self</span> resetInset];</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)resetInset &#123;</span><br><span class="line">    <span class="keyword">if</span> (@available(iOS <span class="number">11.0</span>, *)) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果 iOS 10 及以下系统在刷新时, push 新的 VC, 等待刷新完成后回来, 会导致顶部 Insets.top 异常, 不能 resetInset, 检查一下这种特殊情况</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.window) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sectionheader停留解决</span></span><br><span class="line">    <span class="built_in">CGFloat</span> insetT = - <span class="keyword">self</span>.scrollView.mj_offsetY &gt; _scrollViewOriginalInset.top ? - <span class="keyword">self</span>.scrollView.mj_offsetY : _scrollViewOriginalInset.top;</span><br><span class="line">    insetT = insetT &gt; <span class="keyword">self</span>.mj_h + _scrollViewOriginalInset.top ? <span class="keyword">self</span>.mj_h + _scrollViewOriginalInset.top : insetT;</span><br><span class="line">    <span class="keyword">self</span>.insetTDelta = _scrollViewOriginalInset.top - insetT;</span><br><span class="line">    <span class="comment">// 避免 CollectionView 在使用根据 Autolayout 和 内容自动伸缩 Cell, 刷新时导致的 Layout 异常渲染问题</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.scrollView.mj_insetT != insetT) &#123;</span><br><span class="line">        <span class="keyword">self</span>.scrollView.mj_insetT = insetT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和之前讲的一样，悬停的原理就是设置 <code>contentInset.top</code> 。</p>
<p><code>self.insetTDelta</code> 这个属性可以理解为 header 的高度取反。</p>
<h4 id="4-状态切换"><a href="#4-状态切换" class="headerlink" title="4. 状态切换"></a>4. 状态切换</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setState:(MJRefreshState)state</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshCheckState</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据状态做事情</span></span><br><span class="line">    <span class="keyword">if</span> (state == MJRefreshStateIdle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldState != MJRefreshStateRefreshing) <span class="keyword">return</span>;</span><br><span class="line">        [<span class="keyword">self</span> headerEndingAction];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">        [<span class="keyword">self</span> headerRefreshingAction];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p> <code>headerEndingAction</code> 和 <code>headerRefreshingAction</code> 是对 <code>contentOffset</code> 做动画</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)headerRefreshingAction &#123;</span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:MJRefreshFastAnimationDuration animations:^&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.scrollView.panGestureRecognizer.state != <span class="built_in">UIGestureRecognizerStateCancelled</span>) &#123;</span><br><span class="line">            <span class="built_in">CGFloat</span> top = <span class="keyword">self</span>.scrollViewOriginalInset.top + <span class="keyword">self</span>.mj_h;</span><br><span class="line">            <span class="comment">// 增加滚动区域top</span></span><br><span class="line">            <span class="keyword">self</span>.scrollView.mj_insetT = top;</span><br><span class="line">            <span class="comment">// 设置滚动位置</span></span><br><span class="line">            <span class="built_in">CGPoint</span> offset = <span class="keyword">self</span>.scrollView.contentOffset;</span><br><span class="line">            offset.y = -top;</span><br><span class="line">            [<span class="keyword">self</span>.scrollView setContentOffset:offset animated:<span class="literal">NO</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">        [<span class="keyword">self</span> executeRefreshingCallback];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MJRefreshStateHeader"><a href="#MJRefreshStateHeader" class="headerlink" title="MJRefreshStateHeader"></a>MJRefreshStateHeader</h3><p><code>MJRefreshHeader</code> 作为公共header，已经把原理篇的事情都做完了，设置y值、状态切换、悬停处理。</p>
<p>那么看看 <code>MJRefreshStateHeader</code> 的主要职责：</p>
<h4 id="1-初始化操作"><a href="#1-初始化操作" class="headerlink" title="1. 初始化操作"></a>1. 初始化操作</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)prepare</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> prepare];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化间距</span></span><br><span class="line">    <span class="keyword">self</span>.labelLeftInset = MJRefreshLabelLeftInset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化文字</span></span><br><span class="line">    [<span class="keyword">self</span> setTitle:[<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderIdleText] forState:MJRefreshStateIdle];</span><br><span class="line">  </span><br><span class="line">    [<span class="keyword">self</span> setTitle:[<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderPullingText] forState:MJRefreshStatePulling];</span><br><span class="line">  </span><br><span class="line">    [<span class="keyword">self</span> setTitle:[<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderRefreshingText] forState:MJRefreshStateRefreshing];</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化文字的原理就是用字典来存储每个状态对应的 <code>title</code>。</p>
<h4 id="2-对-Label-进行布局"><a href="#2-对-Label-进行布局" class="headerlink" title="2. 对 Label 进行布局"></a>2. 对 Label 进行布局</h4><p>MJRefreshStateHeader 是负责状态Label和更新时间Label</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)placeSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> placeSubviews];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.stateLabel.hidden) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> noConstrainsOnStatusLabel = <span class="keyword">self</span>.stateLabel.constraints.count == <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) &#123;</span><br><span class="line">        <span class="comment">// 状态</span></span><br><span class="line">        <span class="keyword">if</span> (noConstrainsOnStatusLabel) <span class="keyword">self</span>.stateLabel.frame = <span class="keyword">self</span>.bounds;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">CGFloat</span> stateLabelH = <span class="keyword">self</span>.mj_h * <span class="number">0.5</span>;</span><br><span class="line">        <span class="comment">// 状态</span></span><br><span class="line">        <span class="keyword">if</span> (noConstrainsOnStatusLabel) &#123;</span><br><span class="line">            <span class="keyword">self</span>.stateLabel.mj_x = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">self</span>.stateLabel.mj_y = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">self</span>.stateLabel.mj_w = <span class="keyword">self</span>.mj_w;</span><br><span class="line">            <span class="keyword">self</span>.stateLabel.mj_h = stateLabelH;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新时间</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.lastUpdatedTimeLabel.constraints.count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_x = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_y = stateLabelH;</span><br><span class="line">            <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_w = <span class="keyword">self</span>.mj_w;</span><br><span class="line">            <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_h = <span class="keyword">self</span>.mj_h - <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-切换状态"><a href="#3-切换状态" class="headerlink" title="3. 切换状态"></a>3. 切换状态</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setState:(MJRefreshState)state</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshCheckState</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置状态文字</span></span><br><span class="line">    <span class="keyword">self</span>.stateLabel.text = <span class="keyword">self</span>.stateTitles[@(state)];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重新设置key（重新显示时间）</span></span><br><span class="line">    <span class="keyword">self</span>.lastUpdatedTimeKey = <span class="keyword">self</span>.lastUpdatedTimeKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-设置上次刷新日期-Text"><a href="#4-设置上次刷新日期-Text" class="headerlink" title="4. 设置上次刷新日期 Text"></a>4. 设置上次刷新日期 Text</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setLastUpdatedTimeKey:(<span class="built_in">NSString</span> *)lastUpdatedTimeKey</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> setLastUpdatedTimeKey:lastUpdatedTimeKey];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果label隐藏了，就不用再处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSDate</span> *lastUpdatedTime = [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] objectForKey:lastUpdatedTimeKey];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果有block</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.lastUpdatedTimeText) &#123;</span><br><span class="line">        <span class="keyword">self</span>.lastUpdatedTimeLabel.text = <span class="keyword">self</span>.lastUpdatedTimeText(lastUpdatedTime);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (lastUpdatedTime) &#123;</span><br><span class="line">        <span class="comment">// 1.获得年月日</span></span><br><span class="line">        <span class="built_in">NSCalendar</span> *calendar = [<span class="built_in">NSCalendar</span> calendarWithIdentifier:<span class="built_in">NSCalendarIdentifierGregorian</span>];</span><br><span class="line">        <span class="built_in">NSUInteger</span> unitFlags = <span class="built_in">NSCalendarUnitYear</span>| <span class="built_in">NSCalendarUnitMonth</span> | <span class="built_in">NSCalendarUnitDay</span> | <span class="built_in">NSCalendarUnitHour</span> | <span class="built_in">NSCalendarUnitMinute</span>;</span><br><span class="line">        <span class="built_in">NSDateComponents</span> *cmp1 = [calendar components:unitFlags fromDate:lastUpdatedTime];</span><br><span class="line">        <span class="built_in">NSDateComponents</span> *cmp2 = [calendar components:unitFlags fromDate:[<span class="built_in">NSDate</span> date]];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2.格式化日期</span></span><br><span class="line">        <span class="built_in">NSDateFormatter</span> *formatter = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">        <span class="built_in">BOOL</span> isToday = <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">if</span> ([cmp1 day] == [cmp2 day]) &#123; <span class="comment">// 今天</span></span><br><span class="line">            formatter.dateFormat = <span class="string">@&quot; HH:mm&quot;</span>;</span><br><span class="line">            isToday = <span class="literal">YES</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([cmp1 year] == [cmp2 year]) &#123; <span class="comment">// 今年</span></span><br><span class="line">            formatter.dateFormat = <span class="string">@&quot;MM-dd HH:mm&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            formatter.dateFormat = <span class="string">@&quot;yyyy-MM-dd HH:mm&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSString</span> *time = [formatter stringFromDate:lastUpdatedTime];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.显示日期</span></span><br><span class="line">        <span class="keyword">self</span>.lastUpdatedTimeLabel.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@%@%@&quot;</span>,</span><br><span class="line">                                          [<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderLastTimeText],</span><br><span class="line">                                          isToday ? [<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderDateTodayText] : <span class="string">@&quot;&quot;</span>,</span><br><span class="line">                                          time];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.lastUpdatedTimeLabel.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@%@&quot;</span>,</span><br><span class="line">                                          [<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderLastTimeText],</span><br><span class="line">                                          [<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderNoneLastDateText]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一个 <code> lastUpdatedTimeText</code> block 可以自定义内容。这个设置会在切换 <code>state</code> 的时候调用。</p>
<h3 id="MJRefreshNormalHeader"><a href="#MJRefreshNormalHeader" class="headerlink" title="MJRefreshNormalHeader"></a>MJRefreshNormalHeader</h3><h4 id="1-初始化"><a href="#1-初始化" class="headerlink" title="1. 初始化"></a>1. 初始化</h4><p>刷新样式的初始化</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)prepare</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> prepare];</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 130000</span></span><br><span class="line">    <span class="keyword">if</span> (@available(iOS <span class="number">13.0</span>, *)) &#123;</span><br><span class="line">        _activityIndicatorViewStyle = <span class="built_in">UIActivityIndicatorViewStyleMedium</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    _activityIndicatorViewStyle = <span class="built_in">UIActivityIndicatorViewStyleGray</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-对控件进行布局"><a href="#2-对控件进行布局" class="headerlink" title="2. 对控件进行布局"></a>2. 对控件进行布局</h4><p>MJRefreshNormalHeader 主要是负责 箭头和刷新小菊花的控件。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)placeSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> placeSubviews];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 箭头的中心点</span></span><br><span class="line">    <span class="built_in">CGFloat</span> arrowCenterX = <span class="keyword">self</span>.mj_w * <span class="number">0.5</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.stateLabel.hidden) &#123;</span><br><span class="line">        <span class="built_in">CGFloat</span> stateWidth = <span class="keyword">self</span>.stateLabel.mj_textWidth;</span><br><span class="line">        <span class="built_in">CGFloat</span> timeWidth = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) &#123;</span><br><span class="line">            timeWidth = <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_textWidth;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">CGFloat</span> textWidth = MAX(stateWidth, timeWidth);</span><br><span class="line">        arrowCenterX -= textWidth / <span class="number">2</span> + <span class="keyword">self</span>.labelLeftInset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CGFloat</span> arrowCenterY = <span class="keyword">self</span>.mj_h * <span class="number">0.5</span>;</span><br><span class="line">    <span class="built_in">CGPoint</span> arrowCenter = <span class="built_in">CGPointMake</span>(arrowCenterX, arrowCenterY);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 箭头</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.arrowView.constraints.count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.arrowView.mj_size = <span class="keyword">self</span>.arrowView.image.size;</span><br><span class="line">        <span class="keyword">self</span>.arrowView.center = arrowCenter;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 圈圈</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.loadingView.constraints.count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.loadingView.center = arrowCenter;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.arrowView.tintColor = <span class="keyword">self</span>.stateLabel.textColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-状态切换处理"><a href="#3-状态切换处理" class="headerlink" title="3. 状态切换处理"></a>3. 状态切换处理</h4><p>根据状态对 <code>arrowView</code> 和 <code>loadView</code> 进行动画和显示隐藏</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setState:(MJRefreshState)state</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshCheckState</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据状态做事情</span></span><br><span class="line">    <span class="keyword">if</span> (state == MJRefreshStateIdle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldState == MJRefreshStateRefreshing) &#123;</span><br><span class="line">            <span class="keyword">self</span>.arrowView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line">            </span><br><span class="line">            [<span class="built_in">UIView</span> animateWithDuration:MJRefreshSlowAnimationDuration animations:^&#123;</span><br><span class="line">                <span class="keyword">self</span>.loadingView.alpha = <span class="number">0.0</span>;</span><br><span class="line">            &#125; completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">                <span class="comment">// 如果执行完动画发现不是idle状态，就直接返回，进入其他状态</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.state != MJRefreshStateIdle) <span class="keyword">return</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">self</span>.loadingView.alpha = <span class="number">1.0</span>;</span><br><span class="line">                [<span class="keyword">self</span>.loadingView stopAnimating];</span><br><span class="line">                <span class="keyword">self</span>.arrowView.hidden = <span class="literal">NO</span>;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.loadingView stopAnimating];</span><br><span class="line">            <span class="keyword">self</span>.arrowView.hidden = <span class="literal">NO</span>;</span><br><span class="line">            [<span class="built_in">UIView</span> animateWithDuration:MJRefreshFastAnimationDuration animations:^&#123;</span><br><span class="line">                <span class="keyword">self</span>.arrowView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == MJRefreshStatePulling) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.loadingView stopAnimating];</span><br><span class="line">        <span class="keyword">self</span>.arrowView.hidden = <span class="literal">NO</span>;</span><br><span class="line">        [<span class="built_in">UIView</span> animateWithDuration:MJRefreshFastAnimationDuration animations:^&#123;</span><br><span class="line">            <span class="keyword">self</span>.arrowView.transform = <span class="built_in">CGAffineTransformMakeRotation</span>(<span class="number">0.000001</span> - M_PI);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">        <span class="keyword">self</span>.loadingView.alpha = <span class="number">1.0</span>; <span class="comment">// 防止refreshing -&gt; idle的动画完毕动作没有被执行</span></span><br><span class="line">        [<span class="keyword">self</span>.loadingView startAnimating];</span><br><span class="line">        <span class="keyword">self</span>.arrowView.hidden = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MJRefreshGifHeader"><a href="#MJRefreshGifHeader" class="headerlink" title="MJRefreshGifHeader"></a>MJRefreshGifHeader</h3><p>MJRefreshGifHeader 和 MJRefreshNormalHeader 的作用一样，都是进行刷新控件的布局和操作的，只不过 normal 是常用的箭头和菊花。gif就是用gif图片</p>
<h4 id="1-设置图片数组"><a href="#1-设置图片数组" class="headerlink" title="1. 设置图片数组"></a>1. 设置图片数组</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setImages:(<span class="built_in">NSArray</span> *)images duration:(<span class="built_in">NSTimeInterval</span>)duration forState:(MJRefreshState)state </span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">if</span> (images == <span class="literal">nil</span>) <span class="keyword">return</span>; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.stateImages[@(state)] = images; </span><br><span class="line">    <span class="keyword">self</span>.stateDurations[@(state)] = @(duration); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 根据图片设置控件的高度 */</span> </span><br><span class="line">    <span class="built_in">UIImage</span> *image = [images firstObject]; </span><br><span class="line">    <span class="keyword">if</span> (image.size.height &gt; <span class="keyword">self</span>.mj_h) &#123; </span><br><span class="line">        <span class="keyword">self</span>.mj_h = image.size.height; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setImages:(<span class="built_in">NSArray</span> *)images forState:(MJRefreshState)state </span><br><span class="line">&#123; </span><br><span class="line">    [<span class="keyword">self</span> setImages:images duration:images.count * <span class="number">0.1</span> forState:state]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-对-gifView-进行布局"><a href="#2-对-gifView-进行布局" class="headerlink" title="2. 对 gifView 进行布局"></a>2. 对 gifView 进行布局</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)placeSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> placeSubviews];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.gifView.constraints.count) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.gifView.frame = <span class="keyword">self</span>.bounds;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.stateLabel.hidden &amp;&amp; <span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) &#123;</span><br><span class="line">        <span class="keyword">self</span>.gifView.contentMode = <span class="built_in">UIViewContentModeCenter</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.gifView.contentMode = <span class="built_in">UIViewContentModeRight</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGFloat</span> stateWidth = <span class="keyword">self</span>.stateLabel.mj_textWidth;</span><br><span class="line">        <span class="built_in">CGFloat</span> timeWidth = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) &#123;</span><br><span class="line">            timeWidth = <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_textWidth;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">CGFloat</span> textWidth = MAX(stateWidth, timeWidth);</span><br><span class="line">        <span class="keyword">self</span>.gifView.mj_w = <span class="keyword">self</span>.mj_w * <span class="number">0.5</span> - textWidth * <span class="number">0.5</span> - <span class="keyword">self</span>.labelLeftInset;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-状态切换"><a href="#3-状态切换" class="headerlink" title="3. 状态切换"></a>3. 状态切换</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setState:(MJRefreshState)state</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshCheckState</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据状态做事情</span></span><br><span class="line">    <span class="keyword">if</span> (state == MJRefreshStatePulling || state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *images = <span class="keyword">self</span>.stateImages[@(state)];</span><br><span class="line">        <span class="keyword">if</span> (images.count == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        [<span class="keyword">self</span>.gifView stopAnimating];</span><br><span class="line">        <span class="keyword">if</span> (images.count == <span class="number">1</span>) &#123; <span class="comment">// 单张图片</span></span><br><span class="line">            <span class="keyword">self</span>.gifView.image = [images lastObject];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 多张图片</span></span><br><span class="line">            <span class="keyword">self</span>.gifView.animationImages = images;</span><br><span class="line">            <span class="keyword">self</span>.gifView.animationDuration = [<span class="keyword">self</span>.stateDurations[@(state)] doubleValue];</span><br><span class="line">            [<span class="keyword">self</span>.gifView startAnimating];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == MJRefreshStateIdle) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.gifView stopAnimating];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-根据拖拽的百分比来设置显示图片"><a href="#4-根据拖拽的百分比来设置显示图片" class="headerlink" title="4. 根据拖拽的百分比来设置显示图片"></a>4. 根据拖拽的百分比来设置显示图片</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setPullingPercent:(<span class="built_in">CGFloat</span>)pullingPercent</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> setPullingPercent:pullingPercent];</span><br><span class="line">    <span class="built_in">NSArray</span> *images = <span class="keyword">self</span>.stateImages[@(MJRefreshStateIdle)];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.state != MJRefreshStateIdle || images.count == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 停止动画</span></span><br><span class="line">    [<span class="keyword">self</span>.gifView stopAnimating];</span><br><span class="line">    <span class="comment">// 设置当前需要显示的图片</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> index =  images.count * pullingPercent;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= images.count) index = images.count - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">self</span>.gifView.image = images[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Header 的部分已经结束，最核心的就是 <code>MJRefreshComponent </code> 和 <code>MJRefreshHeader</code>，这两个类把上拉刷新的核心功能都做完了，剩下的类就是根据状态显示对应的UI。</p>
<p>所以如果要自定义下拉刷新的UI可以直接继承 <code>MJRefreshHeader</code>。</p>
<ol>
<li><p>在 <code>prepare</code> 方法进行初始化</p>
</li>
<li><p>在 <code>placeSubviews</code> 方法进行布局</p>
</li>
<li><p>处理状态切换</p>
<p>Footer 和 Header 的实现原理基本类似，就不多介绍了。总体来说上拉下拉刷新的原理还是比较简单的。通过看源码可以学到怎么分层，让每一个子类完成各自的事情，从而提高框架的可定制性。还有就是 <code>UIScrollView</code> 是比较复杂的控件，虽然原理简单但是实际上做出来的时候就是会出现不可思议的 bug， 可以学习如何追踪 bug 和解决 bug 的思路，<code>MJRefresh</code> 对 bug 的处理我没贴上去。感兴趣的可以自行学习。</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/06/18/MJRefresh%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/" data-id="ckld5k9tq0003wn2bc2ebcn62" data-title="MJRefresh源码浅析" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/06/25/TCP%E5%8D%8F%E8%AE%AE/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          TCP协议
        
      </div>
    </a>
  
  
    <a href="/2018/03/12/Django-REST-framework%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A5%87%E5%B7%A7%E6%B7%AB%E6%8A%80/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Django REST framework的一些奇巧淫技</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/06/25/TCP%E5%8D%8F%E8%AE%AE/">TCP协议</a>
          </li>
        
          <li>
            <a href="/2019/06/18/MJRefresh%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">MJRefresh源码浅析</a>
          </li>
        
          <li>
            <a href="/2018/03/12/Django-REST-framework%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A5%87%E5%B7%A7%E6%B7%AB%E6%8A%80/">Django REST framework的一些奇巧淫技</a>
          </li>
        
          <li>
            <a href="/2017/11/06/Python%E8%A3%85%E9%A5%B0%E5%99%A8/">Python装饰器</a>
          </li>
        
          <li>
            <a href="/2017/11/06/Python%E9%97%AD%E5%8C%85/">Python闭包</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>