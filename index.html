<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/25/TCP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/25/TCP%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">TCP协议</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-25 11:01:51" itemprop="dateCreated datePublished" datetime="2019-06-25T11:01:51+08:00">2019-06-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-15 10:14:48" itemprop="dateModified" datetime="2020-09-15T10:14:48+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>TCP是一个<strong>面向连接</strong>，<strong>可靠的</strong>，<strong>基于字节流</strong>的<strong>传输层</strong>通信协议，负责建立、维护、管理端到端连接。</p>
<h2 id="TCP-头的协议格式"><a href="#TCP-头的协议格式" class="headerlink" title="TCP 头的协议格式"></a>TCP 头的协议格式</h2><p><img src="/images/tcp_head.png"></p>
<ol>
<li>Source Port / Destination Port：源端口和目标端口，分别用16位来存储。tcp头没有ip地址，这是网络层做的事情。</li>
<li>Sequence Number：序列号，占16位，<strong>用来解决网络包乱序问题</strong>。假如一个报文段的序号是500,而数据有20个字节，这就表明这个报文段的第一个字节序号是500，最后一个字节的序号是519，下一个报文段的序号要从520开始。如果溢出了就回到0。</li>
<li>Acknowledgement Number：确认号，占16位，用来表示期望收到下一个报文段的第一个字节的序号，<strong>用来解决丢包的问题</strong>。假如A给B发数据，序列号是500，长度为20个字节（500 ~ 519），如果B都收到了这20个字节，就会在发给A的报文段中确认号为520，表明下一个序号应该是520</li>
<li>Offset：数据偏移，占4为位，表示 TCP 报文首部信息的长度，因为 TCP 首部可能会有选项内容，所以这个长度是不确定的。看图片右边的箭头就知道了，没有选项字段的话，TCP头部长度为20字节。</li>
<li>Reserved：保留字段，占6位，值通常为0</li>
<li>TCP Flags： 标志位，每个标志位表示一个控制功能，用来控制 TCP 的状态机。<ol>
<li>URG: 紧急指针（为0无效忽略，为1有效）</li>
<li>ACK：确认序号（为0表示报文中不含确认信息忽略确认号字段，为1表示确认号有效）</li>
<li>PSH：有兴趣可以自行查资料</li>
<li>RST：重建连接，让RST为1时，表示 TCP 连接中出现了严重差错（主机崩溃或其他原因），必须释放连接然后重连。</li>
<li>SYN：同步序列号，用于建立连接过程</li>
<li>FIN：用于释放一个连接，当FIN为1时，表示此报文段的发送方数据已发送完毕，并要求释放连接。</li>
</ol>
</li>
<li>Window：窗口，占16位，就是著名的滑动窗口，窗口是指发送方的接收窗口，这个要注意。窗口值就是告诉对方，不用等待我确认应答而可以继续发送的最大值，<strong>用来解决流控问题</strong>。</li>
<li>Checksum：检验和，占16位，有兴趣可以自行查资料</li>
<li>Urgent Pointer：紧急指针，占16位，只有当URG标志置1时紧急指针才有效，有兴趣可以自行查资料</li>
<li>TCP Options：TCP 选项，最长可达40个字节。</li>
</ol>
<h2 id="TCP建立连接（三次握手）"><a href="#TCP建立连接（三次握手）" class="headerlink" title="TCP建立连接（三次握手）"></a>TCP建立连接（三次握手）</h2><p><img src="/images/tcp_connect.jpeg"></p>
<p>A是客户端，B是服务端</p>
<ol>
<li><p>一开始 A 和 B 都处于 CLOSED 状态，B 调用 <code>listen</code>系统接口进行监听，B处于 LISTEN 状态。</p>
</li>
<li><p>A 调用 <code>connect</code> 方法向B发送请求报文，其中 TCP Flags （标志位）里的 SYN = 1，ACK = 0，选择一个初始序列 seq = 0，这时候 A 处于 SYN-SENT 状态。</p>
</li>
<li><p>B 收到请求报文，向 A 发送连接确认报文，SYN=1，ACK=1，确认号 ack = x + 1，同时也选择了一个初始序号 seq = y，这时候 B 处于 SYN-RCVD 状态。</p>
</li>
<li><p>A 收到 B 的连接确认报文后，还要向 B 发出确认报文，标志位 ACK=1，确认号 ack = y + 1，序列号 seq = x + 1，这时候 A 处于 ESTABLISHED 状态。`</p>
</li>
<li><p>B 收到 ACK 之后，就处于 ESTABLISHED 状态。</p>
</li>
</ol>
<h3 id="为什么要3次握手？"><a href="#为什么要3次握手？" class="headerlink" title="为什么要3次握手？"></a>为什么要3次握手？</h3><ul>
<li><p>初始序列号， 序列号在 TCP 连接中有非常重要的作用（解决乱序），因为初始序列号不是0或者固定的（如果是固定的攻击者就很容易猜到后续的确认号），所以初始是从 ISN（Inital Sequence Number）开始的，这是一个通过算法计算出来的随机值，所以双方都要确认对方的初始序列号。</p>
</li>
<li><p>防止错误或者过期的连接被服务器连接，有了第三次客户端的确认报文后，服务器就能判断哪些连接是要弃掉的。</p>
</li>
</ul>
<p>3次握手就一定可靠吗？不一定，因为你不能确认最后一个确认报文服务端收到了，有兴趣可以看下<strong>两军问题</strong>。</p>
<h3 id="SYN-超时"><a href="#SYN-超时" class="headerlink" title="SYN 超时"></a>SYN 超时</h3><p>如果在第二次握手结束后，A掉线了会怎样？这时候这个连接就处于一个中间状态，既没成功也没失败。如果B在一定时间内没收到A的确认报文会重发自己的确认报文。在Linux默认重试5次，间隔为1s,2s,4s,8s,16s，如果还没收到就会断开这个连接。</p>
<h3 id="SYN-Flood-攻击"><a href="#SYN-Flood-攻击" class="headerlink" title="SYN Flood 攻击"></a>SYN Flood 攻击</h3><p>   SYN Flood 属于 Dos 攻击的一种。就是向某个服务器端口发送大量的SYN包，然后下线。服务器会打开大量的半开连接，分配TCB（Transmission Control Block），从而把服务器的 syn 连接队列耗尽，同时也使得正常的连接也无法被响应。</p>
<p>接下来说一下防攻击的方法：</p>
<p>最粗暴的方法就是提高 TCP 端口连接容量的同时减少半开连接资源的占用时间。也可以减少半开状态下等待ACK消息的时间或者重发 SYN-ACK 消息的次数。但是这种只是权宜之计，还是会影响部分正常的连接请求。</p>
<p>消耗服务器资源的主要原因是因为当SYN数据报文一到达，系统立即分配TCB，从而占用了资源，因此，可以等到正常连接建立起来后再分配TCB就可以减轻服务器资源的消耗。常见的方法就是SYN Cache 和 SYN Cookie</p>
<p>SYN Cache 的原理是在收到一个SYN报文后，用一个 Hash Table 保存这种半连接信息，直到收到正常的ACK报文后再分配TCB。</p>
<p>SYN Cookies 是通过特定的算法把这种半开连接信息编码成 <code>Cookie</code> ，当作 Sequence Num 发给对方，这样不用保存任何信息，如果收到了对象的ACK信息，会重新计算一遍 <code>Cookie</code> ，从而决定是否分配TCB资源。这种方法也有缺点：因为不会保存这种半开的连接，就会丧失了重发SYN-ACK消息的能力，会部分降低正常用户的连接成功率。</p>
<h2 id="TCP-断开连接（四次挥手）"><a href="#TCP-断开连接（四次挥手）" class="headerlink" title="TCP 断开连接（四次挥手）"></a>TCP 断开连接（四次挥手）</h2><p><img src="/images/tcp_close.jpeg"></p>
<p>假设 A 是客户端， B 是服务端</p>
<ol>
<li>A 主动断开连接，发送 FIN = 1 的报文之后，进入 FIN_WAIT_1 的状态。</li>
<li>B 收到 A 的 FIN 报文之后，发送确认报文，就进入 CLOSE_WAIT 状态。这时候 A 不能给 B 发消息了，但是 B 还是可以向 A 发消息。</li>
<li>A 收到 B 的 确认报文之后，就进入 FIN_WAIT_2 的状态。</li>
<li>当 B 也要断开连接时，发送 FIN = 1 的报文给 A，B 从 CLOSE_WAIT 的 状态进入 LAST-ACK 状态。</li>
<li>当 A 收到 B 的 FIN 报文之后，A 会发送确认报文，然后进入 TIME_WAIT 状态。这个状态持续 2MSL 的时间，MSL 是 Maximum Segment Lifetime，<strong>报文最大生存时间</strong>，协议规定 MSL 为2分钟，Linux设置为30s</li>
<li>B 收到 A 的确认报文后，进入 CLOSED 状态。</li>
</ol>
<h3 id="为什么要四次挥手？"><a href="#为什么要四次挥手？" class="headerlink" title="为什么要四次挥手？"></a>为什么要四次挥手？</h3><p>因为 TCP 是全双工的，所以发送方和接收方都需要 FIN 和 ACK。</p>
<h3 id="为什么会有-TIME-WAIT-状态？"><a href="#为什么会有-TIME-WAIT-状态？" class="headerlink" title="为什么会有 TIME_WAIT 状态？"></a>为什么会有 TIME_WAIT 状态？</h3><p>最主要有两个原因：保证连接关闭，让这个连接不会跟后面的连接混在一起</p>
<h4 id="保证连接关闭"><a href="#保证连接关闭" class="headerlink" title="保证连接关闭"></a>保证连接关闭</h4><p>TIME_WAIT 其中的一个重要作用就是确保服务端收到其发 FIN 对应的 ACK 报文，不然的话如果服务端没收到 ACK，客户端这时候重新和服务端重新建立连接就会有问题，服务端会认为之前的连接是有效的，客户端重新发送 <code>SYN</code> 消息请求握手时会收到服务端的 <code>RST</code> 消息，连接建立的过程就会被终止。</p>
<h4 id="连接混合问题"><a href="#连接混合问题" class="headerlink" title="连接混合问题"></a>连接混合问题</h4><p>要考虑一种情况就是，服务端发送的消息，由于网络延迟直到TCP连接断开了客户端都没有收到，当客户端和服务器重新连接后，这个延迟的消息才发送到客户端，然而这个过期的消息客户端会认为是合理的，正常接收的话，那问题就比较严重了。</p>
<p>所以 TIME_WAIT 等待的时间一定要足够长，一来一去正好等待 2MSL</p>
<h2 id="TCP滑动窗口"><a href="#TCP滑动窗口" class="headerlink" title="TCP滑动窗口"></a>TCP滑动窗口</h2><p>滑动窗口可以说是TCP最重要的知识点了，TCP在早期没有窗口的时候，是使用 <code>send-wait-send</code> 模型。<strong>就是发送方在发送数据之后，会等待收到ACK之后再继续发送</strong>，如果超时还没收到ACK，要进行重传。这样就一个缺点就是，如果包的往返时间越长，网络的吞吐量会越差。TCP 为了解决这个问题，引入了窗口这个概念。</p>
<p>TCP的滑动窗口协议是传输层进行流控的一种措施，接收方通过通告发送方自己的窗口大小，从而控制发送方的发送速度，从而达到防止发送方发送速度过快而导致自己被淹没的目的。</p>
<p>在 TCP 头部看到有 Window 这个字段，这个窗口大小就是 <strong>接收端告诉发送端自己还有多少缓冲区无需等待确认应答可以继续发送数据的大小</strong>。</p>
<p>TCP的滑动窗口主要有两个作用：</p>
<ul>
<li>TCP的可靠性</li>
<li>TCP的流控</li>
</ul>
<p>过程：</p>
<p>假设 A 向 B 发送数据， 总长度500，每个报文段是100</p>
<ol>
<li>连接时 B 告诉 A，我的接收窗口 rwnd = 300</li>
<li>A 向 B 发送一个报文，序号为 1~100，还能发送200个字节</li>
<li>A 向 B 发送一个报文，序号为 101~200，还能发送100个字节</li>
<li>A 向 B 发送一个报文，序号为201~300，还能发送0个字节</li>
<li>B 收到了 A 的 第1<del>100 和 201</del>300的数据，中间101<del>200的报文丢失了，此时 B 会向 A 发送一个报文 ACK=101, rwnd=200（允许 A 发送 101</del>300序号的数据）</li>
<li>A 超时重传 </li>
</ol>
<h3 id="TCP滑动窗口基本原理"><a href="#TCP滑动窗口基本原理" class="headerlink" title="TCP滑动窗口基本原理"></a>TCP滑动窗口基本原理</h3><blockquote>
<p>TCP 发送端的 Window 分为四个部分</p>
</blockquote>
<ol>
<li><p>Sent and Acknowledged：发送成功并且收到ACK的数据</p>
</li>
<li><p>Sent But Not Yet Acknowledged：发送但没有收到ACK的数据，认为并没有完成发送</p>
</li>
<li><p>Not Sent，Recipient Ready to Receive：还没发送的数据，但是接收端还有空间接收</p>
</li>
<li><p>Not Sent，Recipient Not Ready to Receive：还没发送的数据，接收端没有空间接收</p>
</li>
</ol>
<p><img src="/images/tcp_send_window.jpg"></p>
<p>可以看到窗口大小时20字节（这个值在三次握手的时候进行传输的），对于发送方来说，滑动窗口是黑框的部分（已发送和可用窗口），当发送方收到 ACK = 36 时的窗口滑动</p>
<p><img src="/images/tcp_send_window_slide.png"></p>
<p>如果这时发送方继续发了5个字节，那么可用窗口就耗尽了，在接收到ACK之前无法继续发送数据。</p>
<blockquote>
<p>TCP 接收端的 Window 分为三个部分</p>
</blockquote>
<ol>
<li>接收并且确认过数据</li>
<li>未收到数据但是可以接收</li>
<li>未收到数据但是不能接收</li>
</ol>
<h3 id="Zero-Window"><a href="#Zero-Window" class="headerlink" title="Zero Window"></a>Zero Window</h3><p>如果窗口大小为0了，那么发送方就不会再发数据过来，直到收到ACK之后才会根据窗口大小继续发数据，但是如果这个ACK丢包了怎么办？为了防止这个问题，TCP 使用了 Zero Window Probe技术，简称ZWP，发送端在窗口变为0后，会发送ZWP的包给接收端，让接收端ACK它的窗口大小，这个值会设置成3次，第次大约30-60秒，如果3次过后还是0的话，有的TCP实现就会发RST把链接断了。</p>
<h3 id="糊涂窗口综合症"><a href="#糊涂窗口综合症" class="headerlink" title="糊涂窗口综合症"></a>糊涂窗口综合症</h3><p>如果接收方太忙了，来不及取走接收窗口里的数据，那么发送方的窗口就会越来越小，<strong>等到接收方只有几个字节的窗口，发送方还是义无反顾地发送这几个字节，这就是糊涂窗口综合症。</strong></p>
<p>因为 TCP + IP 头就有40个字节，为了传输这几个字节，有点太浪费了。</p>
<p>由上可知，糊涂窗口综合症的现象可以发生在发送方和接收方：</p>
<ul>
<li>接收端ACK一个小的窗口</li>
<li>发送端发送小数据</li>
</ul>
<p>所以，只有解决上面两个问题就可以了：</p>
<ul>
<li>接收端不ACK小窗口</li>
</ul>
<p>如果收到的数据导致窗口大小小于某个值，可以直接ACK 0 给发送端，这样就可以把窗口关闭阻止发送端再发数据过来。</p>
<ul>
<li>发送端避免发送小数据</li>
</ul>
<p>使用 Nagle 算法，这个算法的思路是延时处理，它满足以下两个条件中的一条才可以发送数据：</p>
<ul>
<li>等到窗口大小 &gt;= MSS 或者 数据大小 &gt;= MSS</li>
<li>收到ACK</li>
</ul>
<blockquote>
<p>MTU （Maximum Transmission Unit）最大传输单元，指的是IP数据报能经过一个物理网络的最大报文长度，一般为1500字节</p>
<p>MSS （Maximum Segment Size）TCP报文的最长报文长度，不包括TCP首部长度，一般来说，MSS = MTU - IP首部大小 - TCP首部大小</p>
</blockquote>
<p>Nagle 算法默认是打开的，而且它并不是禁止小包发送，只是禁止了大量的小包发送。</p>
<h2 id="TCP-的重传机制"><a href="#TCP-的重传机制" class="headerlink" title="TCP 的重传机制"></a>TCP 的重传机制</h2><p>在复杂的网络环境中，数据包是有可能丢的，TCP要保证所有包都可以到达，所以需要一个<strong>重传机制</strong>。</p>
<p>常见的重传机制:</p>
<ul>
<li>超时重传</li>
<li>快速重传</li>
<li>SACK</li>
<li>D-SACK</li>
</ul>
<h3 id="超时重传"><a href="#超时重传" class="headerlink" title="超时重传"></a>超时重传</h3><p>如果发送端认为发生了丢包现象（在<strong>一段时间内</strong>没有收到ACK），会重发这些数据包。有一种可能是这个数据包没有丢，只有绕了一段远路，TCP是传输层，并不知道数据在链路和物理层发生了什么。但是重发并不影响，<strong>因为接收端会自动忽略重复的包。</strong></p>
<p>怎么才算超时呢？最简单的方法就是设为一个固定值，但是如果两个端距离比较远的话，可能会导致大量的数据包被重发。TCP会根据网络延迟动态调整超时时间的算法。</p>
<p>先来了解两个概念：</p>
<ul>
<li><p>RTT（Round Trip Time）: 往返时间，<strong>就是数据包从发出去到接收到ACK的时间</strong>。</p>
</li>
<li><p>RTO（Retransmission Time Out）：重传超时，也就是超时时间</p>
</li>
</ul>
<p>RTO 的值是非常重要的，如果太大会导致丢了半天才重发，效率低下。如果太小会导致还没丢就重发，浪费资源，增加网络拥塞。</p>
<p>在Linux中，最开始是使用比较简单的经典算法 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc793#section-2.8">RFC793</a>，后来1988年提出了新的算法<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6298">RFC6298</a>。</p>
<h3 id="快速重传"><a href="#快速重传" class="headerlink" title="快速重传"></a>快速重传</h3><p>快速重传机制是基于接收端返回的数据来驱动，而不是时间。</p>
<p>例如发送端发出了 1，2，3，4，5份数据：</p>
<ul>
<li>1先到了，ACK 2</li>
<li>2 可能因为某些原因没到，3 先到了，回的ACK还是2</li>
<li>后面的 4，5也到了，2还是没收，ACK2</li>
<li>发送端收到了 三个 ACK = 2 的数据，就会重传2，不需要等待计时器超时</li>
<li>接收端收到了2，因为之前的3，4，5都到了，所以 ACK 6</li>
</ul>
<p>快速重传机制只解决了超时时间的问题，还有一个问题就是，到底该重传多少个包？在上面的例子中，应该重传2还是重传2，3，4，5呢？</p>
<h3 id="SACK"><a href="#SACK" class="headerlink" title="SACK"></a>SACK</h3><p>SACK（Selective Acknowledgment）：带选择确认的重传，这种方式是在TCP头部 <code>options</code> 字段加一个 <code>SACK</code> 的信息，就是<strong>最近收到的报文段的序列号范围</strong>，这样客户端就知道，哪些数据包已经到达服务器了。</p>
<p>例如：</p>
<ul>
<li>发送端发送 100~199 的数据，接收端收到 ACK 200</li>
<li>发送端发送 200 ~ 299 的数据</li>
<li>发送端发送 300 ~ 399 的数据</li>
<li>这时候接收端收到了 300 ~ 399 的数据，200 ~ 299 没收到，会回 ACK 200，SACK 300-400</li>
<li>发送端发送 400 ~ 499 的数据，再发送 500 ~ 599 的数据</li>
<li>接收端 收到了 500 ~ 599 的数据，没收到 400 ~ 499 的，还有之前的 200 ~ 299 也还没收到，这时候会回 ACK 200，SACK 300-400, 500-600</li>
</ul>
<p>这样发送端就可以根据 <code>SACK</code> 信息知道哪些数据到了，哪些没到。不过 SACK 有一个坑，接收方有可能把这些乱序的数据包删掉之后，再通知发送方。因为这个操作，发送端不能完全依赖SACK，还是要依赖ACK，重传计时器。</p>
<h3 id="D-SACK"><a href="#D-SACK" class="headerlink" title="D-SACK"></a>D-SACK</h3><p>D-SACK（Duplicate-SACK）：重复 SACK，这个机制是在 SACK 的基础上，加点额外信息，<strong>告诉发送方哪些数据自己重复接收了</strong>。</p>
<h4 id="Example-1："><a href="#Example-1：" class="headerlink" title="Example 1："></a>Example 1：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transmitted    Received    ACK Sent</span><br><span class="line">Segment        Segment     (Including SACK Blocks)</span><br><span class="line"></span><br><span class="line">3000-3499      3000-3499   3500 (ACK dropped)</span><br><span class="line">3500-3999      3500-3999   4000 (ACK dropped)</span><br><span class="line">3000-3499      3000-3499   4000, SACK&#x3D;3000-3500</span><br></pre></td></tr></table></figure>
<p>如上例所示，发送端 发送了 3000-3499 和 3500-3999 两段报文，接收端接收到了并发送ACK，但是这两个报文的ACK都丢了，发送端会以为丢数据包了，重发 3000-3499，这时候接收端发现数据重复接收，回了一个 ACK=4000，SACK = 3000-3500，因为ACK已经是4000了意味着收到了4000之前的数据，所以这个SACK就是D-SACK，告诉发送端收到了重复数据，这时候发送方就知道了，数据包没丢，丢的是ACK包。</p>
<p>下面的例子看文字应该都可以理解</p>
<h4 id="Example-2："><a href="#Example-2：" class="headerlink" title="Example 2："></a>Example 2：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Transmitted    Received    ACK Sent</span><br><span class="line">Segment        Segment     (Including SACK Blocks)</span><br><span class="line"></span><br><span class="line">3000-3499      3000-3499   3500 (ACK dropped)</span><br><span class="line">3500-3999      3500-3999   4000 (ACK dropped)</span><br><span class="line">4000-4499      (data packet dropped)</span><br><span class="line">4500-4999      4500-4999   4000, SACK&#x3D;4500-5000 (ACK dropped)</span><br><span class="line">3000-3499      3000-3499   4000, SACK&#x3D;3000-3500, 4500-5000</span><br></pre></td></tr></table></figure>
<h4 id="Example-3："><a href="#Example-3：" class="headerlink" title="Example 3："></a>Example 3：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Transmitted    Received    ACK Sent</span><br><span class="line">Segment        Segment     (Including SACK Blocks)</span><br><span class="line"></span><br><span class="line">3500-3999      3500-3999   4000</span><br><span class="line">4000-4499      (data packet dropped)</span><br><span class="line">4500-4999      4500-4999   4000, SACK&#x3D;4500-5000</span><br><span class="line">5000-5499      5000-5499   4000, SACK&#x3D;4500-5500</span><br><span class="line">               (duplicated packet)</span><br><span class="line">               5000-5499   4000, SACK&#x3D;5000-5500, 4500-5500</span><br></pre></td></tr></table></figure>
<h4 id="Example-4："><a href="#Example-4：" class="headerlink" title="Example 4："></a>Example 4：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Transmitted    Received    ACK Sent</span><br><span class="line">Segment        Segment     (Including SACK Blocks)</span><br><span class="line"></span><br><span class="line">500-999        500-999     1000</span><br><span class="line">1000-1499      (delayed)</span><br><span class="line">1500-1999      (data packet dropped)</span><br><span class="line">2000-2499      2000-2499   1000, SACK&#x3D;2000-2500</span><br><span class="line">1000-2000      1000-1499   1500, SACK&#x3D;2000-2500</span><br><span class="line">1000-2000   2500, SACK&#x3D;1000-1500</span><br></pre></td></tr></table></figure>
<h4 id="Example-5："><a href="#Example-5：" class="headerlink" title="Example 5："></a>Example 5：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Transmitted    Received    ACK Sent</span><br><span class="line">Segment        Segment     (Including SACK Blocks)</span><br><span class="line"></span><br><span class="line">500-999        500-999     1000</span><br><span class="line">1000-1499      (delayed)</span><br><span class="line">1500-1999      (data packet dropped)</span><br><span class="line">2000-2499      (delayed)</span><br><span class="line">2500-2999      (data packet dropped)</span><br><span class="line">3000-3499      3000-3499   1000, SACK&#x3D;3000-3500</span><br><span class="line">1000-2499      1000-1499   1500, SACK&#x3D;3000-3500</span><br><span class="line">2000-2499   1500, SACK&#x3D;2000-2500, 3000-3500</span><br><span class="line">1000-2499   2500, SACK&#x3D;1000-1500, 3000-3500</span><br></pre></td></tr></table></figure>
<h2 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h2><p>有了 TCP 的窗口控制，收发主机之间即使不再以一个数据段为单位发送确认应答，也能够连续发送大量数据包。然而，如果在通信刚开始时就发送大量数据，也可能会引发其他问题。</p>
<p>一般来说，计算机网络都处在一个共享的环境。因此也有可能会因为其他主机之间的通信使得网络拥堵。在网络出现拥堵时，如果突然发送一个较大量的数据，极有可能会导致整个网络的瘫痪。</p>
<p>拥塞控制主要是四个算法：</p>
<ul>
<li>慢启动</li>
<li>拥塞避免</li>
<li>拥塞发生</li>
<li>快速恢复</li>
</ul>
<h3 id="慢启动（Slow-Start）"><a href="#慢启动（Slow-Start）" class="headerlink" title="慢启动（Slow Start）"></a>慢启动（Slow Start）</h3><p>慢启动为发送方的TCP增加了另一个窗口：<strong>拥塞窗口（congestion window），记为cwnd。</strong>在慢启动的时候，拥塞窗口被初始化为1个报文段（1MSS）发送数据，每收到一次ACK，拥塞窗口的值就加1。在发送数据包时，数据大小=min(rwnd, cwnd)。<strong>拥塞窗口时发送方使用的流量控制，而滑动窗口则是接收方使用的流量控制。</strong></p>
<p>随着包的每次往返，拥塞窗口也会以1，2，4等指数函数的增长，当然cwnd不能一直这样无限增长下去，所以有一个慢启动阈值 ssthresh（slow start threshold），<strong>当cwnd超过该值之后，慢启动过程结束，进入拥塞避免阶段。</strong>ssthresh 的值是65536字节</p>
<h3 id="拥塞避免（Congestion-Avoidance）"><a href="#拥塞避免（Congestion-Avoidance）" class="headerlink" title="拥塞避免（Congestion Avoidance）"></a>拥塞避免（Congestion Avoidance）</h3><p>拥塞避免的主要思想是加法增大， 也就是cwnd的值不再指数级上升，开始加法增加。当收到一个ACK时，cwnd = cwnd + 1 / cwnd，当每过一个RTT时，cwnd = cwnd + 1，这样就可以避免增长过快导致网络拥塞。</p>
<h3 id="拥塞发生"><a href="#拥塞发生" class="headerlink" title="拥塞发生"></a>拥塞发生</h3><p>上面说的两种机制都是没有检测到拥塞的情况下的行为，那么当发生了拥塞cwnd会怎么调整呢？</p>
<p>首先来看TCP是如何判断网络进入了拥塞状态的，<strong>TCP认为如果重传了一个报文段就是网络拥塞</strong>，之前提到过RTO超时时间，当发送一个报文超时了还没收到ACK，TCP会进行重传，这时候TCP的反应会比较强烈：</p>
<ol>
<li>把 ssthresh 设置为 cwnd 值的一半</li>
<li>cwnd重新设置为1</li>
<li>重新进入慢启动过程</li>
</ol>
<p>TCP还有一种情况会进行重传，回顾一下快速重传，就是收到3个相同的ACK，这时后TCP做的事情：</p>
<ol>
<li>把 ssthresh 设置为 cwnd 值的一半</li>
<li>把 cwnd 设置为 ssthresh 的值</li>
<li>进入快速恢复阶段</li>
</ol>
<p>ps：快速恢复算法还没出来之前，第3步是重新进入拥塞避免阶段。</p>
<h3 id="快速恢复"><a href="#快速恢复" class="headerlink" title="快速恢复"></a>快速恢复</h3><ol>
<li>当收到3个重复ACK时，把 ssthresh  设置为 cwnd 的一般</li>
<li>把 cwnd 的值设置为 ssthresh  + 3</li>
<li>再收到重复的ACK时，cwnd加1</li>
<li>收到新的数据包的ACK时，cwnd = ssthresh  ，说明从重复ACK时的数据都已经收到，恢复过程结束， 再次进入拥塞避免状态。</li>
</ol>
<h2 id="“粘包”问题"><a href="#“粘包”问题" class="headerlink" title="“粘包”问题"></a>“粘包”问题</h2><p>有些人说是因为 <code>Nagle</code> 算法才会出现“粘包”问题是不太准确的，“粘包” 也不是 TCP 的问题</p>
<p>因为TCP是基于字节流而不是数据包的协议，TCP只会把你的数据转成字节流发送出去，保证顺序问题问题，至于怎么才算是一个完整的数据是<strong>应用层</strong>协议设计的。</p>
<p>既然 TCP 协议是基于字节流的，所以要怎么拆分和组合数据其实是应用层协议要自己设计的。</p>
<p>最常用的两个解决方案是基于消息长度和基于终结符</p>
<h3 id="基于消息长度"><a href="#基于消息长度" class="headerlink" title="基于消息长度"></a>基于消息长度</h3><p>基于长度的话就需要在应用层的协议头表示这个消息的长度是多少，HTTP 也有用到这种方式，用 <code>Content-Length</code> 来表示消息长度，这样接收端就能根据接收到的字节数来重组完整的 HTTP 数据包。</p>
<h3 id="基于终结符"><a href="#基于终结符" class="headerlink" title="基于终结符"></a>基于终结符</h3><p>在一个完整的消息后面加上 <code>CRLF</code> 或者自定义终结符，这样接收端在收到终结符的时候就知道终结符之前的数据是一个完整的数据包。</p>
<p>TCP 的协议先写到这里，TCP 协议是巨复杂的一个东西，这里只是冰山一角的一角，以后可能还会继续补充。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/18/MJRefresh%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/18/MJRefresh%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/" class="post-title-link" itemprop="url">MJRefresh源码浅析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-18 21:14:09" itemprop="dateCreated datePublished" datetime="2019-06-18T21:14:09+08:00">2019-06-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-15 09:59:35" itemprop="dateModified" datetime="2020-09-15T09:59:35+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://github.com/CoderMJLee/MJRefresh">MJRefresh</a> 是一个功能强大的 iOS 上拉下拉刷新组件。有很多大厂App（抖音、快手、京东、喜马拉雅等）都在使用，所以是一个很值得学习的库。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>先简单说明上拉下拉刷新的原理再去详细分析 <code>MJRefresh</code> 框架结构以及具体实现。</p>
<h3 id="header-footer的位置"><a href="#header-footer的位置" class="headerlink" title="header/footer的位置"></a>header/footer的位置</h3><p>首先 header/footer 是添加到 <code>UIScrollView</code> 上的，是它的子控件，比如 header 的高度是40，那么它的y值就是 <code>-40 </code> ，footer的y值就是 <code>contentSizeHeight</code>。</p>
<h3 id="下拉-上拉悬停"><a href="#下拉-上拉悬停" class="headerlink" title="下拉/上拉悬停"></a>下拉/上拉悬停</h3><p>上拉或者下拉到一定程度，松手后就会进入刷新状态，这时候 header/footer 都在显示在可见范围悬停，这是通过设置 UIScrollView 的 <code>contentInset.top</code> 和 <code>contentInset.bottom</code> 来实现，刷新结束后，再重置回来。</p>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>上面介绍了一些上拉下拉的原理，其实很简单， 接下去具体看一下 <code>MJRefresh</code> 是如何做的。</p>
<h3 id="结构设计"><a href="#结构设计" class="headerlink" title="结构设计"></a>结构设计</h3><p><img src="/images/mjrefresh_1.png"></p>
<p><code>MJRefreshComponent</code> 是header和footer 的基类，实际都是使用最后一层的类。接下来具体看每个类的具体职责和实现。</p>
<h3 id="MJRefreshComponent"><a href="#MJRefreshComponent" class="headerlink" title="MJRefreshComponent"></a>MJRefreshComponent</h3><p>这个类作为基类，主要的职责就是：</p>
<h4 id="1-声明刷新控件的状态，刷新的回调，交给子类去实现的函数"><a href="#1-声明刷新控件的状态，刷新的回调，交给子类去实现的函数" class="headerlink" title="1. 声明刷新控件的状态，刷新的回调，交给子类去实现的函数"></a>1. 声明刷新控件的状态，刷新的回调，交给子类去实现的函数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** 刷新控件的状态 *&#x2F;</span><br><span class="line">typedef NS_ENUM(NSInteger, MJRefreshState) &#123;</span><br><span class="line">    &#x2F;** 普通闲置状态 *&#x2F;</span><br><span class="line">    MJRefreshStateIdle &#x3D; 1,</span><br><span class="line">    &#x2F;** 松开就可以进行刷新的状态 *&#x2F;</span><br><span class="line">    MJRefreshStatePulling,</span><br><span class="line">    &#x2F;** 正在刷新中的状态 *&#x2F;</span><br><span class="line">    MJRefreshStateRefreshing,</span><br><span class="line">    &#x2F;** 即将刷新的状态 *&#x2F;</span><br><span class="line">    MJRefreshStateWillRefresh,</span><br><span class="line">    &#x2F;** 所有数据加载完毕，没有更多的数据了 *&#x2F;</span><br><span class="line">    MJRefreshStateNoMoreData</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;** 刷新用到的回调类型 *&#x2F;</span><br><span class="line">typedef void (^MJRefreshComponentAction)(void);</span><br><span class="line"></span><br><span class="line">#pragma mark - 交给子类们去实现</span><br><span class="line">&#x2F;** 初始化 *&#x2F;</span><br><span class="line">- (void)prepare NS_REQUIRES_SUPER;</span><br><span class="line">&#x2F;** 摆放子控件frame *&#x2F;</span><br><span class="line">- (void)placeSubviews NS_REQUIRES_SUPER;</span><br><span class="line">&#x2F;** 当scrollView的contentOffset发生改变的时候调用 *&#x2F;</span><br><span class="line">- (void)scrollViewContentOffsetDidChange:(nullable NSDictionary *)change NS_REQUIRES_SUPER;</span><br><span class="line">&#x2F;** 当scrollView的contentSize发生改变的时候调用 *&#x2F;</span><br><span class="line">- (void)scrollViewContentSizeDidChange:(nullable NSDictionary *)change NS_REQUIRES_SUPER;</span><br><span class="line">&#x2F;** 当scrollView的拖拽状态发生改变的时候调用 *&#x2F;</span><br><span class="line">- (void)scrollViewPanStateDidChange:(nullable NSDictionary *)change NS_REQUIRES_SUPER;</span><br></pre></td></tr></table></figure>
<h4 id="2-获取-UIScrollView，记录最开始的-contentInset"><a href="#2-获取-UIScrollView，记录最开始的-contentInset" class="headerlink" title="2. 获取 UIScrollView，记录最开始的 contentInset"></a>2. 获取 UIScrollView，记录最开始的 contentInset</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)willMoveToSuperview:(<span class="built_in">UIView</span> *)newSuperview</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> willMoveToSuperview:newSuperview];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果不是UIScrollView，不做任何事情</span></span><br><span class="line">    <span class="keyword">if</span> (newSuperview &amp;&amp; ![newSuperview isKindOfClass:[<span class="built_in">UIScrollView</span> <span class="keyword">class</span>]]) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 旧的父控件移除监听</span></span><br><span class="line">    [<span class="keyword">self</span> removeObservers];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (newSuperview) &#123; <span class="comment">// 新的父控件</span></span><br><span class="line">        <span class="comment">// 记录UIScrollView</span></span><br><span class="line">        _scrollView = (<span class="built_in">UIScrollView</span> *)newSuperview;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置宽度</span></span><br><span class="line">        <span class="keyword">self</span>.mj_w = _scrollView.mj_w;</span><br><span class="line">        <span class="comment">// 设置位置</span></span><br><span class="line">        <span class="keyword">self</span>.mj_x = -_scrollView.mj_insetL;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 设置永远支持垂直弹簧效果</span></span><br><span class="line">        _scrollView.alwaysBounceVertical = <span class="literal">YES</span>;</span><br><span class="line">        <span class="comment">// 记录UIScrollView最开始的contentInset</span></span><br><span class="line">        _scrollViewOriginalInset = _scrollView.mj_inset;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加监听</span></span><br><span class="line">        [<span class="keyword">self</span> addObservers];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>记录 <code>ContentInset</code> 在 iOS11之后是获取 <code>adjustedContentInset</code> 属性。顺便看下设置 <code>contentInset</code> 的实现</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setMj_insetT:(<span class="built_in">CGFloat</span>)mj_insetT</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIEdgeInsets</span> inset = <span class="keyword">self</span>.contentInset;</span><br><span class="line">    inset.top = mj_insetT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __IPHONE_11_0</span></span><br><span class="line">    <span class="keyword">if</span> (respondsToAdjustedContentInset_) &#123;</span><br><span class="line">        inset.top -= (<span class="keyword">self</span>.adjustedContentInset.top - <span class="keyword">self</span>.contentInset.top);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">self</span>.contentInset = inset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-添加监听"><a href="#3-添加监听" class="headerlink" title="3. 添加监听"></a>3. 添加监听</h4><p>监听 contentOffset、contentSize、panGestureRecognizer的state。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addObservers</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSKeyValueObservingOptions</span> options = <span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span>;</span><br><span class="line">    [<span class="keyword">self</span>.scrollView addObserver:<span class="keyword">self</span> forKeyPath:MJRefreshKeyPathContentOffset options:options context:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="keyword">self</span>.scrollView addObserver:<span class="keyword">self</span> forKeyPath:MJRefreshKeyPathContentSize options:options context:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">self</span>.pan = <span class="keyword">self</span>.scrollView.panGestureRecognizer;</span><br><span class="line">    [<span class="keyword">self</span>.pan addObserver:<span class="keyword">self</span> forKeyPath:MJRefreshKeyPathPanState options:options context:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>监听实现，<strong>具体处理交给子类</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 遇到这些情况就直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.userInteractionEnabled) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这个就算看不见也需要处理</span></span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:MJRefreshKeyPathContentSize]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> scrollViewContentSizeDidChange:change];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 看不见</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.hidden) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:MJRefreshKeyPathContentOffset]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> scrollViewContentOffsetDidChange:change];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:MJRefreshKeyPathPanState]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> scrollViewPanStateDidChange:change];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)scrollViewContentOffsetDidChange:(<span class="built_in">NSDictionary</span> *)change&#123;&#125;</span><br><span class="line">- (<span class="keyword">void</span>)scrollViewContentSizeDidChange:(<span class="built_in">NSDictionary</span> *)change&#123;&#125;</span><br><span class="line">- (<span class="keyword">void</span>)scrollViewPanStateDidChange:(<span class="built_in">NSDictionary</span> *)change&#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-开始刷新和结束刷新"><a href="#4-开始刷新和结束刷新" class="headerlink" title="4. 开始刷新和结束刷新"></a>4. 开始刷新和结束刷新</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)beginRefreshing</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:MJRefreshFastAnimationDuration animations:^&#123;</span><br><span class="line">        <span class="keyword">self</span>.alpha = <span class="number">1.0</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">      <span class="comment">// 初始化 拖拽的百分比</span></span><br><span class="line">    <span class="keyword">self</span>.pullingPercent = <span class="number">1.0</span>;</span><br><span class="line">    <span class="comment">// 只要正在刷新，就完全显示</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.window) &#123;</span><br><span class="line">        <span class="keyword">self</span>.state = MJRefreshStateRefreshing;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 预防正在刷新中时，调用本方法使得header inset回置失败</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.state != MJRefreshStateRefreshing) &#123;</span><br><span class="line">            <span class="keyword">self</span>.state = MJRefreshStateWillRefresh;</span><br><span class="line">            <span class="comment">// 刷新(预防从另一个控制器回到这个控制器的情况，回来要重新刷新一下)</span></span><br><span class="line">            [<span class="keyword">self</span> setNeedsDisplay];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)endRefreshing</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshDispatchAsyncOnMainQueue(<span class="keyword">self</span>.state = MJRefreshStateIdle;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark 是否正在刷新</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isRefreshing</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.state == MJRefreshStateRefreshing || <span class="keyword">self</span>.state == MJRefreshStateWillRefresh;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MJRefreshHeader"><a href="#MJRefreshHeader" class="headerlink" title="MJRefreshHeader"></a>MJRefreshHeader</h3><p>MJRefreshHeader 是所有 header 的父类，它的职责是：</p>
<h4 id="1-初始化设置"><a href="#1-初始化设置" class="headerlink" title="1.  初始化设置"></a>1.  初始化设置</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)prepare</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> prepare];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置key</span></span><br><span class="line">    <span class="keyword">self</span>.lastUpdatedTimeKey = MJRefreshHeaderLastUpdatedTimeKey;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置高度</span></span><br><span class="line">    <span class="keyword">self</span>.mj_h = MJRefreshHeaderHeight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-设置y值"><a href="#2-设置y值" class="headerlink" title="2. 设置y值"></a>2. 设置y值</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)placeSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> placeSubviews];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置y值(当自己的高度发生改变了，肯定要重新调整Y值，所以放到placeSubviews方法中设置y值)</span></span><br><span class="line">    <span class="keyword">self</span>.mj_y = - <span class="keyword">self</span>.mj_h - <span class="keyword">self</span>.ignoredScrollViewContentInsetTop;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>ignoredScrollViewContentInsetTop</code> 一般很少用到</p>
<h4 id="3-监听到-contentOffset-改变的具体实现"><a href="#3-监听到-contentOffset-改变的具体实现" class="headerlink" title="3. 监听到 contentOffset 改变的具体实现"></a>3. 监听到 contentOffset 改变的具体实现</h4><p>主要是根据偏移量来决定松手时候可刷新，还有就是<strong>悬停操作</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)scrollViewContentOffsetDidChange:(<span class="built_in">NSDictionary</span> *)change</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> scrollViewContentOffsetDidChange:change];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在刷新的refreshing状态</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">        [<span class="keyword">self</span> resetInset];</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 跳转到下一个控制器时，contentInset可能会变</span></span><br><span class="line">    _scrollViewOriginalInset = <span class="keyword">self</span>.scrollView.mj_inset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 当前的contentOffset</span></span><br><span class="line">    <span class="built_in">CGFloat</span> offsetY = <span class="keyword">self</span>.scrollView.mj_offsetY;</span><br><span class="line">    <span class="comment">// 头部控件刚好出现的offsetY</span></span><br><span class="line">    <span class="built_in">CGFloat</span> happenOffsetY = - <span class="keyword">self</span>.scrollViewOriginalInset.top;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果是向上滚动到看不见头部控件，直接返回</span></span><br><span class="line">    <span class="comment">// &gt;= -&gt; &gt;</span></span><br><span class="line">    <span class="keyword">if</span> (offsetY &gt; happenOffsetY) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 普通 和 即将刷新 的临界点</span></span><br><span class="line">    <span class="built_in">CGFloat</span> normal2pullingOffsetY = happenOffsetY - <span class="keyword">self</span>.mj_h;</span><br><span class="line">    <span class="built_in">CGFloat</span> pullingPercent = (happenOffsetY - offsetY) / <span class="keyword">self</span>.mj_h;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.scrollView.isDragging) &#123; <span class="comment">// 如果正在拖拽</span></span><br><span class="line">        <span class="keyword">self</span>.pullingPercent = pullingPercent;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStateIdle &amp;&amp; offsetY &lt; normal2pullingOffsetY) &#123;</span><br><span class="line">            <span class="comment">// 转为即将刷新状态</span></span><br><span class="line">            <span class="keyword">self</span>.state = MJRefreshStatePulling;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStatePulling &amp;&amp; offsetY &gt;= normal2pullingOffsetY) &#123;</span><br><span class="line">            <span class="comment">// 转为普通状态</span></span><br><span class="line">            <span class="keyword">self</span>.state = MJRefreshStateIdle;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStatePulling) &#123;<span class="comment">// 即将刷新 &amp;&amp; 手松开</span></span><br><span class="line">        <span class="comment">// 开始刷新</span></span><br><span class="line">        [<span class="keyword">self</span> beginRefreshing];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pullingPercent &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.pullingPercent = pullingPercent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个方法最主要是记录临界点 <code>CGFloat normal2pullingOffsetY = happenOffsetY - self.mj_h;</code> ，用 <code>isDragging</code> 属性来判断用户是否已经松手，如果没松手，就根据 <code>contentOffset</code> 来设置状态（提示松手可刷新或者取消），如果收松开并且状态是 <code>MJRefreshStatePulling</code> 就调用 <code>beginRefreshing</code> 开始刷新。header 并没有重写 <code>beginRefreshing</code> ，所以是调用基类的。</p>
<p>还有一个主要功能是<strong>悬停操作</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在刷新的refreshing状态</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">  [<span class="keyword">self</span> resetInset];</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)resetInset &#123;</span><br><span class="line">    <span class="keyword">if</span> (@available(iOS <span class="number">11.0</span>, *)) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果 iOS 10 及以下系统在刷新时, push 新的 VC, 等待刷新完成后回来, 会导致顶部 Insets.top 异常, 不能 resetInset, 检查一下这种特殊情况</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.window) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// sectionheader停留解决</span></span><br><span class="line">    <span class="built_in">CGFloat</span> insetT = - <span class="keyword">self</span>.scrollView.mj_offsetY &gt; _scrollViewOriginalInset.top ? - <span class="keyword">self</span>.scrollView.mj_offsetY : _scrollViewOriginalInset.top;</span><br><span class="line">    insetT = insetT &gt; <span class="keyword">self</span>.mj_h + _scrollViewOriginalInset.top ? <span class="keyword">self</span>.mj_h + _scrollViewOriginalInset.top : insetT;</span><br><span class="line">    <span class="keyword">self</span>.insetTDelta = _scrollViewOriginalInset.top - insetT;</span><br><span class="line">    <span class="comment">// 避免 CollectionView 在使用根据 Autolayout 和 内容自动伸缩 Cell, 刷新时导致的 Layout 异常渲染问题</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.scrollView.mj_insetT != insetT) &#123;</span><br><span class="line">        <span class="keyword">self</span>.scrollView.mj_insetT = insetT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和之前讲的一样，悬停的原理就是设置 <code>contentInset.top</code> 。</p>
<p><code>self.insetTDelta</code> 这个属性可以理解为 header 的高度取反。</p>
<h4 id="4-状态切换"><a href="#4-状态切换" class="headerlink" title="4. 状态切换"></a>4. 状态切换</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setState:(MJRefreshState)state</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshCheckState</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据状态做事情</span></span><br><span class="line">    <span class="keyword">if</span> (state == MJRefreshStateIdle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldState != MJRefreshStateRefreshing) <span class="keyword">return</span>;</span><br><span class="line">        [<span class="keyword">self</span> headerEndingAction];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">        [<span class="keyword">self</span> headerRefreshingAction];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p> <code>headerEndingAction</code> 和 <code>headerRefreshingAction</code> 是对 <code>contentOffset</code> 做动画</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)headerRefreshingAction &#123;</span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:MJRefreshFastAnimationDuration animations:^&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.scrollView.panGestureRecognizer.state != <span class="built_in">UIGestureRecognizerStateCancelled</span>) &#123;</span><br><span class="line">            <span class="built_in">CGFloat</span> top = <span class="keyword">self</span>.scrollViewOriginalInset.top + <span class="keyword">self</span>.mj_h;</span><br><span class="line">            <span class="comment">// 增加滚动区域top</span></span><br><span class="line">            <span class="keyword">self</span>.scrollView.mj_insetT = top;</span><br><span class="line">            <span class="comment">// 设置滚动位置</span></span><br><span class="line">            <span class="built_in">CGPoint</span> offset = <span class="keyword">self</span>.scrollView.contentOffset;</span><br><span class="line">            offset.y = -top;</span><br><span class="line">            [<span class="keyword">self</span>.scrollView setContentOffset:offset animated:<span class="literal">NO</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">        [<span class="keyword">self</span> executeRefreshingCallback];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MJRefreshStateHeader"><a href="#MJRefreshStateHeader" class="headerlink" title="MJRefreshStateHeader"></a>MJRefreshStateHeader</h3><p><code>MJRefreshHeader</code> 作为公共header，已经把原理篇的事情都做完了，设置y值、状态切换、悬停处理。</p>
<p>那么看看 <code>MJRefreshStateHeader</code> 的主要职责：</p>
<h4 id="1-初始化操作"><a href="#1-初始化操作" class="headerlink" title="1. 初始化操作"></a>1. 初始化操作</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)prepare</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> prepare];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化间距</span></span><br><span class="line">    <span class="keyword">self</span>.labelLeftInset = MJRefreshLabelLeftInset;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化文字</span></span><br><span class="line">    [<span class="keyword">self</span> setTitle:[<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderIdleText] forState:MJRefreshStateIdle];</span><br><span class="line">  </span><br><span class="line">    [<span class="keyword">self</span> setTitle:[<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderPullingText] forState:MJRefreshStatePulling];</span><br><span class="line">  </span><br><span class="line">    [<span class="keyword">self</span> setTitle:[<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderRefreshingText] forState:MJRefreshStateRefreshing];</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化文字的原理就是用字典来存储每个状态对应的 <code>title</code>。</p>
<h4 id="2-对-Label-进行布局"><a href="#2-对-Label-进行布局" class="headerlink" title="2. 对 Label 进行布局"></a>2. 对 Label 进行布局</h4><p>MJRefreshStateHeader 是负责状态Label和更新时间Label</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)placeSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> placeSubviews];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.stateLabel.hidden) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> noConstrainsOnStatusLabel = <span class="keyword">self</span>.stateLabel.constraints.count == <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) &#123;</span><br><span class="line">        <span class="comment">// 状态</span></span><br><span class="line">        <span class="keyword">if</span> (noConstrainsOnStatusLabel) <span class="keyword">self</span>.stateLabel.frame = <span class="keyword">self</span>.bounds;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">CGFloat</span> stateLabelH = <span class="keyword">self</span>.mj_h * <span class="number">0.5</span>;</span><br><span class="line">        <span class="comment">// 状态</span></span><br><span class="line">        <span class="keyword">if</span> (noConstrainsOnStatusLabel) &#123;</span><br><span class="line">            <span class="keyword">self</span>.stateLabel.mj_x = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">self</span>.stateLabel.mj_y = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">self</span>.stateLabel.mj_w = <span class="keyword">self</span>.mj_w;</span><br><span class="line">            <span class="keyword">self</span>.stateLabel.mj_h = stateLabelH;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新时间</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.lastUpdatedTimeLabel.constraints.count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_x = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_y = stateLabelH;</span><br><span class="line">            <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_w = <span class="keyword">self</span>.mj_w;</span><br><span class="line">            <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_h = <span class="keyword">self</span>.mj_h - <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-切换状态"><a href="#3-切换状态" class="headerlink" title="3. 切换状态"></a>3. 切换状态</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setState:(MJRefreshState)state</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshCheckState</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置状态文字</span></span><br><span class="line">    <span class="keyword">self</span>.stateLabel.text = <span class="keyword">self</span>.stateTitles[@(state)];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重新设置key（重新显示时间）</span></span><br><span class="line">    <span class="keyword">self</span>.lastUpdatedTimeKey = <span class="keyword">self</span>.lastUpdatedTimeKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-设置上次刷新日期-Text"><a href="#4-设置上次刷新日期-Text" class="headerlink" title="4. 设置上次刷新日期 Text"></a>4. 设置上次刷新日期 Text</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setLastUpdatedTimeKey:(<span class="built_in">NSString</span> *)lastUpdatedTimeKey</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> setLastUpdatedTimeKey:lastUpdatedTimeKey];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果label隐藏了，就不用再处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSDate</span> *lastUpdatedTime = [[<span class="built_in">NSUserDefaults</span> standardUserDefaults] objectForKey:lastUpdatedTimeKey];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果有block</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.lastUpdatedTimeText) &#123;</span><br><span class="line">        <span class="keyword">self</span>.lastUpdatedTimeLabel.text = <span class="keyword">self</span>.lastUpdatedTimeText(lastUpdatedTime);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (lastUpdatedTime) &#123;</span><br><span class="line">        <span class="comment">// 1.获得年月日</span></span><br><span class="line">        <span class="built_in">NSCalendar</span> *calendar = [<span class="built_in">NSCalendar</span> calendarWithIdentifier:<span class="built_in">NSCalendarIdentifierGregorian</span>];</span><br><span class="line">        <span class="built_in">NSUInteger</span> unitFlags = <span class="built_in">NSCalendarUnitYear</span>| <span class="built_in">NSCalendarUnitMonth</span> | <span class="built_in">NSCalendarUnitDay</span> | <span class="built_in">NSCalendarUnitHour</span> | <span class="built_in">NSCalendarUnitMinute</span>;</span><br><span class="line">        <span class="built_in">NSDateComponents</span> *cmp1 = [calendar components:unitFlags fromDate:lastUpdatedTime];</span><br><span class="line">        <span class="built_in">NSDateComponents</span> *cmp2 = [calendar components:unitFlags fromDate:[<span class="built_in">NSDate</span> date]];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2.格式化日期</span></span><br><span class="line">        <span class="built_in">NSDateFormatter</span> *formatter = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">        <span class="built_in">BOOL</span> isToday = <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">if</span> ([cmp1 day] == [cmp2 day]) &#123; <span class="comment">// 今天</span></span><br><span class="line">            formatter.dateFormat = <span class="string">@&quot; HH:mm&quot;</span>;</span><br><span class="line">            isToday = <span class="literal">YES</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([cmp1 year] == [cmp2 year]) &#123; <span class="comment">// 今年</span></span><br><span class="line">            formatter.dateFormat = <span class="string">@&quot;MM-dd HH:mm&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            formatter.dateFormat = <span class="string">@&quot;yyyy-MM-dd HH:mm&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSString</span> *time = [formatter stringFromDate:lastUpdatedTime];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3.显示日期</span></span><br><span class="line">        <span class="keyword">self</span>.lastUpdatedTimeLabel.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@%@%@&quot;</span>,</span><br><span class="line">                                          [<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderLastTimeText],</span><br><span class="line">                                          isToday ? [<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderDateTodayText] : <span class="string">@&quot;&quot;</span>,</span><br><span class="line">                                          time];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.lastUpdatedTimeLabel.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@%@&quot;</span>,</span><br><span class="line">                                          [<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderLastTimeText],</span><br><span class="line">                                          [<span class="built_in">NSBundle</span> mj_localizedStringForKey:MJRefreshHeaderNoneLastDateText]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有一个 <code> lastUpdatedTimeText</code> block 可以自定义内容。这个设置会在切换 <code>state</code> 的时候调用。</p>
<h3 id="MJRefreshNormalHeader"><a href="#MJRefreshNormalHeader" class="headerlink" title="MJRefreshNormalHeader"></a>MJRefreshNormalHeader</h3><h4 id="1-初始化"><a href="#1-初始化" class="headerlink" title="1. 初始化"></a>1. 初始化</h4><p>刷新样式的初始化</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)prepare</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> prepare];</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 130000</span></span><br><span class="line">    <span class="keyword">if</span> (@available(iOS <span class="number">13.0</span>, *)) &#123;</span><br><span class="line">        _activityIndicatorViewStyle = <span class="built_in">UIActivityIndicatorViewStyleMedium</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    _activityIndicatorViewStyle = <span class="built_in">UIActivityIndicatorViewStyleGray</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-对控件进行布局"><a href="#2-对控件进行布局" class="headerlink" title="2. 对控件进行布局"></a>2. 对控件进行布局</h4><p>MJRefreshNormalHeader 主要是负责 箭头和刷新小菊花的控件。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)placeSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> placeSubviews];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 箭头的中心点</span></span><br><span class="line">    <span class="built_in">CGFloat</span> arrowCenterX = <span class="keyword">self</span>.mj_w * <span class="number">0.5</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.stateLabel.hidden) &#123;</span><br><span class="line">        <span class="built_in">CGFloat</span> stateWidth = <span class="keyword">self</span>.stateLabel.mj_textWidth;</span><br><span class="line">        <span class="built_in">CGFloat</span> timeWidth = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) &#123;</span><br><span class="line">            timeWidth = <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_textWidth;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">CGFloat</span> textWidth = MAX(stateWidth, timeWidth);</span><br><span class="line">        arrowCenterX -= textWidth / <span class="number">2</span> + <span class="keyword">self</span>.labelLeftInset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CGFloat</span> arrowCenterY = <span class="keyword">self</span>.mj_h * <span class="number">0.5</span>;</span><br><span class="line">    <span class="built_in">CGPoint</span> arrowCenter = <span class="built_in">CGPointMake</span>(arrowCenterX, arrowCenterY);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 箭头</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.arrowView.constraints.count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.arrowView.mj_size = <span class="keyword">self</span>.arrowView.image.size;</span><br><span class="line">        <span class="keyword">self</span>.arrowView.center = arrowCenter;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 圈圈</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.loadingView.constraints.count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.loadingView.center = arrowCenter;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.arrowView.tintColor = <span class="keyword">self</span>.stateLabel.textColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-状态切换处理"><a href="#3-状态切换处理" class="headerlink" title="3. 状态切换处理"></a>3. 状态切换处理</h4><p>根据状态对 <code>arrowView</code> 和 <code>loadView</code> 进行动画和显示隐藏</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setState:(MJRefreshState)state</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshCheckState</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据状态做事情</span></span><br><span class="line">    <span class="keyword">if</span> (state == MJRefreshStateIdle) &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldState == MJRefreshStateRefreshing) &#123;</span><br><span class="line">            <span class="keyword">self</span>.arrowView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line">            </span><br><span class="line">            [<span class="built_in">UIView</span> animateWithDuration:MJRefreshSlowAnimationDuration animations:^&#123;</span><br><span class="line">                <span class="keyword">self</span>.loadingView.alpha = <span class="number">0.0</span>;</span><br><span class="line">            &#125; completion:^(<span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">                <span class="comment">// 如果执行完动画发现不是idle状态，就直接返回，进入其他状态</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.state != MJRefreshStateIdle) <span class="keyword">return</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">self</span>.loadingView.alpha = <span class="number">1.0</span>;</span><br><span class="line">                [<span class="keyword">self</span>.loadingView stopAnimating];</span><br><span class="line">                <span class="keyword">self</span>.arrowView.hidden = <span class="literal">NO</span>;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.loadingView stopAnimating];</span><br><span class="line">            <span class="keyword">self</span>.arrowView.hidden = <span class="literal">NO</span>;</span><br><span class="line">            [<span class="built_in">UIView</span> animateWithDuration:MJRefreshFastAnimationDuration animations:^&#123;</span><br><span class="line">                <span class="keyword">self</span>.arrowView.transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == MJRefreshStatePulling) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.loadingView stopAnimating];</span><br><span class="line">        <span class="keyword">self</span>.arrowView.hidden = <span class="literal">NO</span>;</span><br><span class="line">        [<span class="built_in">UIView</span> animateWithDuration:MJRefreshFastAnimationDuration animations:^&#123;</span><br><span class="line">            <span class="keyword">self</span>.arrowView.transform = <span class="built_in">CGAffineTransformMakeRotation</span>(<span class="number">0.000001</span> - M_PI);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">        <span class="keyword">self</span>.loadingView.alpha = <span class="number">1.0</span>; <span class="comment">// 防止refreshing -&gt; idle的动画完毕动作没有被执行</span></span><br><span class="line">        [<span class="keyword">self</span>.loadingView startAnimating];</span><br><span class="line">        <span class="keyword">self</span>.arrowView.hidden = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MJRefreshGifHeader"><a href="#MJRefreshGifHeader" class="headerlink" title="MJRefreshGifHeader"></a>MJRefreshGifHeader</h3><p>MJRefreshGifHeader 和 MJRefreshNormalHeader 的作用一样，都是进行刷新控件的布局和操作的，只不过 normal 是常用的箭头和菊花。gif就是用gif图片</p>
<h4 id="1-设置图片数组"><a href="#1-设置图片数组" class="headerlink" title="1. 设置图片数组"></a>1. 设置图片数组</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setImages:(<span class="built_in">NSArray</span> *)images duration:(<span class="built_in">NSTimeInterval</span>)duration forState:(MJRefreshState)state </span><br><span class="line">&#123; </span><br><span class="line">    <span class="keyword">if</span> (images == <span class="literal">nil</span>) <span class="keyword">return</span>; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.stateImages[@(state)] = images; </span><br><span class="line">    <span class="keyword">self</span>.stateDurations[@(state)] = @(duration); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 根据图片设置控件的高度 */</span> </span><br><span class="line">    <span class="built_in">UIImage</span> *image = [images firstObject]; </span><br><span class="line">    <span class="keyword">if</span> (image.size.height &gt; <span class="keyword">self</span>.mj_h) &#123; </span><br><span class="line">        <span class="keyword">self</span>.mj_h = image.size.height; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setImages:(<span class="built_in">NSArray</span> *)images forState:(MJRefreshState)state </span><br><span class="line">&#123; </span><br><span class="line">    [<span class="keyword">self</span> setImages:images duration:images.count * <span class="number">0.1</span> forState:state]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-对-gifView-进行布局"><a href="#2-对-gifView-进行布局" class="headerlink" title="2. 对 gifView 进行布局"></a>2. 对 gifView 进行布局</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)placeSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> placeSubviews];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.gifView.constraints.count) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.gifView.frame = <span class="keyword">self</span>.bounds;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.stateLabel.hidden &amp;&amp; <span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) &#123;</span><br><span class="line">        <span class="keyword">self</span>.gifView.contentMode = <span class="built_in">UIViewContentModeCenter</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.gifView.contentMode = <span class="built_in">UIViewContentModeRight</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGFloat</span> stateWidth = <span class="keyword">self</span>.stateLabel.mj_textWidth;</span><br><span class="line">        <span class="built_in">CGFloat</span> timeWidth = <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.lastUpdatedTimeLabel.hidden) &#123;</span><br><span class="line">            timeWidth = <span class="keyword">self</span>.lastUpdatedTimeLabel.mj_textWidth;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">CGFloat</span> textWidth = MAX(stateWidth, timeWidth);</span><br><span class="line">        <span class="keyword">self</span>.gifView.mj_w = <span class="keyword">self</span>.mj_w * <span class="number">0.5</span> - textWidth * <span class="number">0.5</span> - <span class="keyword">self</span>.labelLeftInset;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-状态切换"><a href="#3-状态切换" class="headerlink" title="3. 状态切换"></a>3. 状态切换</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setState:(MJRefreshState)state</span><br><span class="line">&#123;</span><br><span class="line">    MJRefreshCheckState</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据状态做事情</span></span><br><span class="line">    <span class="keyword">if</span> (state == MJRefreshStatePulling || state == MJRefreshStateRefreshing) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *images = <span class="keyword">self</span>.stateImages[@(state)];</span><br><span class="line">        <span class="keyword">if</span> (images.count == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        [<span class="keyword">self</span>.gifView stopAnimating];</span><br><span class="line">        <span class="keyword">if</span> (images.count == <span class="number">1</span>) &#123; <span class="comment">// 单张图片</span></span><br><span class="line">            <span class="keyword">self</span>.gifView.image = [images lastObject];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 多张图片</span></span><br><span class="line">            <span class="keyword">self</span>.gifView.animationImages = images;</span><br><span class="line">            <span class="keyword">self</span>.gifView.animationDuration = [<span class="keyword">self</span>.stateDurations[@(state)] doubleValue];</span><br><span class="line">            [<span class="keyword">self</span>.gifView startAnimating];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == MJRefreshStateIdle) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.gifView stopAnimating];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-根据拖拽的百分比来设置显示图片"><a href="#4-根据拖拽的百分比来设置显示图片" class="headerlink" title="4. 根据拖拽的百分比来设置显示图片"></a>4. 根据拖拽的百分比来设置显示图片</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setPullingPercent:(<span class="built_in">CGFloat</span>)pullingPercent</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> setPullingPercent:pullingPercent];</span><br><span class="line">    <span class="built_in">NSArray</span> *images = <span class="keyword">self</span>.stateImages[@(MJRefreshStateIdle)];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.state != MJRefreshStateIdle || images.count == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 停止动画</span></span><br><span class="line">    [<span class="keyword">self</span>.gifView stopAnimating];</span><br><span class="line">    <span class="comment">// 设置当前需要显示的图片</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> index =  images.count * pullingPercent;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= images.count) index = images.count - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">self</span>.gifView.image = images[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Header 的部分已经结束，最核心的就是 <code>MJRefreshComponent </code> 和 <code>MJRefreshHeader</code>，这两个类把上拉刷新的核心功能都做完了，剩下的类就是根据状态显示对应的UI。</p>
<p>所以如果要自定义下拉刷新的UI可以直接继承 <code>MJRefreshHeader</code>。</p>
<ol>
<li><p>在 <code>prepare</code> 方法进行初始化</p>
</li>
<li><p>在 <code>placeSubviews</code> 方法进行布局</p>
</li>
<li><p>处理状态切换</p>
<p>Footer 和 Header 的实现原理基本类似，就不多介绍了。总体来说上拉下拉刷新的原理还是比较简单的。通过看源码可以学到怎么分层，让每一个子类完成各自的事情，从而提高框架的可定制性。还有就是 <code>UIScrollView</code> 是比较复杂的控件，虽然原理简单但是实际上做出来的时候就是会出现不可思议的 bug， 可以学习如何追踪 bug 和解决 bug 的思路，<code>MJRefresh</code> 对 bug 的处理我没贴上去。感兴趣的可以自行学习。</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/03/12/Django-REST-framework%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A5%87%E5%B7%A7%E6%B7%AB%E6%8A%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/03/12/Django-REST-framework%E7%9A%84%E4%B8%80%E4%BA%9B%E5%A5%87%E5%B7%A7%E6%B7%AB%E6%8A%80/" class="post-title-link" itemprop="url">Django REST framework的一些奇巧淫技</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-03-12 16:22:52" itemprop="dateCreated datePublished" datetime="2018-03-12T16:22:52+08:00">2018-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-15 09:42:31" itemprop="dateModified" datetime="2020-09-15T09:42:31+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>开始之前,假设你已经有Django和Django REST framework的一些基础了</p>
<h4 id="mixins-ViewSet和routers配合使用"><a href="#mixins-ViewSet和routers配合使用" class="headerlink" title="mixins,ViewSet和routers配合使用"></a>mixins,ViewSet和routers配合使用</h4><p><code>minxis</code>的类有5种</p>
<ul>
<li>CreateModelMixin</li>
<li>ListModelMixin</li>
<li>RetrieveModelMixin</li>
<li>UpdateModelMixin</li>
<li>DestroyModelMixin</li>
</ul>
<p>他们分别对应了对数据库的增查改删操作,使用它们的好处是不用重复写着相同的业务代码逻辑,因为每个<code>mixins</code>内部都写好了对应的逻辑,只需要设置一下<code>queryset</code>和<code>serializer_class</code>就可以了.</p>
<p><code>ViewSet</code>也有5种,分别是</p>
<ul>
<li>ViewSetMixin</li>
<li>ViewSet</li>
<li>GenericViewSet</li>
<li>ReadOnlyModelViewSet</li>
<li>ModelViewSet</li>
</ul>
<p>一般来说我们只需要用<code>GenericViewSet</code>就可以了.它继承了<code>ViewSetMixin</code>和<code>generics.GenericAPIView</code>,后者的功能大家都知道,有了它才能设置<code>queryset</code>和<code>serializer_class</code>属性.重点是<code>ViewSetMixin</code>.</p>
<p><img src="/images/django_1.png" alt="image"><br>它重写了方法<code>as_view</code>,这个能让我们注册url变得更加简单,还有一个方法是<code>initialize_request</code>,这个方法主要是给<code>action</code>属性赋值,这个属性在设置动态<code>serializer</code>和<code>permission</code>的时候有很大的用处!之后会写到</p>
<p>所以写一个<code>APIView</code>就变得很简单,如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXXViewSet</span>(<span class="params">mixins.ListModelMixin, mixins.CreateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line"></span><br><span class="line">    queryset = Model.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ModelSerializer</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来就是配置url了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> appname.views <span class="keyword">import</span> XXXViewSet</span><br><span class="line"></span><br><span class="line">models = XXXViewSet.asview(&#123;</span><br><span class="line">    <span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;post&#x27;</span>: <span class="string">&#x27;create&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">urlpattrtns = [</span><br><span class="line">    url(<span class="string">r&#x27;apiAddress/$&#x27;</span>,models, name=<span class="string">&quot;models&quot;</span>),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这样就可以把<code>get</code>请求绑定到<code>list</code>的方法上,<code>post</code>请求就绑定到了<code>create</code>方法.不需要再去重写它们了</p>
<p>其实上面配置url的方法还是过于繁琐,这时候就是<code>router</code>登场了,上面的代码改为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> appname.views <span class="keyword">import</span> XXXViewSet</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;apiAddress&#x27;</span>, XXXViewSet, base_name=<span class="string">&#x27;apiAddress&#x27;</span>)</span><br><span class="line"></span><br><span class="line">urlpattrtns = [</span><br><span class="line">    <span class="comment"># 这个已经不需要了</span></span><br><span class="line">    <span class="comment"># url(r&#x27;apiAddress/$&#x27;,models, name=&quot;models&quot;),</span></span><br><span class="line">    url(<span class="string">r&#x27;^&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以后再添加url的时候只需要在<code>router</code>里面注册就行了,<code>urlpattrtns</code>列表不需要做任何改动.<br>这样就完成了一个<code>RESTful API</code>的创建, 能够合理搭配<code>mixins</code>,<code>ViewSet</code>和<code>routers</code>三者的话,就可以超快速地开发大量的<code>RESTful API</code>!</p>
<h4 id="使用Django-REST-framework-的过滤功能"><a href="#使用Django-REST-framework-的过滤功能" class="headerlink" title="使用Django REST framework 的过滤功能"></a>使用Django REST framework 的过滤功能</h4><p>一个最简单的过滤功能, 例如查询用户列表,只返回用户粉丝数大于100的:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXXViewSet</span>(<span class="params">mixins.ListModelMixin, mixins.CreateModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line"></span><br><span class="line">    serializer_class = ModelSerializer</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        fans_min = self.reuqest.query_params.get(<span class="string">&quot;fans_min&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> fans_min:</span><br><span class="line">            <span class="keyword">return</span> User.objects.<span class="built_in">filter</span>(fans_num__gt=<span class="built_in">int</span>(fans_min))</span><br><span class="line">        <span class="keyword">return</span> User.objects.<span class="built_in">all</span>()</span><br><span class="line">        </span><br></pre></td></tr></table></figure>
<p>上面这种方法如果要过滤的字段多的话,就要写大量繁琐的业务逻辑代码</p>
<p>如果想以少量的代码实现功能强大的过滤要用其他方案了,就要使用<code>django-filter</code>来完成.<br>首先 <code>pip install django-filter</code>  , 然后把 <code>django-filter</code> 加到 <code>INSTALLED_APPS</code> 列表中</p>
<p>代码实现:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">mixins.ListModelMixin, mixins.CreateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line"></span><br><span class="line">    queryset = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ModelSerializer</span><br><span class="line">    filter_backends = (DjangoFilterBackend,)</span><br><span class="line">    <span class="comment"># 设置过滤字段,这里设置过滤用户的名字和粉丝数</span></span><br><span class="line">    filter_fields = (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;fans_num&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后使用浏览器打开url,<br><img src="/images/django_2.png"><br>就会发现页面多了一个过滤器,点开之后输入信息就可以使用过滤功能了.<br>这种方式还是用局限性,比如用户名想用模糊搜索,或者想要查询粉丝数大于100小于200的用户,这种方式是做不到的.这时候可以使用自定义<code>filter</code>来实现!</p>
<p>新建 filter.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> django_filters</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"></span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFilter</span>(<span class="params">django_filters.rest_framework.FilterSet</span>):</span></span><br><span class="line"></span><br><span class="line">    min_fans_num = django_filter.NumberFilter(name=<span class="string">&#x27;fans_num&#x27;</span>, lookup_expr=<span class="string">&#x27;gte&#x27;</span>)</span><br><span class="line">    max_fans_num = django_filters.NumberFilter(name=<span class="string">&#x27;fans_num&#x27;</span>, lookup_expr=<span class="string">&#x27;lt&#x27;</span>)</span><br><span class="line">    name = django_filters.CharFilter(name=<span class="string">&#x27;name&#x27;</span>,lookup_expr=<span class="string">&#x27;icontains&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;min_fans_num&#x27;</span>, <span class="string">&#x27;max_fans_num&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>然后之前的代码改为:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .<span class="built_in">filter</span> <span class="keyword">import</span> UserFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">mixins.ListModelMixin, mixins.CreateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line"></span><br><span class="line">    queryset = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ModelSerializer</span><br><span class="line">    filter_backends = (DjangoFilterBackend,)</span><br><span class="line">    filter_class = UserFilter</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>过滤用户名的话,其实用<code>SearchFilter</code>也可以实现,用两行代码就完成了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filter_backends = (DjangoFilterBackend, SearchFilter)</span><br><span class="line">search_fields = (<span class="string">&#x27;name&#x27;</span>,)</span><br></pre></td></tr></table></figure>
<p>还有一些更加强大的配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">The search behavior may be restricted by prepending various characters to the ```search_fields```.</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;^&#x27;</span> Starts-<span class="keyword">with</span> search.</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;=&#x27;</span> Exact matches.</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;@&#x27;</span> Full-text search. (Currently only supported Django<span class="string">&#x27;s MySQL backend.)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span>$<span class="string">&#x27; Regex search.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For example:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">search_fields = (&#x27;</span>=username<span class="string">&#x27;, &#x27;</span>=email<span class="string">&#x27;)</span></span><br></pre></td></tr></table></figure>
<p>还有一个排序的<code>filter</code>,例如我们想按照用户的粉丝数量进行排序(升序和降序):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filter_backends = (DjangoFilterBackend, SearchFilter, OrderingFilter)</span><br><span class="line">ordering_fields = (<span class="string">&#x27;fans_num&#x27;</span>,)</span><br></pre></td></tr></table></figure>
<p>这样已经完成了，如果想要做更加复杂的过滤,可以查看<code>django-filter</code>的<a target="_blank" rel="noopener" href="https://django-filter.readthedocs.io/en/master/">文档</a></p>
<h4 id="自定义分页"><a href="#自定义分页" class="headerlink" title="自定义分页"></a>自定义分页</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    <span class="comment"># 指定每一页的个数</span></span><br><span class="line">    page_size = <span class="number">10</span></span><br><span class="line">    <span class="comment"># 可以让前端来设置page_szie参数来指定每页个数</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;page_size&#x27;</span></span><br><span class="line">    <span class="comment"># 设置页码的参数</span></span><br><span class="line">    page_query_param = <span class="string">&#x27;page&#x27;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">mixins.ListModelMixin, mixins.CreateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="comment"># 设置分页的class</span></span><br><span class="line">    pagination_class = UsersPagination</span><br></pre></td></tr></table></figure>
<p>就这样几行代码就搞定了,而且在返回的<code>json</code>中加了总数,下一页的链接和上一页的链接.</p>
<p>回顾我们之前的代码,在<code>UserViewSet</code>这个类里面,才写了7行代码,就已经完成了</p>
<ul>
<li>获取用户列表</li>
<li>create一个用户</li>
<li>分页</li>
<li>搜索</li>
<li>顾虑</li>
<li>排序</li>
</ul>
<p>这些功能,如果想要获取指定用户的具体信息,直接继承<code>mixins.RetrieveModelMixin</code>就直接做好了…’’</p>
<h4 id="权限认证"><a href="#权限认证" class="headerlink" title="权限认证"></a>权限认证</h4><p>比如有一些API功能,是需要用户登录才能使用可以的<br>或者比如我要删除我这篇博客,也要验证我是作者才能删除</p>
<p>验证用户是否登录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXXViewSet</span>(<span class="params">mixins.CreateModelMixin, mixins.DestroyModelMixin</span>):</span></span><br><span class="line">    </span><br><span class="line">    permission_classes = (IsAuthenticated,)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>验证操作是本人,需要自定义<code>persssion</code></p>
<p>permissions.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsOwnerOrReadOnly</span>(<span class="params">permissions.BasePermission</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_object_permission</span>(<span class="params">self, request, view, <span class="built_in">object</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.method <span class="keyword">in</span> permissions.SAFE_METHODS:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">object</span>.user == request.user</span><br></pre></td></tr></table></figure>
<p>permission_classes = (IsAuthenticated, IsOwnerOrReadOnly)</p>
<h4 id="使用JWT的用户认证模式"><a href="#使用JWT的用户认证模式" class="headerlink" title="使用JWT的用户认证模式"></a>使用JWT的用户认证模式</h4><p>第一步: pip install djangorestframework-jwt</p>
<p>第二步: 在url.py中配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_jwt.views <span class="keyword">import</span> obtain_jwt_token</span><br><span class="line">urlpatterns = [</span><br><span class="line">   ...</span><br><span class="line">   url(<span class="string">r&#x27;^api-token-auth/&#x27;</span>, obtain_jwt_token),</span><br><span class="line">   ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>第三步: 在需要jwt认证的ViewSet的类里面设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_jwt.authentication <span class="keyword">import</span> JSONWebTokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> SessionAuthentication</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXXViewSet</span>(<span class="params">mixins.CreateModelMixin, viewsets.GenericViewSet</span>):</span></span><br><span class="line">   authentication_classes = (JSONWebTokenAuthentication, SessionAuthentication)</span><br></pre></td></tr></table></figure>
<p>加上<code>SessionAuthentication</code>是为了在网站上调试方便</p>
<p>现在注册登录有两种方式:</p>
<ul>
<li>用户注册之后跳转到登录页面让其登录</li>
<li>用户注册之后自动帮他登录了</li>
</ul>
<p>第一种情况的话我们无需再做其他操作,第二种情况我们应该在用户注册之后返回<code>jwt token</code>的字段给前台,所以要做两步:</p>
<ul>
<li>因为返回字段是<code>mixins</code>帮我们做好了,所以我们要重写对应的方法来修改返回字段</li>
<li>需要查看<code>djangorestframework-jwt</code>的源码找到生成jwt token的方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_jwt.serializers <span class="keyword">import</span> jwt_encode_handler, jwt_payload_handler</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">CreateModelMixin, RetrieveModelMixin,UpdateModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line">    <span class="comment"># 重写create方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        serializer = self.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        user = self.perform_create(serializer)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 在新建用户保存到数据库之后</span></span><br><span class="line">        tmp_dict = serializer.data</span><br><span class="line">        <span class="comment"># 生成JWT Token</span></span><br><span class="line">        payload = jwt_payload_handler(user)</span><br><span class="line">        tmp_dict[<span class="string">&#x27;token&#x27;</span>] = jwt_encode_handler(payload)</span><br><span class="line"></span><br><span class="line">        headers = self.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(tmp_dict, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>更多jwt的相关操作可以查看<a target="_blank" rel="noopener" href="http://getblimp.github.io/django-rest-framework-jwt/">文档</a></p>
<h4 id="动态serializers"><a href="#动态serializers" class="headerlink" title="动态serializers"></a>动态serializers</h4><p>这个使用之前说过的<code>action</code>属性就可以很方便的实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">CreateModelMixin, RetrieveModelMixin,UpdateModelMixin,viewsets.GenericViewSet</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 这个就不需要了</span></span><br><span class="line">    <span class="comment">#serializer_class = XXXSerializer</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">&#x27;create&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> XXXSerializer</span><br><span class="line">        <span class="keyword">elif</span> self.action == <span class="string">&#x27;list&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> XXXSerializer</span><br><span class="line">        <span class="keyword">return</span> XXXSerializer</span><br></pre></td></tr></table></figure>


<h4 id="一些实用的Serializer-fields"><a href="#一些实用的Serializer-fields" class="headerlink" title="一些实用的Serializer fields"></a>一些实用的Serializer fields</h4><p>比如说我要发布这篇文章,需要上传我(用户)的id才能和这篇文章建立关联,但我们这个可以不用前台来上传</p>
<p>serializer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXXSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="comment"># user默认是当前登录的user</span></span><br><span class="line">    user = serializers.HiddenField(</span><br><span class="line">        default = serializers.CurrentUserDefault()</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>还有如果返回的字段逻辑比较复杂,可以用<code>serializer.SerializerMethodField()</code>来完成,例如:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XXXSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    xxx = serializer.SerializerMethodField()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 把逻辑写在get_的前缀加xxx(字段名),然后返回</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_xxx</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="comment"># 完成你的业务逻辑</span></span><br><span class="line">        <span class="keyword">return</span> </span><br></pre></td></tr></table></figure>

<h4 id="自定义用户认证"><a href="#自定义用户认证" class="headerlink" title="自定义用户认证"></a>自定义用户认证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;Python</span><br><span class="line">from django.contrib.auth.backends import ModelBackend</span><br><span class="line"></span><br><span class="line">class CustomBackend(ModelBackend):</span><br><span class="line">    def authenticate(self, request, username&#x3D;None, password&#x3D;None, **kwargs):</span><br><span class="line">        try:</span><br><span class="line">            user &#x3D; User.objects.get(Q(username&#x3D;username)|Q(mobile&#x3D;username))</span><br><span class="line">            # 验证密码是否正确</span><br><span class="line">            if user.check_password():</span><br><span class="line">                return user</span><br><span class="line">        except Exception as e:</span><br><span class="line">            return None</span><br></pre></td></tr></table></figure>
<p>用户注册的时候,如果你在后台查看的是明文,这是因为<code>ModelSerializer</code>在保存的时候直接明文保存了, 解决问题:</p>
<p>serializer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRegSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#重写create方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>():</span></span><br><span class="line">        user = <span class="built_in">super</span>(UserRegSerializer,self).create(validated_data=validated_data)</span><br><span class="line">        user.set_password(validated_data[<span class="string">&quot;password&quot;</span>])</span><br><span class="line">        user.save()</span><br><span class="line">        <span class="keyword">return</span> user</span><br></pre></td></tr></table></figure>
<p>或者也可以用<code>django</code>的信号量也可以解决</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models.signals <span class="keyword">import</span> post_save</span><br><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> receiver</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line">User = get_user_model()</span><br><span class="line"></span><br><span class="line"><span class="meta">@receiver(<span class="params">post_save, sender=User</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span>(<span class="params">sender, instance=<span class="literal">None</span>, created=<span class="literal">False</span>, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> created:</span><br><span class="line">        password = instance.password</span><br><span class="line">        instance.set_password(password)</span><br><span class="line">        instance.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后还要app.py里面配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> AppConfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersConfig</span>(<span class="params">AppConfig</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ready</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">import</span> users.signals</span><br></pre></td></tr></table></figure>
<p>大功告成！！！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/11/06/Python%E8%A3%85%E9%A5%B0%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/06/Python%E8%A3%85%E9%A5%B0%E5%99%A8/" class="post-title-link" itemprop="url">Python装饰器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-11-06 21:57:36" itemprop="dateCreated datePublished" datetime="2017-11-06T21:57:36+08:00">2017-11-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-15 09:30:38" itemprop="dateModified" datetime="2020-09-15T09:30:38+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>如果对闭包不了解的同学请移步到<a target="_blank" rel="noopener" href="http://zhuyongjia.com/2017/11/06/Python%E9%97%AD%E5%8C%85/">这里</a>先, 因为装饰器要通过闭包来实现</p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>刚开始学Python的时候,装饰器(decorator)一直是个让人难以理解的东西,所以想通过这篇文章能够带你一步一步来理解<strong>Python</strong>装饰器的原理</p>
<h3 id="什么是装饰器"><a href="#什么是装饰器" class="headerlink" title="什么是装饰器?"></a>什么是装饰器?</h3><p>经典的设计模式有23种,设计模式其实也就是巨人们常年写代码经验的思想总结,虽然说这是一种思想,但是由于语法的限制没有办法轻易实现(比如说用C语言来实现组合模式).在面向对象的设计模式中, decorator被称为装饰模式,OOP的装饰模式需要通过继承和组合来实现，而Python除了能支持OOP的decorator外，直接从语法层次支持decorator。</p>
<p>下面开始介绍装饰器的原理</p>
<h4 id="业务逻辑"><a href="#业务逻辑" class="headerlink" title="业务逻辑:"></a>业务逻辑:</h4><p>假如你是简书的开发者,刚开发了一个发布文章的功能:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>():</span></span><br><span class="line">    <span class="comment"># 核心代码</span></span><br><span class="line">    print(<span class="string">&quot;发布成功&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>然后你美滋滋得上传代码了,第二天产品经理拿着刀来找你:你妹啊,随便就能发布文章了?不用登录的?</p>
<p>这时候只需要写一个验证登录的逻辑就好了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_login</span>():</span></span><br><span class="line">    print(<span class="string">&quot;做登录验证&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>然后你就开始纠结了,这段代码怎么放呢?这样?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>():</span></span><br><span class="line">    check_login()</span><br><span class="line">    <span class="comment"># 核心代码</span></span><br><span class="line">    print(<span class="string">&quot;发布成功&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这样确实完成了功能,但是不太优雅,耦合度太高,我们是要写出高质量代码的攻城狮!!!咳咳</p>
<p>所以,我们希望在不改变 <code>send()</code> 代码的前提下,还能做验证登录的操作,装饰器就出现了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_login</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>():</span></span><br><span class="line">        print(<span class="string">&quot;做登录验证&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;开始发布文章&quot;</span>)</span><br><span class="line">        func()</span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>():</span></span><br><span class="line">    <span class="comment"># 核心代码</span></span><br><span class="line">    print(<span class="string">&quot;发布成功&quot;</span>)</span><br><span class="line"></span><br><span class="line">send = check_login(send) <span class="comment">#0</span></span><br><span class="line">send()</span><br></pre></td></tr></table></figure>
<p>可以看到,注释 0 处的代码返回值已经是inner函数对象了.在执行<code>send()</code>的时候实际上就是在执行<code>inner()</code>,这样就能做到不改变原有函数代码的前提下,提升函数的功能!</p>
<p>在<strong>Python</strong>中,有一个语法糖可以不用写<code>注释0处</code>的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@check_login </span><span class="comment">#语法糖</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>():</span></span><br><span class="line">    <span class="comment"># 核心代码</span></span><br><span class="line">    print(<span class="string">&quot;发布成功&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>调用<code>send()</code>结果一样,所以说</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@check_login </span><span class="comment">#语法糖</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>():</span></span><br><span class="line">    <span class="comment"># 核心代码</span></span><br><span class="line">    print(<span class="string">&quot;发布成功&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>和</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">send = check_login(send)</span><br></pre></td></tr></table></figure>
<p>两种写法是等价的!</p>
<p>在上面的代码可以看出来,装饰器个函数,它的参数是被装饰的函数,返回值也是一个函数.</p>
<h3 id="业务逻辑的变动"><a href="#业务逻辑的变动" class="headerlink" title="业务逻辑的变动"></a>业务逻辑的变动</h3><p>有一天你发现,发布文章的代码好像得接收用户编写文章的内容和标题才能发布出现显示给用户看哦(不然就是一堆假数据),然后你赶紧改了一下发布文章的逻辑代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">title,content</span>):</span></span><br><span class="line">    <span class="comment"># 核心代码</span></span><br><span class="line">    print(<span class="string">&quot;文章标题: %s, 内容:%s&quot;</span> % (title,content))</span><br></pre></td></tr></table></figure>
<p>运行就报错了,因为加上装饰器之后调用<code>send(&quot;title&quot;,&quot;content&quot;)</code>是相当于调用了<code>inner()</code>,但是装饰器里的inner并没有接收参数,所以,应该修改装饰器中的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_login</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">*args, **kw</span>):</span></span><br><span class="line">        print(<span class="string">&quot;做登录验证&quot;</span>)</span><br><span class="line">        print(<span class="string">&quot;开始发布文章&quot;</span>)</span><br><span class="line">        func(*args,**kw) <span class="comment">#0</span></span><br><span class="line">    <span class="keyword">return</span> inner</span><br></pre></td></tr></table></figure>
<p>因为注释0代码处才是真正调用了发布文章的原函数,所以得把参数传回去,这样就解决问题了,可以传任意数量和任意类型的参数!!</p>
<h4 id="新的问题"><a href="#新的问题" class="headerlink" title="新的问题"></a>新的问题</h4><p>当你想要拿到发布文章的结果,发布成功或者失败:所以你得改发布文章的逻辑代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@check_login</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">title,content</span>):</span></span><br><span class="line">    <span class="comment"># 核心代码</span></span><br><span class="line">    print(<span class="string">&quot;文章标题: %s, 内容:%s&quot;</span> % (title,content))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后接收</span></span><br><span class="line">result = send(<span class="string">&quot;Python&quot;</span>,<span class="string">&quot;Python的装饰器&quot;</span>)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>
<p>输出结果:<br>做登录验证<br>开始发布文章<br>文章标题: Python, 内容:Python的装饰器<br>None</p>
<p>emmmmm? result怎么回事None呢?如果你能看懂前面内容的话这个小bug对你来说就根本不在话下,修改装饰器的代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def check_login(func):</span><br><span class="line">    def inner(*args, **kw):</span><br><span class="line">        print(&quot;做登录验证&quot;)</span><br><span class="line">        print(&quot;开始发布文章&quot;)</span><br><span class="line">        func(*args,**kw)</span><br><span class="line">    return inner</span><br></pre></td></tr></table></figure>
<p>好了,一步一步到这.一个标准的装饰器终于完成了!!</p>
<h3 id="装饰器的进阶"><a href="#装饰器的进阶" class="headerlink" title="装饰器的进阶"></a>装饰器的进阶</h3><p>上面我们验证登录的装饰器代码中,验证完之后都会<code>print(&quot;开始发布文章&quot;)</code>来做调试.但是,我们不止发布文章的时候要做验证登录的操作,发图片,评论啊,私信啊,回复等等等…都是需要登录验证的装饰器(装饰器的优势体现出来了).然而,你在做其他操作的时候控制台来了一句<strong>开始发布文章</strong> (黑人问号脸????),这时候你就想,要是调试的语句可以控制就好了</p>
<h4 id="装饰器工厂"><a href="#装饰器工厂" class="headerlink" title="装饰器工厂"></a>装饰器工厂</h4><p>装饰器是可以接收自定义参数的,然后返回另一个装饰器.这样看来的话外面的装饰器其实就是个装饰器工厂,根据传来不同的参数生成不同的装饰器:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_decorator</span>(<span class="params">console</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_log</span>(<span class="params">func</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">*args,**kw</span>):</span></span><br><span class="line">            print(console)</span><br><span class="line">            <span class="keyword">return</span> func(*args,**kw)</span><br><span class="line">        <span class="keyword">return</span> inner</span><br><span class="line">    <span class="keyword">return</span> check_log</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="meta">@get_decorator(<span class="params"><span class="string">&quot;开始发布文章&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">title,content</span>):</span></span><br><span class="line">    <span class="comment"># 核心代码</span></span><br><span class="line">    print(<span class="string">&quot;文章标题: %s, 内容:%s&quot;</span> % (title,content))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">result = send(<span class="string">&quot;Python&quot;</span>,<span class="string">&quot;Python的装饰器&quot;</span>)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>
<p><em>get_decorator就是个装饰器工厂,根据参数返回一个装饰器</em></p>
<p>上面的等价拆分的话,等价于</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">check_login = get_decorator(<span class="string">&quot;开始发布文章&quot;</span>)</span><br><span class="line">inner = check_login(send)</span><br><span class="line">send(title,content) = inner(title,content)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/11/06/Python%E9%97%AD%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/11/06/Python%E9%97%AD%E5%8C%85/" class="post-title-link" itemprop="url">Python闭包</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-11-06 20:03:29" itemprop="dateCreated datePublished" datetime="2017-11-06T20:03:29+08:00">2017-11-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-15 09:32:15" itemprop="dateModified" datetime="2020-09-15T09:32:15+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Python基础"><a href="#Python基础" class="headerlink" title="Python基础"></a>Python基础</h3><p>在<code>Python</code>中,函数也是一个对象，而且函数对象可以被赋值给变量，所以，通过变量也能调用该函数。<br>例如:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span>():</span></span><br><span class="line">    print(<span class="string">&#x27;2017-11-06&#x27;</span>)</span><br><span class="line"></span><br><span class="line">f = now</span><br><span class="line">f()    <span class="comment"># 打印 2017-11-06</span></span><br></pre></td></tr></table></figure>

<h3 id="理解什么是闭包"><a href="#理解什么是闭包" class="headerlink" title="理解什么是闭包?"></a>理解什么是闭包?</h3><p>在 <code>Python</code> 中,闭包的概念是:<br>1.首先是个嵌套函数<br>2.内层函数使用了外层函数的变量或者参数<br>3.外层函数把内层函数当做返回值进行返回</p>
<h3 id="一段简单的闭包代码示例"><a href="#一段简单的闭包代码示例" class="headerlink" title="一段简单的闭包代码示例"></a>一段简单的闭包代码示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_outer</span>():</span> <span class="comment"># 外部函数</span></span><br><span class="line">    </span><br><span class="line">    temp = <span class="number">666</span> <span class="comment"># 外部函数的变量</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func_inner</span>():</span> <span class="comment"># 嵌套的内部函数</span></span><br><span class="line">        print(temp) <span class="comment"># 使用了外部函数的变量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> func_inner <span class="comment"># 返回内部函数</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">test = func_outer()</span><br><span class="line">test() <span class="comment"># 打印666</span></span><br></pre></td></tr></table></figure>
<p>由以上可以看出,<code>test</code>变量其实就是返回的<code>func_innter</code>函数对象,<code>test()</code>就是通过这个变量来调用<code>func_innter</code>函数.</p>
<h3 id="闭包的注意点"><a href="#闭包的注意点" class="headerlink" title="闭包的注意点:"></a>闭包的注意点:</h3><h5 id="请思考一下闭包中下面的几种情况"><a href="#请思考一下闭包中下面的几种情况" class="headerlink" title="请思考一下闭包中下面的几种情况"></a>请思考一下闭包中下面的几种情况</h5><p>1.在内层函数修改了外层函数的变量<br>2.在闭包中,引用了一个可能会发生变化的变量</p>
<p>先看第一种情况,对代码进行修改一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_outer</span>():</span></span><br><span class="line">    temp = <span class="number">666</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func_inner</span>():</span></span><br><span class="line">        temp = <span class="number">888</span> <span class="comment"># 0.在内层函数中修改了外层函数的变量的值</span></span><br><span class="line"></span><br><span class="line">    print(temp)  <span class="comment"># 1</span></span><br><span class="line">    func_inner() <span class="comment">#2. 在外部就执行了内部函数</span></span><br><span class="line">    print(temp) <span class="comment"># 3.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> func_inner</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func_outer()</span><br></pre></td></tr></table></figure>
<p>在注释3处,打印的值还是666,这个问题比较简单,因为在注释0代码处相当于重新声明了一个局部变量temp,所以这只是一个作用域的问题(如果你是编程新手的话请打开你的搜索引擎了解作用域的知识)<br>其实很简单,就四个大字: <strong>就近原则</strong></p>
<p>如果要修改外部函数的temp变量使用关键字<code>nonlocal</code>声明:<br>注释0处代码改为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nonlocal</span> temp</span><br><span class="line">temp = <span class="number">888</span></span><br></pre></td></tr></table></figure>

<p>第二种情况,先看代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_outer</span>():</span></span><br><span class="line">    temp = <span class="number">666</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func_inner</span>():</span></span><br><span class="line">        print(temp)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 修改了变量的值</span></span><br><span class="line">    temp = <span class="number">888</span>    </span><br><span class="line">    <span class="keyword">return</span> func_inner</span><br><span class="line">    </span><br><span class="line">test = func_outer()</span><br><span class="line">test()</span><br></pre></td></tr></table></figure>
<p>上面代码在声明内部函数<code>func_inner()</code>之后修改了temp变量的值,然而打印结果却是888.</p>
<p>要想搞懂原因的话可以先写一个小测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_func</span>():</span></span><br><span class="line">    print(nondefine)</span><br></pre></td></tr></table></figure>
<p>上面函数打印了一个未被声明过的变量,但是,如果就这样运行的话程序时没有问题的,照样能正常运行.而当我们调用这个函数的时候<code>test_func()</code>,再次运行程序就报错了.报错原因</p>
<blockquote>
<p>NameError: name ‘nondefine’ is not defined</p>
</blockquote>
<p>上面的测试证明了当一个函数被调用时,它内部变量对应的值才会被确定,这就能解释上面为什么会打印888了.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/06/22/AFNetworking%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/06/22/AFNetworking%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/" class="post-title-link" itemprop="url">AFNetworking源码浅析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-06-22 23:36:52" itemprop="dateCreated datePublished" datetime="2017-06-22T23:36:52+08:00">2017-06-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-15 09:36:56" itemprop="dateModified" datetime="2020-09-15T09:36:56+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在阅读之前，希望先了解 <code>NSURLSession</code> 的使用和 HTTP/HTTPS 的基础知识。</p>
<p>AFNetworking 的结构：</p>
<ul>
<li>Manager（网络通信，处理网络请求）<ul>
<li>AFHTTPSessionManger 和外界交互的，本身并没有做什么事情，AFURLSessionManager 的子类  </li>
<li>AFURLSessionManager  主要的实现逻辑是在这个类</li>
</ul>
</li>
<li>Serialization（网络消息的序列化和反序列化）</li>
<li>Security（网络安全、https）</li>
<li>Reachability （网络状态监听）</li>
</ul>
<h3 id="AFHTTPSessionManger"><a href="#AFHTTPSessionManger" class="headerlink" title="AFHTTPSessionManger"></a>AFHTTPSessionManger</h3><p>这个的主要职责就是：</p>
<h4 id="一、提供初始化的接口"><a href="#一、提供初始化的接口" class="headerlink" title="一、提供初始化的接口"></a>一、提供初始化的接口</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)manager &#123;</span><br><span class="line">    <span class="keyword">return</span> [[[<span class="keyword">self</span> <span class="keyword">class</span>] alloc] initWithBaseURL:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithBaseURL:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBaseURL:(<span class="built_in">NSURL</span> *)url &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithBaseURL:url sessionConfiguration:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithSessionConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithBaseURL:<span class="literal">nil</span> sessionConfiguration:configuration];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBaseURL:(<span class="built_in">NSURL</span> *)url</span><br><span class="line">           sessionConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 具体的实现在 AFURLSessionManager</span></span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithSessionConfiguration:configuration];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.</span></span><br><span class="line">    <span class="keyword">if</span> ([[url path] length] &gt; <span class="number">0</span> &amp;&amp; ![[url absoluteString] hasSuffix:<span class="string">@&quot;/&quot;</span>]) &#123;</span><br><span class="line">        url = [url URLByAppendingPathComponent:<span class="string">@&quot;&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">             </span><br><span class="line">    <span class="keyword">self</span>.baseURL = url;</span><br><span class="line">    <span class="comment">// 2.</span></span><br><span class="line">    <span class="keyword">self</span>.requestSerializer = [AFHTTPRequestSerializer serializer];</span><br><span class="line">    <span class="comment">// 3.</span></span><br><span class="line">    <span class="keyword">self</span>.responseSerializer = [AFJSONResponseSerializer serializer];</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>域名加 <code>/</code> 和不加对服务器是有影响的，不加的话会有很小的损耗。</li>
<li>默认的请求格式是 <code>application/x-www-form-urlencoded</code></li>
<li>默认的响应格式是 <code>json</code></li>
</ol>
<h4 id="二、生成请求任务-NSURLSessionDataTask"><a href="#二、生成请求任务-NSURLSessionDataTask" class="headerlink" title="二、生成请求任务 NSURLSessionDataTask"></a>二、生成请求任务 NSURLSessionDataTask</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithHTTPMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                       URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                      parameters:(<span class="keyword">nullable</span> <span class="keyword">id</span>)parameters</span><br><span class="line">                                         headers:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *)headers</span><br><span class="line">                                  uploadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgress</span><br><span class="line">                                downloadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgress</span><br><span class="line">                                         success:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *task, <span class="keyword">id</span> _Nullable responseObject))success</span><br><span class="line">                                         failure:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> * _Nullable task, <span class="built_in">NSError</span> *error))failure</span><br><span class="line">&#123;</span><br><span class="line">                                           </span><br><span class="line">    <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.</span></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="keyword">self</span>.requestSerializer requestWithMethod:method URLString:[[<span class="built_in">NSURL</span> URLWithString:URLString relativeToURL:<span class="keyword">self</span>.baseURL] absoluteString] parameters:parameters error:&amp;serializationError];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *headerField <span class="keyword">in</span> headers.keyEnumerator) &#123;</span><br><span class="line">        [request setValue:headers[headerField] forHTTPHeaderField:headerField];</span><br><span class="line">    &#125;</span><br><span class="line">                                           </span><br><span class="line">    <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">        <span class="keyword">if</span> (failure) &#123;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                failure(<span class="literal">nil</span>, serializationError);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">                                           </span><br><span class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</span><br><span class="line">                                           </span><br><span class="line">    <span class="comment">// 3.</span></span><br><span class="line">    dataTask = [<span class="keyword">self</span> dataTaskWithRequest:request</span><br><span class="line">                          uploadProgress:uploadProgress</span><br><span class="line">                        downloadProgress:downloadProgress</span><br><span class="line">                       completionHandler:^(<span class="built_in">NSURLResponse</span> * __unused response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (failure) &#123;</span><br><span class="line">                failure(dataTask, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                success(dataTask, responseObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>通过 <code>requestSerializer</code> 来构造 一个 <code>request</code></li>
<li>设置请求头</li>
<li>生成 <code>NSURLSessionDataTask</code> 对象，是在 <code>AFURLSessionManager</code> 中实现的</li>
</ol>
<h3 id="AFURLSessionManager"><a href="#AFURLSessionManager" class="headerlink" title="AFURLSessionManager"></a>AFURLSessionManager</h3><p>我们来看下 <code>AFURLSessionManager</code> 的职责：</p>
<h4 id="一、初始化"><a href="#一、初始化" class="headerlink" title="一、初始化"></a>一、初始化</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithSessionConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!configuration) &#123;</span><br><span class="line">        configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.sessionConfiguration = configuration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.</span></span><br><span class="line">    <span class="keyword">self</span>.operationQueue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.operationQueue.maxConcurrentOperationCount = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.responseSerializer = [AFJSONResponseSerializer serializer];</span><br><span class="line">    <span class="keyword">self</span>.securityPolicy = [AFSecurityPolicy defaultPolicy];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !TARGET_OS_WATCH</span></span><br><span class="line">    <span class="keyword">self</span>.reachabilityManager = [AFNetworkReachabilityManager sharedManager];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.lock = [[<span class="built_in">NSLock</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.lock.name = AFURLSessionManagerLockName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.</span></span><br><span class="line">    [<span class="keyword">self</span>.session getTasksWithCompletionHandler:^(<span class="built_in">NSArray</span> *dataTasks, <span class="built_in">NSArray</span> *uploadTasks, <span class="built_in">NSArray</span> *downloadTasks) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLSessionDataTask</span> *task <span class="keyword">in</span> dataTasks) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addDelegateForDataTask:task uploadProgress:<span class="literal">nil</span> downloadProgress:<span class="literal">nil</span> completionHandler:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLSessionUploadTask</span> *uploadTask <span class="keyword">in</span> uploadTasks) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addDelegateForUploadTask:uploadTask progress:<span class="literal">nil</span> completionHandler:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLSessionDownloadTask</span> *downloadTask <span class="keyword">in</span> downloadTasks) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addDelegateForDownloadTask:downloadTask progress:<span class="literal">nil</span> destination:<span class="literal">nil</span> completionHandler:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>初始化一个串行队列，用来处理网络返回的数据，这是官方规定的一定要串行。</li>
<li>我们可以看到 AF 创建了 <code>session</code> 之后获取到了所有的 <code>task</code>，遍历置为nil。但是我们刚创建 <code>session</code>，应该是不会有任何 <code>task</code> 的。在 <a target="_blank" rel="noopener" href="https://github.com/AFNetworking/AFNetworking/issues/3499">issue</a> 中找到了答案，原因是为了防止从后台进入前台，一些之前的后台请求任务而导致的 <code>crash</code>。</li>
</ol>
<h4 id="二、生成-NSURLSessionDataTask"><a href="#二、生成-NSURLSessionDataTask" class="headerlink" title="二、生成 NSURLSessionDataTask"></a>二、生成 NSURLSessionDataTask</h4><p>之前的 <code>AFHTTPSessionManger</code> 是调用 <code>dataTaskWithRequest</code> 方法来生成 dataTask 的，现在我们来看这个方法做了什么</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               uploadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                             downloadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">                            completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject,  <span class="built_in">NSError</span> * _Nullable error))completionHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSURLSessionDataTask</span> *dataTask = [<span class="keyword">self</span>.session dataTaskWithRequest:request];</span><br><span class="line">   </span><br><span class="line">    [<span class="keyword">self</span> addDelegateForDataTask:dataTask uploadProgress:uploadProgressBlock downloadProgress:downloadProgressBlock completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了 <code>addDelegateForDataTask</code> ，继续跟进去</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addDelegateForDataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">                uploadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">              downloadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">             completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;   </span><br><span class="line">    <span class="comment">// 1. </span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] initWithTask:dataTask];</span><br><span class="line">    <span class="comment">// 2. </span></span><br><span class="line">    delegate.manager = <span class="keyword">self</span>;</span><br><span class="line">    <span class="comment">// 3.</span></span><br><span class="line">    delegate.completionHandler = completionHandler;</span><br><span class="line">    </span><br><span class="line">    dataTask.taskDescription = <span class="keyword">self</span>.taskDescriptionForSessionTasks;</span><br><span class="line">    <span class="comment">// 4.</span></span><br><span class="line">    [<span class="keyword">self</span> setDelegate:delegate forTask:dataTask];</span><br><span class="line">              </span><br><span class="line">    delegate.uploadProgressBlock = uploadProgressBlock;</span><br><span class="line">    delegate.downloadProgressBlock = downloadProgressBlock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里可以看到 <code>AFURLSessionManagerTaskDelegate</code> ，这个类的设计很不错。在介绍这个类之前，先想一个问题，<code>NSURLSession</code> 发送的请求，响应结果是通过代理返回的，如果同时把 A，B，C三个请求发出去，你怎么知道返回的结果是对应这三个的哪个请求呢？AF 是通过 <code>AFURLSessionManagerTaskDelegate</code> 这个类来完成的。</p>
<ol>
<li>创建  <code>AFURLSessionManagerTaskDelegate</code> 对象</li>
<li>设置 delegate 的 manager 属性</li>
<li>把请求回调交给 delegate</li>
<li>这个是最重要的一个方法，是用来绑定 delegate 和 dataTask的一一对应的关系。</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setDelegate:(AFURLSessionManagerTaskDelegate *)delegate</span><br><span class="line">            forTask:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span>.lock lock];</span><br><span class="line">    <span class="comment">// 1.</span></span><br><span class="line">    <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)] = delegate;</span><br><span class="line">    [<span class="keyword">self</span> addNotificationObserverForTask:task];</span><br><span class="line">    [<span class="keyword">self</span>.lock unlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>通过字典来把 dataTask 和 delegate 一一对应起来。</li>
</ol>
<p>这样的话刚才的问题就有答案了，请求结果返回后，通过 <code>mutableTaskDelegatesKeyedByTaskIdentifier</code> 字典就能找到 dataTask 对应的 delegate 对象。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.</span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:task];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delegate may be nil when completing a task in the background</span></span><br><span class="line">    <span class="keyword">if</span> (delegate) &#123;</span><br><span class="line">        <span class="comment">// 2.</span></span><br><span class="line">        [delegate URLSession:session task:task didCompleteWithError:error];</span><br><span class="line">        <span class="comment">// 3.</span></span><br><span class="line">        [<span class="keyword">self</span> removeDelegateForTask:task];</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.taskDidComplete) &#123;</span><br><span class="line">        <span class="keyword">self</span>.taskDidComplete(session, task, error);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>找到 task 对应的 delegate 对象</li>
<li>把任务转发给 delegate 对象</li>
<li>移除 delegate</li>
</ol>
<p>看一下 AF 的代理主要做了什么事</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)URLSession:(__unused <span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic ignored <span class="meta-string">&quot;-Wgnu&quot;</span></span></span><br><span class="line">    __<span class="keyword">strong</span> AFURLSessionManager *manager = <span class="keyword">self</span>.manager;</span><br><span class="line"></span><br><span class="line">    __block <span class="keyword">id</span> responseObject = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    __block <span class="built_in">NSMutableDictionary</span> *userInfo = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    userInfo[AFNetworkingTaskDidCompleteResponseSerializerKey] = manager.responseSerializer;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1.</span></span><br><span class="line">    <span class="comment">//Performance Improvement from #2672</span></span><br><span class="line">    <span class="built_in">NSData</span> *data = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.mutableData) &#123;</span><br><span class="line">        data = [<span class="keyword">self</span>.mutableData <span class="keyword">copy</span>];</span><br><span class="line">        <span class="comment">//We no longer need the reference, so nil it out to gain back some memory.</span></span><br><span class="line">        <span class="keyword">self</span>.mutableData = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteAssetPathKey] = <span class="keyword">self</span>.downloadFileURL;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteResponseDataKey] = data;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. </span></span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteErrorKey] = error;</span><br><span class="line"></span><br><span class="line">        dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.completionHandler) &#123;</span><br><span class="line">                <span class="keyword">self</span>.completionHandler(task.response, responseObject, error);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(url_session_manager_processing_queue(), ^&#123;</span><br><span class="line">            <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">            responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</span><br><span class="line">                responseObject = <span class="keyword">self</span>.downloadFileURL;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (responseObject) &#123;</span><br><span class="line">                userInfo[AFNetworkingTaskDidCompleteSerializedResponseKey] = responseObject;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">                userInfo[AFNetworkingTaskDidCompleteErrorKey] = serializationError;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.completionHandler) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.completionHandler(task.response, responseObject, serializationError);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic pop</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>代码有点多，但是主要就做3件事</p>
<ol>
<li>这里之前是用 <code>[NSData datawithData: self.mutableData]</code> 的，现在用 copy 代替，好像没什么区别？最重要是 <code>self.mutableData = nil</code> 这一句，避免内存过高。</li>
<li>根据 <code>error</code> 参数来区别请求成功还是失败，如果失败就把 <code>error</code> 包装起来回调出去，如果成功就开始做异步解析等操作</li>
</ol>
<p>AFURLSessionManager 还有一个类：<code>_AFURLSessionTaskSwizzling</code> ，看一下它到底做了什么</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_AFURLSessionTaskSwizzling</span></span></span><br><span class="line">  </span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;NSURLSessionTask&quot;</span>)) &#123;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     WARNING: Trouble Ahead</span></span><br><span class="line"><span class="comment">     https://github.com/AFNetworking/AFNetworking/pull/2702</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         iOS 7 and iOS 8 differ in NSURLSessionTask implementation, which makes the next bit of code a bit tricky.</span></span><br><span class="line"><span class="comment">         Many Unit Tests have been built to validate as much of this behavior has possible.</span></span><br><span class="line"><span class="comment">         Here is what we know:</span></span><br><span class="line"><span class="comment">            - NSURLSessionTasks are implemented with class clusters, meaning the class you request from the API isn&#x27;t actually the type of class you will get back.</span></span><br><span class="line"><span class="comment">            - Simply referencing `[NSURLSessionTask class]` will not work. You need to ask an `NSURLSession` to actually create an object, and grab the class from there.</span></span><br><span class="line"><span class="comment">            - On iOS 7, `localDataTask` is a `__NSCFLocalDataTask`, which inherits from `__NSCFLocalSessionTask`, which inherits from `__NSCFURLSessionTask`.</span></span><br><span class="line"><span class="comment">            - On iOS 8, `localDataTask` is a `__NSCFLocalDataTask`, which inherits from `__NSCFLocalSessionTask`, which inherits from `NSURLSessionTask`.</span></span><br><span class="line"><span class="comment">            - On iOS 7, `__NSCFLocalSessionTask` and `__NSCFURLSessionTask` are the only two classes that have their own implementations of `resume` and `suspend`, and `__NSCFLocalSessionTask` DOES NOT CALL SUPER. This means both classes need to be swizzled.</span></span><br><span class="line"><span class="comment">            - On iOS 8, `NSURLSessionTask` is the only class that implements `resume` and `suspend`. This means this is the only class that needs to be swizzled.</span></span><br><span class="line"><span class="comment">            - Because `NSURLSessionTask` is not involved in the class hierarchy for every version of iOS, its easier to add the swizzled methods to a dummy class and manage them there.</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">         Some Assumptions:</span></span><br><span class="line"><span class="comment">            - No implementations of `resume` or `suspend` call super. If this were to change in a future version of iOS, we&#x27;d need to handle it.</span></span><br><span class="line"><span class="comment">            - No background task classes override `resume` or `suspend`</span></span><br><span class="line"><span class="comment">         </span></span><br><span class="line"><span class="comment">         The current solution:</span></span><br><span class="line"><span class="comment">            1) Grab an instance of `__NSCFLocalDataTask` by asking an instance of `NSURLSession` for a data task.</span></span><br><span class="line"><span class="comment">            2) Grab a pointer to the original implementation of `af_resume`</span></span><br><span class="line"><span class="comment">            3) Check to see if the current class has an implementation of resume. If so, continue to step 4.</span></span><br><span class="line"><span class="comment">            4) Grab the super class of the current class.</span></span><br><span class="line"><span class="comment">            5) Grab a pointer for the current class to the current implementation of `resume`.</span></span><br><span class="line"><span class="comment">            6) Grab a pointer for the super class to the current implementation of `resume`.</span></span><br><span class="line"><span class="comment">            7) If the current class implementation of `resume` is not equal to the super class implementation of `resume` AND the current implementation of `resume` is not equal to the original implementation of `af_resume`, THEN swizzle the methods</span></span><br><span class="line"><span class="comment">            8) Set the current class to the super class, and repeat steps 3-8</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">NSURLSessionConfiguration</span> *configuration = [<span class="built_in">NSURLSessionConfiguration</span> ephemeralSessionConfiguration];</span><br><span class="line">        <span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:configuration];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> GCC diagnostic ignored <span class="meta-string">&quot;-Wnonnull&quot;</span></span></span><br><span class="line">        <span class="built_in">NSURLSessionDataTask</span> *localDataTask = [session dataTaskWithURL:<span class="literal">nil</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic pop</span></span><br><span class="line">        IMP originalAFResumeIMP = method_getImplementation(class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(af_resume)));</span><br><span class="line">        Class currentClass = [localDataTask <span class="keyword">class</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (class_getInstanceMethod(currentClass, <span class="keyword">@selector</span>(resume))) &#123;</span><br><span class="line">            Class superClass = [currentClass superclass];</span><br><span class="line">            IMP classResumeIMP = method_getImplementation(class_getInstanceMethod(currentClass, <span class="keyword">@selector</span>(resume)));</span><br><span class="line">            IMP superclassResumeIMP = method_getImplementation(class_getInstanceMethod(superClass, <span class="keyword">@selector</span>(resume)));</span><br><span class="line">            <span class="keyword">if</span> (classResumeIMP != superclassResumeIMP &amp;&amp;</span><br><span class="line">                originalAFResumeIMP != classResumeIMP) &#123;</span><br><span class="line">                [<span class="keyword">self</span> swizzleResumeAndSuspendMethodForClass:currentClass];</span><br><span class="line">            &#125;</span><br><span class="line">            currentClass = [currentClass superclass];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        [localDataTask cancel];</span><br><span class="line">        [session finishTasksAndInvalidate];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)swizzleResumeAndSuspendMethodForClass:(Class)theClass &#123;</span><br><span class="line">    Method afResumeMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(af_resume));</span><br><span class="line">    Method afSuspendMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(af_suspend));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (af_addMethod(theClass, <span class="keyword">@selector</span>(af_resume), afResumeMethod)) &#123;</span><br><span class="line">        af_swizzleSelector(theClass, <span class="keyword">@selector</span>(resume), <span class="keyword">@selector</span>(af_resume));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (af_addMethod(theClass, <span class="keyword">@selector</span>(af_suspend), afSuspendMethod)) &#123;</span><br><span class="line">        af_swizzleSelector(theClass, <span class="keyword">@selector</span>(suspend), <span class="keyword">@selector</span>(af_suspend));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)af_resume &#123;</span><br><span class="line">    <span class="built_in">NSAssert</span>([<span class="keyword">self</span> respondsToSelector:<span class="keyword">@selector</span>(state)], <span class="string">@&quot;Does not respond to state&quot;</span>);</span><br><span class="line">    <span class="built_in">NSURLSessionTaskState</span> state = [<span class="keyword">self</span> state];</span><br><span class="line">    [<span class="keyword">self</span> af_resume];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (state != <span class="built_in">NSURLSessionTaskStateRunning</span>) &#123;</span><br><span class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNSURLSessionTaskDidResumeNotification object:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)af_suspend &#123;</span><br><span class="line">    <span class="built_in">NSAssert</span>([<span class="keyword">self</span> respondsToSelector:<span class="keyword">@selector</span>(state)], <span class="string">@&quot;Does not respond to state&quot;</span>);</span><br><span class="line">    <span class="built_in">NSURLSessionTaskState</span> state = [<span class="keyword">self</span> state];</span><br><span class="line">    [<span class="keyword">self</span> af_suspend];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (state != <span class="built_in">NSURLSessionTaskStateSuspended</span>) &#123;</span><br><span class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNSURLSessionTaskDidSuspendNotification object:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>我们先看 <code>af_resume</code> 和 <code>af_suspend</code> 这两个方法的实现，看起来就是处理原有的逻辑，然后再发一个通知，这个主要是 AF 中 UIKit 拓展使用。</p>
</li>
<li><p>但是 <code>method swizzling</code> 会有 crash 问题</p>
</li>
<li><p>这是因为 <code>NSURLSessionTask</code> 在 iOS7 和 iOS8 的继承链不一样导致的，可以看到上面有很多注释，我把它们翻译一下：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">NSURLSessionTask 的实现在 iOS 7 和 iOS 8 不一样，这使得下面的代码略显棘手</span><br><span class="line"></span><br><span class="line">构建了很多单元测试来验证这种行为是可行的</span><br><span class="line"></span><br><span class="line">以下我们目前所知道的：</span><br><span class="line"></span><br><span class="line">NSURLSessionTask 是通过类簇来实现的，这意味着你从 API 请求拿到的类的类型实际上并不是你想要拿的那个类型</span><br><span class="line">仅仅使用 &#96;[NSURlSessionTask class]&#96; 并没有什么用，你需要创建一个 &#96;NSURLSession&#96; 对象，再通过 &#96;NSURLSession&#96; 对象创建 &#96;NSURLSessionTask&#96; 对象，这样才行。</span><br><span class="line">在 iOS7，&#96;localDatatask&#96; （这个是通过 NSURLSession 对象创建的 NSURLSessionTask对象）的类型是 &#96;__NSCFLocalDataTask&#96; ，它继承 &#96;__NSCFLocalSessionTask&#96;，而 &#96;__NSCFLocalSessionTask&#96; 继承 &#96;__NSCFURLSessionTask&#96;</span><br><span class="line">在 iOS 8， 前面和 iOS 7 的一样，后面 &#96;__NSCFLocalSessionTask&#96; 继承 &#96;NSURLSewssionTask&#96;</span><br><span class="line">在 iOS 7，&#96;__NSCFLocalSessionTask&#96; 和 &#96;__NSCFURLSessionTask&#96; 是仅有的实现了 &#96;resume&#96; 和 &#96;suspend&#96; 方法的两个类。&#96;__NSCFLocalSessionTask&#96; 是不会调用 &#96;super&#96; 的实现，所以这两个类的方法都需要 &#96;method swizzling&#96;</span><br><span class="line">在 iOS 8，只有 &#96;NSURLSessionTask&#96; 这个类实现了 &#96;resume&#96; 和 &#96;suspend&#96; 方法，所以只有这个类需要 &#96;method swizzling&#96;</span><br><span class="line">因为 &#96;NSURLSessionTask&#96; 并不是所有的 iOS 版本都存在，所以把 &#96;method swizzling&#96; 方法写在 dummy class（_AFURLSessionTaskSwizzling）会更加容易管理</span><br><span class="line"></span><br><span class="line">一些假设：</span><br><span class="line"></span><br><span class="line">目前的 &#96;resume&#96; 和 &#96;suspend&#96; 是不会调用父类的实现的，如果在以后的 iOS 版本中修改了，我们需要处理</span><br><span class="line">没有后台 task 类重写 &#96;resume&#96; 和 &#96;suspend&#96;</span><br><span class="line"></span><br><span class="line">目前的解决方案：</span><br><span class="line"></span><br><span class="line">其实就是在讲代码的思路 看代码就行了 也不难懂</span><br></pre></td></tr></table></figure>
<h3 id="AFSecurityPolicy"><a href="#AFSecurityPolicy" class="headerlink" title="AFSecurityPolicy"></a>AFSecurityPolicy</h3><p>在阅读这部分内容之前最好了解 https，可以查看<a target="_blank" rel="noopener" href="https://github.com/youngwind/blog/issues/108">这里</a>自行了解。</p>
<p>AF 就是用 <code>AFSecurityPolicy</code> 这个类来满足各种 https 认证需求。先补充一点前置知识</p>
<p>当你的 app 通过 <code>URLSessionTask</code> 发送请求时，服务器可能会回应一个或多个身份认证质询，session task 会尝试处理，如果处理不来，就会调用 session 的代理方法来处理，如果需要代理来处理认证质询，可是又没有实现对应的方法，服务器可能会拒绝这个请求，返回 <code>401</code> (Forbidden)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSession:(NSURLSession *)session</span><br><span class="line">didReceiveChallenge:(NSURLAuthenticationChallenge *)challenge</span><br><span class="line"> completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition disposition, NSURLCredential *credential))completionHandler</span><br></pre></td></tr></table></figure>
<p>实现这个方法 <code>URLSession:didreceiveChallenge:completionHandler:</code> 是处理整个 session 范围的质询，比如 TLS 验证，一旦成功地处理了这个质询，从这个 session 创建的所有任务仍然有效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (void)URLSession:(NSURLSession *)session</span><br><span class="line">              task:(NSURLSessionTask *)task</span><br><span class="line">didReceiveChallenge:(NSURLAuthenticationChallenge *)challenge</span><br><span class="line"> completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition disposition, NSURLCredential *credential))completionHandler</span><br></pre></td></tr></table></figure>
<p>这个方法是 <code>URLSessionTaskDelegate</code> 协议的，用来处理特殊任务的质询，比如用户名/密码的身份验证质询，每个任务都可能发出自己的质询。如果需要处理 session 范围的质询时，但上面那个方法又没有实现的话，也会调用这个方法来代替。</p>
<h4 id="证书概念"><a href="#证书概念" class="headerlink" title="证书概念"></a>证书概念</h4><p>操作系统存储很多顶级 CA 的证书，由于顶级的 CA 数量有限，所以相对容易管理。那其它的签发商其实是被间接信任的，比如顶级 CA 可以授权多个二级 CA，二级 CA 又可以授权多个三级 CA，发布一个数字签名需要有上一级证书的私钥签名。</p>
<h5 id="根证书"><a href="#根证书" class="headerlink" title="根证书"></a>根证书</h5><p>根证书就是顶级 CA 自签名的证书</p>
<h5 id="证书链"><a href="#证书链" class="headerlink" title="证书链"></a>证书链</h5><p>因为证书是从顶级 CA 开始不断向下授权签发的，当客户端访问HTTPS站点时，服务端会返回整条证书链，一直验证到根证书时，就可以确定证书是否可信</p>
<h4 id="NSURLAuthenticationChallenge"><a href="#NSURLAuthenticationChallenge" class="headerlink" title="NSURLAuthenticationChallenge"></a>NSURLAuthenticationChallenge</h4><p>两个代理方法都会提供一个 <code>NSURLAuthenticationChallenge</code> 对象，它提供了处理认证质询时所需的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@interface NSURLAuthenticationChallenge : NSObject &lt;NSSecureCoding&gt;</span><br><span class="line">&#x2F;&#x2F; 保护空间</span><br><span class="line">@property (readonly, copy) NSURLProtectionSpace *protectionSpace;</span><br><span class="line">&#x2F;&#x2F; 建议的凭证，可能为空，可能是默认的也可能是上次认证失败使用的</span><br><span class="line">@property (nullable, readonly, copy) NSURLCredential *proposedCredential;</span><br><span class="line">&#x2F;&#x2F; 之前认证失败的次数</span><br><span class="line">@property (readonly) NSInteger previousFailureCount;</span><br><span class="line">&#x2F;&#x2F; 最后一个认证失败的 NSURLResponse 对象</span><br><span class="line">@property (nullable, readonly, copy) NSURLResponse *failureResponse;</span><br><span class="line">&#x2F;&#x2F; 最后一个认证失败的 NSError 对象</span><br><span class="line">@property (nullable, readonly, copy) NSError *error;</span><br><span class="line">&#x2F;&#x2F; 质询的发送者</span><br><span class="line">@property (nullable, readonly, retain) id&lt;NSURLAuthenticationChallengeSender&gt; sender;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>其中最核心的属性是 <code>NSURLProtectionSpace *protectionSpace</code> ，这是认证的核心，通常被称为保护空间，表示需要认证的服务器或者域，它定义了一系列的约束去告诉我们需要向服务器提供什么样的认证。通过判断<code>authenticationMethod</code>指定授权方式。当发送一个 HTTPS 请求时，<code>authenticationMethod</code> 的值会是 <code>NSURLAuthenticationMethodServerTrust</code>，这种类型是 App 对服务器进行认证，其他的类型都是服务器对 App 进行认证。对于这种类型，除了以下情况，其他都可以使用默认的处理方式：</p>
<ul>
<li>使用自签名证书</li>
<li>使用 <code>SSL Pinning</code> 防止中间人攻击</li>
</ul>
<p><code>NSURLProtectionSpace</code> 还有一个 <code>SecTrustRef</code> 对象属性，<code>SecTrustRef</code> 对象是服务器传过来的，表示了验证证书链需要的所有内容（证书+策略）</p>
<p>继续看代理方法方法，<code>completionHandler</code> 需要回调 <code>NSURLCredential</code> 和 <code>NSURLSessionAuthChallengeDisposition</code> </p>
<h4 id="NSURLCredential"><a href="#NSURLCredential" class="headerlink" title="NSURLCredential"></a>NSURLCredential</h4><p>验证凭证对象，最常用的初始化方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个 trust 就是从 challenge.protectionSpace.serverTrust 获取</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTrust:(SecTrustRef)trust</span><br></pre></td></tr></table></figure>
<h4 id="NSURLSessionAuthChallengeDisposition"><a href="#NSURLSessionAuthChallengeDisposition" class="headerlink" title="NSURLSessionAuthChallengeDisposition"></a>NSURLSessionAuthChallengeDisposition</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLSessionAuthChallengeUseCredential</span> <span class="comment">// 使用指定的证书</span></span><br><span class="line"><span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span> <span class="comment">// 默认处理方式，会忽略证书</span></span><br><span class="line"><span class="built_in">NSURLSessionAuthChallengeCancelAuthenticationChallenge</span> <span class="comment">// 取消请求，会忽略证书</span></span><br></pre></td></tr></table></figure>
<p>现在看一下  <code>AFSecurityPolicy</code> 是怎么处理的，在这之前先看一下其比较重要的属性：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https 验证模式</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AFSSLPinningMode SSLPinningMode;   </span><br><span class="line"><span class="comment">// 可以匹配服务端证书验证的证书，使用 SSL pinning 会用到 </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">NSSet</span> &lt;<span class="built_in">NSData</span> *&gt; *pinnedCertificates; </span><br><span class="line"><span class="comment">// 是否支持不合法的证书，例如：自签名证书</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> allowInvalidCertificates;</span><br><span class="line"><span class="comment">// 是否验证证书域名</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> validatesDomainName;</span><br></pre></td></tr></table></figure>
<p><code>AFSSLPinningMode</code> 的值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, AFSSLPinningMode) &#123;</span><br><span class="line">    <span class="comment">//不验证</span></span><br><span class="line">    AFSSLPinningModeNone,</span><br><span class="line">    <span class="comment">//只验证公钥</span></span><br><span class="line">    AFSSLPinningModePublicKey,</span><br><span class="line">    <span class="comment">//验证证书</span></span><br><span class="line">    AFSSLPinningModeCertificate,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接下去是 AF 处理 https 的流程</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didReceiveChallenge:(<span class="built_in">NSURLAuthenticationChallenge</span> *)challenge</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition, <span class="built_in">NSURLCredential</span> *credential))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">    __block <span class="built_in">NSURLCredential</span> *credential = <span class="literal">nil</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 1. </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.taskDidReceiveAuthenticationChallenge) &#123;</span><br><span class="line">        disposition = <span class="keyword">self</span>.taskDidReceiveAuthenticationChallenge(session, task, challenge, &amp;credential);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ([challenge.protectionSpace.authenticationMethod isEqualToString:<span class="built_in">NSURLAuthenticationMethodServerTrust</span>]) &#123;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 2. </span></span><br><span class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span>.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]) &#123;</span><br><span class="line">                disposition = <span class="built_in">NSURLSessionAuthChallengeUseCredential</span>;</span><br><span class="line">                credential = [<span class="built_in">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                disposition = <span class="built_in">NSURLSessionAuthChallengeCancelAuthenticationChallenge</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">        completionHandler(disposition, credential);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>如果有自定义block的话就自己做认证处理</li>
<li>调用 <code>AFSecurityPolicy</code> 对象的 <code>evaluateServerTrust</code> 方法，如果验证通过就生成证书对象和使用这个证书，不通过就取消这个请求</li>
</ol>
<p>核心是 <code>evaluateServerTrust</code> 这个方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)evaluateServerTrust:(SecTrustRef)serverTrust</span><br><span class="line">                  forDomain:(<span class="built_in">NSString</span> *)domain</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. </span></span><br><span class="line">    <span class="keyword">if</span> (domain &amp;&amp; <span class="keyword">self</span>.allowInvalidCertificates &amp;&amp; <span class="keyword">self</span>.validatesDomainName &amp;&amp; (<span class="keyword">self</span>.SSLPinningMode == AFSSLPinningModeNone || [<span class="keyword">self</span>.pinnedCertificates count] == <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// https://developer.apple.com/library/mac/documentation/NetworkingInternet/Conceptual/NetworkingTopics/Articles/OverridingSSLChainValidationCorrectly.html</span></span><br><span class="line">        <span class="comment">//  According to the docs, you should only trust your provided certs for evaluation.</span></span><br><span class="line">        <span class="comment">//  Pinned certificates are added to the trust. Without pinned certificates,</span></span><br><span class="line">        <span class="comment">//  there is nothing to evaluate against.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  From Apple Docs:</span></span><br><span class="line">        <span class="comment">//          &quot;Do not implicitly trust self-signed certificates as anchors (kSecTrustOptionImplicitAnchors).</span></span><br><span class="line">        <span class="comment">//           Instead, add your own (self-signed) CA certificate to the list of trusted anchors.&quot;</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;In order to validate a domain name for self signed certificates, you MUST use pinning.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *policies = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="comment">// 2.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.validatesDomainName) &#123;</span><br><span class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateSSL(<span class="literal">true</span>, (__bridge <span class="built_in">CFStringRef</span>)domain)];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateBasicX509()];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    SecTrustSetPolicies(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)policies);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.SSLPinningMode == AFSSLPinningModeNone) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.allowInvalidCertificates || AFServerTrustIsValid(serverTrust);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust) &amp;&amp; !<span class="keyword">self</span>.allowInvalidCertificates) &#123; <span class="comment">// 5。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.SSLPinningMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModeNone:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        <span class="comment">// 7.</span></span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModeCertificate: &#123;</span><br><span class="line">            <span class="built_in">NSMutableArray</span> *pinnedCertificates = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *certificateData <span class="keyword">in</span> <span class="keyword">self</span>.pinnedCertificates) &#123;</span><br><span class="line">                [pinnedCertificates addObject:(__bridge_transfer <span class="keyword">id</span>)SecCertificateCreateWithData(<span class="literal">NULL</span>, (__bridge <span class="built_in">CFDataRef</span>)certificateData)];</span><br><span class="line">            &#125;</span><br><span class="line">            SecTrustSetAnchorCertificates(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)pinnedCertificates);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// obtain the chain after being validated, which *should* contain the pinned certificate in the last position (if it&#x27;s the Root CA)</span></span><br><span class="line">            <span class="built_in">NSArray</span> *serverCertificates = AFCertificateTrustChainForServerTrust(serverTrust);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *trustChainCertificate <span class="keyword">in</span> [serverCertificates reverseObjectEnumerator]) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([<span class="keyword">self</span>.pinnedCertificates containsObject:trustChainCertificate]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 8.</span></span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModePublicKey: &#123;</span><br><span class="line">            <span class="built_in">NSUInteger</span> trustedPublicKeyCount = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">NSArray</span> *publicKeys = AFPublicKeyTrustChainForServerTrust(serverTrust);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">id</span> trustChainPublicKey <span class="keyword">in</span> publicKeys) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">id</span> pinnedPublicKey <span class="keyword">in</span> <span class="keyword">self</span>.pinnedPublicKeys) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (AFSecKeyIsEqualToKey((__bridge SecKeyRef)trustChainPublicKey, (__bridge SecKeyRef)pinnedPublicKey)) &#123;</span><br><span class="line">                        trustedPublicKeyCount += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> trustedPublicKeyCount &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>首先是判断条件：如果有域名，允许自签名证书，要验证域名，那么就不能是 <code>AFSSLPinningModeNone</code> ，和添加的证书为0个</li>
<li>如果需要验证域名，就使用 <code>SecPolicyCreateSSL</code> 函数，如果不需要，就用 <code>SecPolicyCreateBasicX509</code> 函数，这两个函数都是返回 <code>SecPolicyRef</code> 对象，这是一个策略，用于在验证证书链时定义规则：在链中的证书要检查的内容（签名，到期日期等），<code>SecPolicyCreateBasicX509</code> 返回的是验证签名，到期日期等，不用验证域名，<code>SecPolicyCreateSSL</code> 则会多验证域名</li>
<li>告诉服务器客户端如何验证 <code>serverTrust</code></li>
<li>如果 <code>SSLPinningMode == AFSSLPinningModeNone</code> ，这个情况可能是使用自签名，如果是允许自签名或者 <code>AFServerTrustIsValid(serverTrust)</code> 验证通过就返回 true</li>
<li>如果不允许自签名和 <code>AFServerTrustIsValid(serverTrust)</code> 验证不通过返回 false</li>
<li>判断 <code>SSLPinningMode</code> 的值</li>
<li>如果是 <code>AFSSLPinningModeCertificate</code> ，把 <code>pinnedCertificates</code> 数组的证书转成 <code>SecCertificateRef</code> 类型的数据，然后调用 <code>SecTrustSetAnchorCertificates</code> 告诉系统除了维护的证书列表还信任列表中的证书，验证的时候证书链的证书存在这个列表中，则信任该证书，调用 <code>AFServerTrustIsValid</code> 验证证书是否有效， 调用 <code>AFCertificateTrustChainForServerTrust</code>  拿到服务端的证书链，如果有和本地证书匹配的，就验证成功，否则失败</li>
<li><code>AFSSLPinningModePublicKey</code> 模式，这个也是 <code>SSL Pinning</code> 方式验证，只不过只验证证书里的公钥匙，不验证有效期等信息。调用 <code>AFPublicKeyTrustChainForServerTrust</code> 拿到服务端证书链对应的公钥，如果和本地的想匹配，验证成功，否则失败</li>
</ol>
<p>这个方法有一些验证函数，可以看一下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">BOOL</span> AFServerTrustIsValid(SecTrustRef serverTrust) &#123;</span><br><span class="line">    <span class="built_in">BOOL</span> isValid = <span class="literal">NO</span>;</span><br><span class="line">    SecTrustResultType result;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic ignored <span class="meta-string">&quot;-Wdeprecated-declarations&quot;</span></span></span><br><span class="line">    __Require_noErr_Quiet(SecTrustEvaluate(serverTrust, &amp;result), _<span class="keyword">out</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic pop</span></span><br><span class="line"></span><br><span class="line">    isValid = (result == kSecTrustResultUnspecified || result == kSecTrustResultProceed);</span><br><span class="line"></span><br><span class="line">_<span class="keyword">out</span>:</span><br><span class="line">    <span class="keyword">return</span> isValid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>调用 <code>SecTrustEvaluate</code> 方法来评估证书</li>
<li><code>kSecTrustResultUnspecified</code> 表示评估成功，证书被信任，但是用户没有显示信任该证书</li>
<li><code>kSecTrustResultProceed</code> 表示评估成功，用户显示信任</li>
</ol>
<p>其它的函数有兴趣可以自行观看。AFNetworking 这部分写的逻辑有点混乱且复杂，<code>Alamofire</code> 的实现会更加清晰一点。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/07/10/%E5%BD%93UICollectionView%E9%81%87%E4%B8%8A%E5%8A%A8%E7%94%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/07/10/%E5%BD%93UICollectionView%E9%81%87%E4%B8%8A%E5%8A%A8%E7%94%BB/" class="post-title-link" itemprop="url">当UICollectionView遇上动画</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-07-10 22:45:36" itemprop="dateCreated datePublished" datetime="2016-07-10T22:45:36+08:00">2016-07-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-15 09:01:54" itemprop="dateModified" datetime="2020-09-15T09:01:54+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="UICollectionView的简单介绍"><a href="#UICollectionView的简单介绍" class="headerlink" title="UICollectionView的简单介绍"></a>UICollectionView的简单介绍</h3><p>  在iOS6发布前,开发人员都习惯用<code>UITableView</code>来展示所有类型的数据集合。虽然苹果公司在照片应用中使用过很长一段时间类似<code>UICollectionView</code>视图的UI,但第三方开发人员无法使用它。当时我们可以利用第三方框架(如three20)来做类似的功能。在iOS6苹果引入了一个新的控制器<code>UICollectionViewController</code>。提供了一个更加优雅的方法,把各种类型的数据显示在视图中。<br>  现在, 在各种类型的APP中,<code>UICollectionView</code>的身影随处可见,不管在什么应用,总有<code>UICollectionView</code>的应用场景,而苹果也在iOS10中对<code>UICollectionView</code>做了更好的优化。本文主要是展示<code>UICollectionView</code>的常用动画和装逼动画,也会在本文对所有的动画进行详细的讲解。先看效果</p>
<h3 id="效果1"><a href="#效果1" class="headerlink" title="效果1:"></a>效果1:</h3><p><img src="/images/collectionView_1.webp"></p>
<h3 id="效果2-圆形放大"><a href="#效果2-圆形放大" class="headerlink" title="效果2 : 圆形放大"></a>效果2 : 圆形放大</h3><p><img src="/images/collectionView_2.webp"></p>
<h3 id="效果3"><a href="#效果3" class="headerlink" title="效果3 :"></a>效果3 :</h3><p><img src="/images/collectionView_3.webp"></p>
<h3 id="效果4"><a href="#效果4" class="headerlink" title="效果4:"></a>效果4:</h3><p><img src="/images/collectionView_4.webp"></p>
<h4 id="开车前"><a href="#开车前" class="headerlink" title="开车前"></a>开车前</h4><p>大家看标题就能知道,前两个效果需要掌握自定义转场的相关姿势,如果有的同学不太了解,简书上有很多相关的文章.也可以参考下喵神的的博客-&gt;<a target="_blank" rel="noopener" href="https://onevcat.com/2013/10/vc-transition-in-ios7/">WWDC 2013 Session笔记 - iOS7中的ViewController切换</a>.或者先看下相册效果实现的思路.</p>
<h4 id="效果1实现思路"><a href="#效果1实现思路" class="headerlink" title="效果1实现思路"></a>效果1实现思路</h4><p>先说下长按拖拽单元格的实现,这个是最简单的,只需要实现<code>UICollectionView</code>的<code>collectionView?.moveItemAtIndexPath(NSIndexPath, toIndexPath: NSIndexPath)</code>所以我们要先记录移动之前的<code>indexPath</code>记录为<code>lastPath</code>,根据手指的位置获取目标位置的<code>indexPath</code>记录为<code>curPath</code>,移动完成后记录<code>lastPath = curPath</code>就能实现拖拽单元格的动画效果。最后一步就是修改数据源了,刚开始做的时候我<code>傻逼的</code>在手势结束的修改数据源,这是不行的.因为在移动的时候单元格已经变化太多了,所以一定要在移动的状态修改数据源.</p>
<h5 id="添加长按手势"><a href="#添加长按手势" class="headerlink" title="添加长按手势"></a>添加长按手势</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> longGest <span class="operator">=</span> <span class="type">UILongPressGestureRecognizer</span>(target: <span class="keyword">self</span>, action: <span class="string">&quot;longGestHandle:&quot;</span>)</span><br><span class="line">collectionView<span class="operator">?</span>.addGestureRecognizer(longGest)</span><br></pre></td></tr></table></figure>
<h5 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">longGestHandle</span>(<span class="params">longGest</span> : <span class="type">UILongPressGestureRecognizer</span>)</span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">switch</span> longGest.state&#123;</span><br><span class="line">	<span class="keyword">case</span> .<span class="type">Began</span> :</span><br><span class="line">		<span class="comment">// 获取点击的点</span></span><br><span class="line">		<span class="keyword">let</span> touchP <span class="operator">=</span> longGest.locationInView(collectionView)</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 拿到这个点对应的indexPath</span></span><br><span class="line">		<span class="keyword">guard</span> <span class="keyword">let</span> indexPath <span class="operator">=</span> collectionView<span class="operator">?</span>.indexPathForItemAtPoint(touchP) <span class="keyword">else</span> &#123;<span class="keyword">return</span>&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 记录</span></span><br><span class="line">		curPath <span class="operator">=</span> indexPath</span><br><span class="line">		lastPath <span class="operator">=</span> indexPath</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 拿到indexPath对应的cell</span></span><br><span class="line">		<span class="keyword">let</span> cell <span class="operator">=</span> collectionView<span class="operator">?</span>.cellForItemAtIndexPath(indexPath) <span class="keyword">as!</span> <span class="type">TheFirstCell</span></span><br><span class="line">		<span class="keyword">self</span>.cell <span class="operator">=</span> cell</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">let</span> imageView <span class="operator">=</span> <span class="type">UIImageView</span>()</span><br><span class="line">		imageView.frame <span class="operator">=</span> cell.frame</span><br><span class="line">		imageView.image <span class="operator">=</span> cell.image</span><br><span class="line">		imageView.transform <span class="operator">=</span> <span class="type">CGAffineTransformMakeScale</span>(<span class="number">1.15</span>, <span class="number">1.15</span>)</span><br><span class="line">		collectionView<span class="operator">?</span>.addSubview(imageView)</span><br><span class="line">		<span class="keyword">self</span>.imageView <span class="operator">=</span> imageView</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">case</span> .<span class="type">Changed</span> :</span><br><span class="line">		</span><br><span class="line">		cell<span class="operator">?</span>.alpha <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 获取手指的位置</span></span><br><span class="line">		<span class="keyword">let</span> touchP <span class="operator">=</span> longGest.locationInView(collectionView)</span><br><span class="line">		imageView<span class="operator">?</span>.center <span class="operator">=</span> touchP</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 根据手指位置获取对应的indexpath</span></span><br><span class="line">		<span class="keyword">let</span> indexPath <span class="operator">=</span> collectionView<span class="operator">?</span>.indexPathForItemAtPoint(touchP)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (indexPath <span class="operator">!=</span> <span class="literal">nil</span>) &#123;</span><br><span class="line">			curPath <span class="operator">=</span> indexPath</span><br><span class="line">			</span><br><span class="line">			collectionView<span class="operator">?</span>.moveItemAtIndexPath(lastPath<span class="operator">!</span>, toIndexPath: curPath<span class="operator">!</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 修改数据源</span></span><br><span class="line">		<span class="keyword">if</span> lastPath <span class="operator">!=</span> <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="keyword">let</span> lastImg <span class="operator">=</span> imageArr[lastPath<span class="operator">!</span>.item]</span><br><span class="line">		imageArr.removeAtIndex(lastPath<span class="operator">!</span>.item)</span><br><span class="line">		imageArr.insert(lastImg, atIndex: curPath<span class="operator">!</span>.item)</span><br><span class="line">		</span><br><span class="line">		lastPath <span class="operator">=</span> curPath</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">case</span> .<span class="type">Ended</span> :</span><br><span class="line">		</span><br><span class="line">		imageView<span class="operator">?</span>.removeFromSuperview()</span><br><span class="line">		</span><br><span class="line">		cell<span class="operator">?</span>.alpha <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">		</span><br><span class="line">	<span class="keyword">default</span> : <span class="keyword">break</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="图片浏览器思路"><a href="#图片浏览器思路" class="headerlink" title="图片浏览器思路"></a>图片浏览器思路</h4><h5 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h5><ul>
<li>点击<code>cell</code>Modal出来的<code>View</code>是什么类型的?</li>
<li>怎么让Modal的<code>View</code>显示<code>cell</code>里面的图片?</li>
<li>怎么才能知道点击<code>cell</code>的<code>frame</code>?</li>
<li>怎么才能知道dismiss之后<code>cell</code>的<code>frame</code>?</li>
</ul>
<p>第一个问题的答案已经很明显了,肯定是UICollectionView,我们可以在<code>modalVC</code>用属性记录点击cell的indexPath,通过调用<code>    collectionView.scrollToItemAtIndexPath(NSIndexPath, atScrollPosition: UICollectionViewScrollPosition, animated: Bool)</code>,值得注意的是<code>animated</code>要传<code>false</code>,你懂得.<br>关于第三个问题,我们可以直接计算让<code>modalVC</code>的一个属性来接收.我们还可以通过另外一种优雅的方式(代理)来获取。<br>第四个问题,因为最终的<code>indexPath</code>只有<code>modalVC</code>才能知道,所以也能通过代理来获得dismiss之后<code>cell</code>的<code>frame</code>.</p>
<h5 id="协议和代理方法的定义"><a href="#协议和代理方法的定义" class="headerlink" title="协议和代理方法的定义"></a>协议和代理方法的定义</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">PresentedProtocol</span> : <span class="title">class</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getImageView</span>(<span class="params">indexPath</span> : <span class="type">NSIndexPath</span>)</span> -&gt; <span class="type">UIImageView</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getStartRect</span>(<span class="params">indexPath</span> : <span class="type">NSIndexPath</span>)</span> -&gt; <span class="type">CGRect</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getEndRect</span>(<span class="params">indexPath</span> : <span class="type">NSIndexPath</span>)</span> -&gt; <span class="type">CGRect</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getEndCell</span>(<span class="params">indexPath</span> : <span class="type">NSIndexPath</span>)</span> -&gt; <span class="type">TheFirstCell</span>?</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">dismissProtocol</span> : <span class="title">class</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getImageView</span>()</span> -&gt; <span class="type">UIImageView</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getEndRect</span>()</span> -&gt; <span class="type">NSIndexPath</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="代理方法的实现"><a href="#代理方法的实现" class="headerlink" title="代理方法的实现"></a>代理方法的实现</h4><h5 id="Presented部分"><a href="#Presented部分" class="headerlink" title="Presented部分"></a>Presented部分</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">TheFirstViewController</span> : <span class="title">PresentedProtocol</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getImageView</span>(<span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)</span> -&gt; <span class="type">UIImageView</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> imageView <span class="operator">=</span> <span class="type">UIImageView</span>()</span><br><span class="line">        imageView.contentMode <span class="operator">=</span> .<span class="type">ScaleAspectFill</span></span><br><span class="line">        imageView.clipsToBounds <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> cell <span class="operator">=</span> collectionView<span class="operator">?</span>.cellForItemAtIndexPath(indexPath) <span class="keyword">as!</span> <span class="type">TheFirstCell</span></span><br><span class="line">        imageView.image <span class="operator">=</span> cell.imageView.image</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> imageView</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getStartRect</span>(<span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)</span> -&gt; <span class="type">CGRect</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> cell <span class="operator">=</span> collectionView<span class="operator">?</span>.cellForItemAtIndexPath(indexPath) <span class="keyword">as?</span> <span class="type">TheFirstCell</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cell <span class="operator">==</span> <span class="literal">nil</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="type">CGRectZero</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> startRect <span class="operator">=</span>  collectionView<span class="operator">!</span>.convertRect(cell<span class="operator">!</span>.frame, toCoordinateSpace: <span class="type">UIApplication</span>.sharedApplication().keyWindow<span class="operator">!</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> startRect</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getEndRect</span>(<span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)</span> -&gt; <span class="type">CGRect</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell <span class="operator">=</span> collectionView<span class="operator">?</span>.cellForItemAtIndexPath(indexPath) <span class="keyword">as!</span> <span class="type">TheFirstCell</span></span><br><span class="line">        <span class="keyword">return</span> calculateWithImage(cell.imageView.image<span class="operator">!</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getEndCell</span>(<span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)</span> -&gt; <span class="type">TheFirstCell</span>? &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> cell <span class="operator">=</span> collectionView<span class="operator">?</span>.cellForItemAtIndexPath(indexPath) <span class="keyword">as?</span> <span class="type">TheFirstCell</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cell <span class="operator">==</span> <span class="literal">nil</span>&#123;</span><br><span class="line">            collectionView<span class="operator">?</span>.scrollToItemAtIndexPath(indexPath, atScrollPosition: .<span class="type">Right</span>, animated: <span class="literal">false</span>)</span><br><span class="line">            cell <span class="operator">=</span> collectionView<span class="operator">?</span>.cellForItemAtIndexPath(indexPath) <span class="keyword">as?</span> <span class="type">TheFirstCell</span></span><br><span class="line">            <span class="keyword">return</span> cell</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> cell<span class="operator">!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="dismiss部分"><a href="#dismiss部分" class="headerlink" title="dismiss部分"></a>dismiss部分</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK:- dismiss代理方法</span></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">YJBrowserViewController</span> : <span class="title">dismissProtocol</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getImageView</span>()</span> -&gt; <span class="type">UIImageView</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前显示的cell</span></span><br><span class="line">        <span class="keyword">let</span> cell <span class="operator">=</span>  collectionView.visibleCells().first <span class="keyword">as!</span> <span class="type">YJBrowserCell</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> imageView <span class="operator">=</span> <span class="type">UIImageView</span>()</span><br><span class="line">        imageView.image <span class="operator">=</span> cell.imageView.image</span><br><span class="line">        imageView.contentMode <span class="operator">=</span> .<span class="type">ScaleToFill</span></span><br><span class="line">        imageView.clipsToBounds <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">        imageView.frame <span class="operator">=</span> cell.imageView.frame</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> imageView</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">getEndRect</span>()</span> -&gt; <span class="type">NSIndexPath</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前显示的cell</span></span><br><span class="line">        <span class="keyword">let</span> cell <span class="operator">=</span>  collectionView.visibleCells().first <span class="keyword">as!</span> <span class="type">YJBrowserCell</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> collectionView.indexPathForCell(cell)<span class="operator">!</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="动画核心代码"><a href="#动画核心代码" class="headerlink" title="动画核心代码"></a>动画核心代码</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">YJBrowserAnimator</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">presentAnimate</span>(<span class="params">transitionContext</span> : <span class="type">UIViewControllerContextTransitioning</span>)</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取用来做转场动画的&quot;舞台&quot;</span></span><br><span class="line">        <span class="keyword">let</span> containerView <span class="operator">=</span> transitionContext.containerView()</span><br><span class="line">        containerView<span class="operator">?</span>.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.blackColor()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取modal出来的View</span></span><br><span class="line">        <span class="keyword">let</span> toView <span class="operator">=</span> transitionContext.viewForKey(<span class="type">UITransitionContextToViewKey</span>)</span><br><span class="line">        toView<span class="operator">?</span>.alpha <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">        containerView<span class="operator">?</span>.addSubview(toView<span class="operator">!</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 拿到delegate给的imageView</span></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> presentDelegate <span class="operator">=</span> presentDelegate <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> imageView <span class="operator">=</span> presentDelegate.getImageView(indexPath<span class="operator">!</span>)</span><br><span class="line">        </span><br><span class="line">        imageView.frame <span class="operator">=</span> presentDelegate.getStartRect(indexPath<span class="operator">!</span>)</span><br><span class="line">        </span><br><span class="line">        containerView<span class="operator">?</span>.addSubview(imageView)</span><br><span class="line">        </span><br><span class="line">        <span class="type">UIView</span> .animateWithDuration(transitionDuration(transitionContext), animations: &#123; () -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">            imageView.frame <span class="operator">=</span> presentDelegate.getEndRect(<span class="keyword">self</span>.indexPath<span class="operator">!</span>)</span><br><span class="line">            &#125;) &#123; (<span class="keyword">_</span>) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">                toView<span class="operator">?</span>.alpha <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">                imageView.removeFromSuperview()</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 完成动画之后一定要调用这个方法,不然会出现很多意想不到的bug</span></span><br><span class="line">                transitionContext.completeTransition(<span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="效果2实现思路"><a href="#效果2实现思路" class="headerlink" title="效果2实现思路"></a>效果2实现思路</h4><p>首先,要实现这个效果,要用到<code>CALayer</code>的<code>mask</code>属性,<code>mask</code>属性很容易理解,就是一个<code>遮罩</code>,这个动画就是用一个圆形的<code>遮罩</code>不断地放大。<code>遮罩</code>也是一个<code>CALayer</code>,但是<code>CALayer</code>并不能完成这样的效果,这个时候我们可以使用它的子类<code>CAShapeLayer</code>.该子类有个属性<code>path</code>,可以画出各种图形.<br>当点击某个<code>cell</code>的时候,就以它的中心点为圆心,接下来就是求<code>圆形半径</code>的问题了,求半径的思路有两种。</p>
<h4 id="半径思路一"><a href="#半径思路一" class="headerlink" title="半径思路一"></a>半径思路一</h4><p><img src="/images/collectionView_5.webp" alt="求半径图"></p>
<p>注意:如果点击的是<code>cell0</code>,就不能以<code>cell0</code>的中心点连线到左下角了,因为用这样的半径画出来的圆是不能覆盖整个屏幕的,所以要连线到右下角才可以.因此得出<code>x = cell.center.x</code>或者 <code>x = collectionView.width - cell.center.x</code>。我们可以用数学函数<code>max()</code>来获得<code>x值</code>而不是通过复杂的<code>条件语句</code></p>
<h4 id="半径思路二"><a href="#半径思路二" class="headerlink" title="半径思路二"></a>半径思路二</h4><p>以屏幕中心点为圆心,根据屏幕<code>width</code>和<code>height</code>求出来的半径来画一个圆,这样也可以实现.我在dismiss的时候就是用得这个方法。下面上代码</p>
<h5 id="presented部分核心代码"><a href="#presented部分核心代码" class="headerlink" title="presented部分核心代码"></a>presented部分核心代码</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">YJBrowserAnimator</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">maskPresentAnimate</span>(<span class="params">transitionContext</span> : <span class="type">UIViewControllerContextTransitioning</span>)</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.transitionContext <span class="operator">=</span> transitionContext</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> containerView <span class="operator">=</span> transitionContext.containerView()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> toView <span class="operator">=</span> transitionContext.viewForKey(<span class="type">UITransitionContextToViewKey</span>)</span><br><span class="line">        transitionContext.containerView()<span class="operator">!</span>.addSubview(toView<span class="operator">!</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> presentDelegate <span class="operator">=</span> presentDelegate <span class="keyword">else</span>&#123;<span class="keyword">return</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> indexPath <span class="operator">=</span> indexPath <span class="keyword">else</span>&#123;<span class="keyword">return</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> imageView <span class="operator">=</span> presentDelegate.getImageView(indexPath)</span><br><span class="line">        imageView.frame <span class="operator">=</span> presentDelegate.getStartRect(indexPath)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> startCircle <span class="operator">=</span> <span class="type">UIBezierPath</span>(ovalInRect: presentDelegate.getStartRect(indexPath))</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 计算半径</span></span><br><span class="line">        <span class="keyword">let</span> x <span class="operator">=</span> <span class="built_in">max</span>(imageView.center.x, <span class="type">UIScreen</span>.mainScreen().bounds.width <span class="operator">-</span> imageView.center.x)</span><br><span class="line">        <span class="keyword">let</span> y <span class="operator">=</span> <span class="built_in">max</span>(imageView.center.y, <span class="type">CGRectGetHeight</span>(<span class="type">UIScreen</span>.mainScreen().bounds) <span class="operator">-</span> imageView.center.y)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> startRadius <span class="operator">=</span> sqrt(pow(x,<span class="number">2</span>) <span class="operator">+</span> pow(y,<span class="number">2</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> endPath <span class="operator">=</span> <span class="type">UIBezierPath</span>(ovalInRect: <span class="type">CGRectInset</span>(imageView.frame, <span class="operator">-</span>startRadius, <span class="operator">-</span>startRadius))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> shapeLayer <span class="operator">=</span> <span class="type">CAShapeLayer</span>()</span><br><span class="line">        shapeLayer.path <span class="operator">=</span> endPath.<span class="type">CGPath</span></span><br><span class="line">        toView<span class="operator">?</span>.layer.mask <span class="operator">=</span> shapeLayer</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 核心动画</span></span><br><span class="line">        <span class="keyword">let</span> animation <span class="operator">=</span> <span class="type">CABasicAnimation</span>(keyPath: <span class="string">&quot;path&quot;</span>)</span><br><span class="line">        animation.fromValue <span class="operator">=</span> startCircle.<span class="type">CGPath</span></span><br><span class="line">        animation.toValue <span class="operator">=</span> endPath.<span class="type">CGPath</span></span><br><span class="line">        animation.duration <span class="operator">=</span> transitionDuration(transitionContext)</span><br><span class="line">        animation.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">        shapeLayer.addAnimation(animation, forKey: <span class="string">&quot;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">animationDidStop</span>(<span class="params">anim</span>: <span class="type">CAAnimation</span>, <span class="params">finished</span> <span class="params">flag</span>: <span class="type">Bool</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> isMask&#123;</span><br><span class="line">            </span><br><span class="line">            transitionContext<span class="operator">?</span>.completeTransition(<span class="literal">true</span>)</span><br><span class="line">            transitionContext<span class="operator">?</span>.viewControllerForKey(<span class="type">UITransitionContextFromViewControllerKey</span>)<span class="operator">?</span>.view.layer.mask <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">            transitionContext<span class="operator">?</span>.viewForKey(<span class="type">UITransitionContextFromViewKey</span>)<span class="operator">?</span>.removeFromSuperview()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="dismiss部分核心代码"><a href="#dismiss部分核心代码" class="headerlink" title="dismiss部分核心代码"></a>dismiss部分核心代码</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">YJBrowserAnimator</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">maskDismissAnimate</span>(<span class="params">transitionContext</span> : <span class="type">UIViewControllerContextTransitioning</span>)</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.transitionContext <span class="operator">=</span> transitionContext</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> containerView <span class="operator">=</span> transitionContext.containerView()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> fromView <span class="operator">=</span> transitionContext.viewForKey(<span class="type">UITransitionContextFromViewKey</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 拿到要返回的尺寸</span></span><br><span class="line">        <span class="keyword">let</span> startRect <span class="operator">=</span> presentDelegate<span class="operator">?</span>.getStartRect((dismissDelegate<span class="operator">?</span>.getEndRect())<span class="operator">!</span>)</span><br><span class="line">        <span class="keyword">let</span> endPath <span class="operator">=</span> <span class="type">UIBezierPath</span>(ovalInRect: startRect<span class="operator">!</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> radius <span class="operator">=</span> sqrt(pow((containerView<span class="operator">?</span>.frame.size.height)<span class="operator">!</span>,<span class="number">2</span>) <span class="operator">+</span> pow((containerView<span class="operator">?</span>.frame.size.width)<span class="operator">!</span>,<span class="number">2</span>)) <span class="operator">/</span> <span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> startPath <span class="operator">=</span> <span class="type">UIBezierPath</span>(arcCenter: containerView<span class="operator">!</span>.center, radius: radius, startAngle: <span class="number">0</span>, endAngle: <span class="type">CGFloat</span>(<span class="type">M_PI</span> <span class="operator">*</span> <span class="number">2</span>), clockwise: <span class="literal">true</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> shapeLayer <span class="operator">=</span> <span class="type">CAShapeLayer</span>()</span><br><span class="line">        shapeLayer.path <span class="operator">=</span> endPath.<span class="type">CGPath</span></span><br><span class="line">        shapeLayer.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.clearColor().<span class="type">CGColor</span></span><br><span class="line">        fromView<span class="operator">!</span>.layer.mask <span class="operator">=</span> shapeLayer</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> animate <span class="operator">=</span> <span class="type">CABasicAnimation</span>(keyPath: <span class="string">&quot;path&quot;</span>)</span><br><span class="line">        animate.fromValue <span class="operator">=</span> startPath.<span class="type">CGPath</span></span><br><span class="line">        animate.toValue <span class="operator">=</span> endPath.<span class="type">CGPath</span></span><br><span class="line">        animate.duration <span class="operator">=</span> transitionDuration(transitionContext)</span><br><span class="line">        animate.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">        shapeLayer.addAnimation(animate, forKey: <span class="string">&quot;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="效果3动画思路"><a href="#效果3动画思路" class="headerlink" title="效果3动画思路"></a>效果3动画思路</h4><p>首先,介绍<code>UICollectionViewLayout</code>的几个方法,在这个案例中,我们需要<code>重写</code>这几个方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">layoutAttributesForElementsInRect</span>(<span class="keyword">_</span> <span class="params">rect</span>: <span class="type">CGRect</span>)</span> -&gt; [<span class="type">UICollectionViewLayoutAttributes</span>]<span class="operator">?</span></span><br></pre></td></tr></table></figure>
<p>这个方法返回指定<code>rect</code>中<code>cell</code>的布局属性(layoutAttributes)数组。默认返回nil,这个方法是只要拖动<code>UICollectionView</code>的时候就会调用<br>我们来看一下<code>UICollectionViewLayoutAttributes</code>的头文件有哪些属性</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@available</span>(<span class="keyword">iOS</span> <span class="number">6.0</span>, <span class="operator">*</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UICollectionViewLayoutAttributes</span> : <span class="title">NSObject</span>, <span class="title">NSCopying</span>, <span class="title">UIDynamicItem</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> frame: <span class="type">CGRect</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> center: <span class="type">CGPoint</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> size: <span class="type">CGSize</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> transform3D: <span class="type">CATransform3D</span></span><br><span class="line">    <span class="keyword">@available</span>(<span class="keyword">iOS</span> <span class="number">7.0</span>, <span class="operator">*</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> bounds: <span class="type">CGRect</span></span><br><span class="line">    <span class="keyword">@available</span>(<span class="keyword">iOS</span> <span class="number">7.0</span>, <span class="operator">*</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> transform: <span class="type">CGAffineTransform</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> alpha: <span class="type">CGFloat</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> zIndex: <span class="type">Int</span> <span class="comment">// default is 0</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> hidden: <span class="type">Bool</span> <span class="comment">// As an optimization, UICollectionView might not create a view for items whose hidden attribute is YES</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> indexPath: <span class="type">NSIndexPath</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> representedElementCategory: <span class="type">UICollectionElementCategory</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> representedElementKind: <span class="type">String</span>? &#123; <span class="keyword">get</span> &#125; <span class="comment">// nil when representedElementCategory is UICollectionElementCategoryCell</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">convenience</span> <span class="function"><span class="keyword">init</span>(<span class="params">forCellWithIndexPath</span> <span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">convenience</span> <span class="function"><span class="keyword">init</span>(<span class="params">forSupplementaryViewOfKind</span> <span class="params">elementKind</span>: <span class="type">String</span>, <span class="params">withIndexPath</span> <span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">convenience</span> <span class="function"><span class="keyword">init</span>(<span class="params">forDecorationViewOfKind</span> <span class="params">decorationViewKind</span>: <span class="type">String</span>, <span class="params">withIndexPath</span> <span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这个对象可以拿到<code>cell</code>的<code>frame</code>、<code>center</code>、<code>size</code>、<code>transform3D</code>等属性,而且都是<code>readWrite</code>,我们可以利用这个方法,来实时改变<code>cell</code>的<code>transform</code>,达到我们想要的效果</p>
<p>思路:看效果3的gif可以发现,当<code>cell</code>离<code>collectionView</code>得中心点越近,尺寸就越大,当它们的中心点重合的时候,<code>cell</code>的尺寸就是最大。所以要算出<code>cell</code>的中心点和<code>collectionView</code>中心点的距离。</p>
<p><img src="/images/collectionView_6.webp" alt="中心点距离"></p>
<p>图画得不好,大家凑合看看吧。计算完距离,下一步就是要计算缩放比例了,这一步大家可以按照自己的需求来计算.我的方案是:当<code>cell</code>的中心点离<code>collectionView</code>的中心点是<code>collectionView.width * 0.5</code>时,就缩放<code>3/4</code></p>
<h5 id="核心代码-1"><a href="#核心代码-1" class="headerlink" title="核心代码"></a>核心代码</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutAttributesForElementsInRect</span>(<span class="params">rect</span>: <span class="type">CGRect</span>)</span> -&gt; [<span class="type">UICollectionViewLayoutAttributes</span>]<span class="operator">?</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> arr <span class="operator">=</span> <span class="keyword">super</span>.layoutAttributesForElementsInRect(collectionView<span class="operator">!</span>.bounds) <span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> cellAttrs <span class="operator">=</span> <span class="type">NSArray</span>.<span class="keyword">init</span>(array: arr, copyItems: <span class="literal">true</span>) <span class="keyword">as!</span> [<span class="type">UICollectionViewLayoutAttributes</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> cellAttr <span class="keyword">in</span> cellAttrs &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> offsetX <span class="operator">=</span> collectionView<span class="operator">!</span>.contentOffset.x</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> cellDistance <span class="operator">=</span> fabs(cellAttr.center.x <span class="operator">-</span> ((collectionView<span class="operator">?</span>.bounds.width)<span class="operator">!</span> <span class="operator">*</span> <span class="number">0.5</span> <span class="operator">+</span> offsetX))</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> scale <span class="operator">=</span> <span class="number">1</span> <span class="operator">-</span> cellDistance <span class="operator">/</span> ((collectionView<span class="operator">?</span>.bounds.width)<span class="operator">!</span> <span class="operator">*</span> <span class="number">0.5</span>) <span class="operator">*</span> <span class="number">0.25</span></span><br><span class="line">            </span><br><span class="line">            cellAttr.transform <span class="operator">=</span> <span class="type">CGAffineTransformMakeScale</span>(scale, scale)</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cellAttrs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="进一步思考"><a href="#进一步思考" class="headerlink" title="进一步思考"></a>进一步思考</h5><p>能不能在松手的时候计算<code>cell</code>的缩放比例,让比较大的<code>cell</code>的中心点和<code>collectionView</code>的中心点对齐？可以使用这个方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">targetContentOffsetForProposedContentOffset</span>(<span class="keyword">_</span> <span class="params">proposedContentOffset</span>: <span class="type">CGPoint</span>,</span></span><br><span class="line"><span class="function">                           <span class="params">withScrollingVelocity</span> <span class="params">velocity</span>: <span class="type">CGPoint</span>)</span> -&gt; <span class="type">CGPoint</span></span><br></pre></td></tr></table></figure>
<p>当我们松手的时候,就会调用这个方法,默认的返回值是<code>proposedContentOffset</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数说明</span></span><br><span class="line">proposedContentOffset : 该滚动的位置.(举个🌰,踢足球的时候一脚把球踢飞,没人阻拦的情况下足球停下的位置就是proposedContentOffset)</span><br><span class="line">velocity : 滚动的速度</span><br></pre></td></tr></table></figure>
<h5 id="核心代码-2"><a href="#核心代码-2" class="headerlink" title="核心代码"></a>核心代码</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">targetContentOffsetForProposedContentOffset</span>(<span class="params">proposedContentOffset</span>: <span class="type">CGPoint</span>, <span class="params">withScrollingVelocity</span> <span class="params">velocity</span>: <span class="type">CGPoint</span>)</span> -&gt; <span class="type">CGPoint</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> arr <span class="operator">=</span> <span class="keyword">super</span>.layoutAttributesForElementsInRect(<span class="type">CGRect</span>(origin: <span class="type">CGPoint</span>(x: proposedContentOffset.x, y: <span class="number">0</span>), size: collectionView<span class="operator">!</span>.bounds.size)) <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="type">CGPointZero</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> lesserDis <span class="operator">=</span> <span class="type">CGFloat</span>(<span class="type">MAXFLOAT</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> proposedContentOffsetX <span class="operator">=</span> proposedContentOffset.x</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> cellAttr <span class="keyword">in</span> arr &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> cellDistance <span class="operator">=</span> cellAttr.center.x <span class="operator">-</span> (collectionView<span class="operator">!</span>.bounds.width <span class="operator">*</span> <span class="number">0.5</span> <span class="operator">+</span> proposedContentOffset.x)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> fabs(cellDistance) <span class="operator">&lt;</span> fabs(lesserDis) &#123;</span><br><span class="line">            lesserDis <span class="operator">=</span> cellDistance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    proposedContentOffsetX <span class="operator">+=</span> lesserDis</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> proposedContentOffsetX <span class="operator">&lt;</span> <span class="number">0</span>&#123;</span><br><span class="line">        proposedContentOffsetX <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="type">CGPoint</span>(x: proposedContentOffsetX, y: proposedContentOffset.y)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="效果4思路"><a href="#效果4思路" class="headerlink" title="效果4思路"></a>效果4思路</h5><p>和效果3完全一样。</p>
<h4 id="额外补充"><a href="#额外补充" class="headerlink" title="额外补充"></a>额外补充</h4><p>在效果3中,用到了<code>CAShapeLayer</code>和<code>mask</code>.如果还对这两个不太明白的话,推荐一些博客给大家能够更加清楚的了解</p>
<h5 id="关于CAShapeLayer"><a href="#关于CAShapeLayer" class="headerlink" title="关于CAShapeLayer"></a>关于CAShapeLayer</h5><p><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/c5cbb5e05075">放肆的使用UIBezierPath和CAShapeLayer画各种图形</a></p>
<h5 id="关于mask"><a href="#关于mask" class="headerlink" title="关于mask"></a>关于mask</h5><p><a target="_blank" rel="noopener" href="http://joeshang.github.io/2014/12/19/calayer-mask/">关于使用CALayer中mask的一些技巧</a></p>
<p>用好<code>mask</code>能做出比较酷炫的动画,比如<br><img src="/images/collectionView_7.webp" alt="shimmer"><br>或者iPhone锁屏的文字效果<br><img src="/images/collectionView_8.webp" alt="ios_lock_text"></p>
<p>具体可以看下这边文章-&gt;<a target="_blank" rel="noopener" href="http://liyong03.github.io/blog/2014/06/01/facebook-shimmer/">Facebook Shimmer 实现原理</a></p>
<h5 id=""><a href="#" class="headerlink" title=""></a></h5><p>还有iOS10 UICollectionView的新特性<br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/e97780a24224">WWDC2016 Session笔记 - iOS 10 UICollectionView新特性</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/06/12/runtime%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%92%8C%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/06/12/runtime%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%E5%92%8C%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">runtime快速入门和实战</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-06-12 20:24:36" itemprop="dateCreated datePublished" datetime="2016-06-12T20:24:36+08:00">2016-06-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-15 09:19:56" itemprop="dateModified" datetime="2020-09-15T09:19:56+08:00">2020-09-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="什么是runtime"><a href="#什么是runtime" class="headerlink" title="什么是runtime?"></a>什么是runtime?</h3><p>简单来说,<code>runtime</code>就是一个C语言库,包含了很多底层<code>C</code>语言的API。<code>Objective-C</code>语言是一门动态语言,我们平时变编写的<code>Objective-C</code>代码，在程序运行时,最终都是转成了<code>runtime</code>的<code>C</code>语言代码。所以,只有在程序运行时,才会去确定对象的类型，并调用类与对象相应的方法。</p>
<h3 id="利用runtime能做什么"><a href="#利用runtime能做什么" class="headerlink" title="利用runtime能做什么?"></a>利用runtime能做什么?</h3><p>利用<code>runtime</code>机制让我们可以在程序运行时动态修改类对象、对象中的所有属性、方法，就算是私有方法以及私有属性都是可以动态修改的。<code>KVO</code>的底层实现就是利用<code>runtime</code>来实现的</p>
<h3 id="类和对象基本数据结构"><a href="#类和对象基本数据结构" class="headerlink" title="类和对象基本数据结构"></a>类和对象基本数据结构</h3><p>首先,我们来认识一下<code>classes</code>和<code>objects</code>的概念。我们都知道，<code>Objects</code>是由<code>Classes</code>生成,但是在<code>Objective-C</code>中,<code>Classes</code>本身也是<code>objects</code>,也能处理消息,这也就是为什么有类方法和实例方法。</p>
<h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><p>打开objc.h可以看到Class的定义</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>实际上就是一个指向```objc_class```结构体的指针,打开objc/runtime.h中查看```objc_class```的定义</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;objc</span><br><span class="line">struct objc_class &#123;</span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line">#if !__OBJC2__</span><br><span class="line">    Class super_class                                        OBJC2_UNAVAILABLE;  </span><br><span class="line">    const char *name                                         OBJC2_UNAVAILABLE;  </span><br><span class="line">    long version                                             OBJC2_UNAVAILABLE;  </span><br><span class="line">    long info                                                OBJC2_UNAVAILABLE;  </span><br><span class="line">    long instance_size                                       OBJC2_UNAVAILABLE;  </span><br><span class="line">    struct objc_ivar_list *ivars                             OBJC2_UNAVAILABLE;  </span><br><span class="line">    struct objc_method_list **methodLists                    OBJC2_UNAVAILABLE;  </span><br><span class="line">    struct objc_cache *cache                                 OBJC2_UNAVAILABLE;  </span><br><span class="line">    struct objc_protocol_list *protocols                     OBJC2_UNAVAILABLE; </span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br><span class="line">&#x2F;* Use &#96;Class&#96; instead of &#96;struct objc_class *&#96; *&#x2F;</span><br></pre></td></tr></table></figure>
<p>但是，上面的代码有 <code>OBJC2_UNAVAILABLE</code> 标志，这是说明这个结构体在 OC 2.0 版本（2006年发布）已经是不可用的。<br>现在已经变成这个样子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">private:</span><br><span class="line">    isa_t isa;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    cache_t cache;             <span class="comment">// 方法缓存</span></span><br><span class="line">    class_data_bits_t bits;    <span class="comment">// 用来获取类的具体信息</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>objc_object</code> 和 <code>objc_class</code> 就是我们经常会用到的 <code>id</code> 和 <code>Class</code> 类型。</p>
<p><code>objc_object</code> 只包含一个 <code>isa_t</code> 类型的结构体，<code>objc_class</code> 继承于 <code>objc_object</code>，可以得出结论，对象都是有 <code>isa</code> 的，OC中类也是一个对象，那 <code>isa</code> 有什么作用？</p>
<p>当一个对象的实例方法被调用的时候，就会通过 <code>isa</code> 找到对应的类，然后通过该类的 <code>class_data_bits_t</code> 找到对应的实现。如果调用类方法的话，类对象的 <code>isa</code> 就是元类（meta-class）。对象，类，元类之间的关系：</p>
<p><img src="/images/runtime_1.png"></p>
<p>实线是 <code>super_class</code> 指针，虚线是 <code>isa</code> 指针。</p>
<ul>
<li>Root class 其实就是 NSObject，它是没有超类的，superclasss 指向 nil。</li>
<li>NSObject 的元类的 superclass 指向自己。</li>
<li>每个元类对象的 isa 都指向 根元类对象。</li>
</ul>
<h3 id="cache-t"><a href="#cache-t" class="headerlink" title="cache_t"></a>cache_t</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> uint32_t;</span><br><span class="line"><span class="keyword">typedef</span> uint32_t mask_t;  <span class="comment">// x86_64 &amp; arm64 asm are less efficient with 16-bits</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span>  uintptr_t;</span><br><span class="line"><span class="keyword">typedef</span> uintptr_t cache_key_t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> cache_t &#123;</span><br><span class="line">    <span class="keyword">struct</span> bucket_t *_buckets;  <span class="comment">// 散列表</span></span><br><span class="line">    mask_t _mask; <span class="comment">// 散列表的长度 -1</span></span><br><span class="line">    mask_t _occupied; <span class="comment">// 已经缓存的方法数量</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> bucket_t &#123;</span><br><span class="line">private:</span><br><span class="line">    cache_key_t _key;  <span class="comment">// SEL 作为key</span></span><br><span class="line">    IMP _imp;   <span class="comment">// 指向函数的指针</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>cache_t 里面用散列表来缓存曾经调用过的方法，可以提高方法的查找速度。</p>
<h3 id="class-data-bits-t"><a href="#class-data-bits-t" class="headerlink" title="class_data_bits_t"></a>class_data_bits_t</h3><p>使用 <code>bits</code> &amp; <code>FAST_DATA_MASK</code> 可以得到 <code>class_rw_t</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> class_rw_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t version;</span><br><span class="line">    <span class="keyword">const</span> class_ro_t *ro;         <span class="comment">// 只读</span></span><br><span class="line">    method_array_t methods;       <span class="comment">// 方法列表（分类和类的都在这里）</span></span><br><span class="line">    property_array_t properties;  <span class="comment">// 属性列表</span></span><br><span class="line">    protocol_array_t protocols;   <span class="comment">// 协议列表</span></span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line">    <span class="keyword">char</span> *demangledName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> class_ro_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t instanceStart;</span><br><span class="line">    uint32_t instanceSize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    uint32_t reserved;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> uint8_t * ivarLayout;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name;  <span class="comment">// 类名</span></span><br><span class="line">    method_list_t * baseMethodList;</span><br><span class="line">    protocol_list_t * baseProtocols;</span><br><span class="line">    <span class="keyword">const</span> ivar_list_t * ivars;   <span class="comment">// 成员变量列表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uint8_t * weakIvarLayout;</span><br><span class="line">    property_list_t *baseProperties;</span><br><span class="line"></span><br><span class="line">    method_list_t *baseMethods() <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> baseMethodList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>class_rw_t</code> 里面的 methos、properties、protocols是可读可写的二维数组，包含了类的初始内容、分类的内容。</li>
<li><code>class_ro_t</code> 里面的 <code>baseMethodList</code>，<code>baseProtocols</code> ，<code>ivars</code>，<code>baseProperties</code> 是只读的一维数组，包含了类的初始内容。</li>
</ul>
<h3 id="method-t"><a href="#method-t" class="headerlink" title="method_t"></a>method_t</h3><p>method_t 是对方法的封装。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> method_t &#123;</span><br><span class="line">    SEL name;  <span class="comment">// 函数名</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *types; <span class="comment">// 函数编码（返回值类型、参数类型）</span></span><br><span class="line">    IMP imp; <span class="comment">// 指向函数的指针 (函数地址)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>runtime</code> 的源码是开源，可以在<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/objc4/">官方</a>下载，但是官方的是编译不过的，可以到<a href="(https://github.com/RetVal/objc-runtime)">这里</a>下载可以编译的版本</p>
<h2 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h2><p>平常我们使用OC代码来调用方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个People实例</span></span><br><span class="line">People *p = [[People alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用方法</span></span><br><span class="line">[p doSomething];</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对象调用方法,本质上就是给对象”发送消息”,所以以上的代码,在编译时就会转换成<code>runtime</code>的<code>objc_msgSend</code>函数调用</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objc_msgSend(p, <span class="keyword">@selector</span>(doSomething));</span><br></pre></td></tr></table></figure>
<p>objc_msgSend函数会根据接收者和SEL选择器的类型来调用适当的方法,为了完成这个操作,它首先会在自身的isa指针找到自己所属的类(class),然后在这个类(class)的”方法列表”(list of methods)查找该方法,如果找到,就会去执行这个方法。如果找不到,会继续通过自身的super_class指针找到父类的类对象继续查找。如果到最后还是找不到相对应的方法,就会执行”消息转发”操作(将在下文详细介绍)</p>
<p>objc_msgSend函数只能处理部分消息的调用过程,如果有其他“特殊”的情况就会调用另外一些函数来处理,具体会调用哪些函数呢?</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">objc_msgSend_stret: 发送的消息要返回结构体,就可以用这个函数来发送和接收返回值</span><br><span class="line">objc_msgSend_fpret : 发送的消息要返回浮点数,就可以用这个函数来发送和接收返回值</span><br><span class="line">objc_msgSendSuper : 如果要给超类发送信息,例如[<span class="keyword">super</span> doSomething]就可以用这个函数来处理<span class="operator">。</span></span><br></pre></td></tr></table></figure>
<h2 id="Runtime实战"><a href="#Runtime实战" class="headerlink" title="Runtime实战"></a>Runtime实战</h2><p>终于写到这里了,上文说过runtime可以在程序运行时动态添加类、对象、属性、方法等。那我们可以…生成一个”女朋友”？那下面我们来具体实现一下吧</p>
<h4 id="女朋友养成计划"><a href="#女朋友养成计划" class="headerlink" title="女朋友养成计划"></a>女朋友养成计划</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;AppDelegate.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数的两个默认参数:self和_cmd</span></span><br><span class="line"><span class="keyword">void</span> cooking(<span class="keyword">id</span> <span class="keyword">self</span>,SEL _cmd,<span class="keyword">id</span> dish)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过runtime函数获取成员变量 _name</span></span><br><span class="line">    Ivar nameIvar = class_getInstanceVariable([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">    <span class="keyword">id</span> name = object_getIvar(<span class="keyword">self</span>, nameIvar);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过KVC获取成员变量 _age</span></span><br><span class="line">    <span class="built_in">NSInteger</span> age = [[<span class="keyword">self</span> valueForKeyPath:<span class="string">@&quot;age&quot;</span>] integerValue];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;动态添加的女朋友名字是%@,年龄:%ld&quot;</span>,name,age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 动态创建一个继承自NSObject的类</span></span><br><span class="line">        Class GirlFriend = objc_allocateClassPair([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="string">&quot;GirlFriend&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 给“女朋友&quot;添加成员变量 _name</span></span><br><span class="line">        class_addIvar(GirlFriend, <span class="string">&quot;_name&quot;</span>, <span class="keyword">sizeof</span>(<span class="built_in">NSString</span>*), log2(<span class="keyword">sizeof</span>(<span class="built_in">NSString</span>*)), <span class="keyword">@encode</span>(<span class="built_in">NSString</span>*));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 给“女朋友”添加成员变量 _age</span></span><br><span class="line">        class_addIvar(GirlFriend, <span class="string">&quot;_age&quot;</span>, <span class="keyword">sizeof</span>(<span class="built_in">NSInteger</span>), <span class="keyword">sizeof</span>(<span class="built_in">NSInteger</span>), <span class="keyword">@encode</span>(<span class="built_in">NSInteger</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 注册一个名为“cooking”的方法</span></span><br><span class="line">        SEL cook = sel_registerName(<span class="string">&quot;cooking&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 给“女朋友”添加方法</span></span><br><span class="line">        class_addMethod(GirlFriend, cook, (IMP)cooking, <span class="string">&quot;v@:@&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 注册“女朋友”类</span></span><br><span class="line">        objc_registerClassPair(GirlFriend);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建类的实例</span></span><br><span class="line">        <span class="keyword">id</span> gfInstance = [[GirlFriend alloc] init];</span><br><span class="line">        <span class="comment">// class_createInstance这个函数也能创建类实例,不过ARC环境下不能使用</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取类中指定名称的成员变量的信息</span></span><br><span class="line">        Ivar nameIvar = class_getInstanceVariable(GirlFriend, <span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 利用runtime函数为这个成员变量赋值</span></span><br><span class="line">        object_setIvar(gfInstance, nameIvar, <span class="string">@&quot;娃娃&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 利用KVC赋值</span></span><br><span class="line">        [gfInstance setValue:@<span class="number">18</span> forKeyPath:<span class="string">@&quot;age&quot;</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 给对象发送消息</span></span><br><span class="line">        objc_msgSend(gfInstance,cook,<span class="string">@&quot;鱼香肉丝&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        gfInstance = <span class="literal">nil</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 销毁类</span></span><br><span class="line">        objc_disposeClassPair(GirlFriend);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上的函数有几个需要解释一下:</p>
<ul>
<li>class_addIvar:除了第四个参数,相信其他的参数大家都能知道是什么意思.第四个参数我看了下官方文档的解释<blockquote>
<p>The instance variable’s minimum alignment in bytes is 1&lt;&lt;align. The minimum alignment of an instance variable depends on the ivar’s type and the machine architecture. For variables of any pointer type, pass log2(sizeof(pointer_type)).</p>
</blockquote>
</li>
</ul>
<p>成员变量的最小对齐长度是1&lt;&lt;align.这个取决于ivar的类型和机器的架构。任何指针类型的变量,通过log2(sizeof(pointer_type))来进行赋值,而且这个函数只能在objc_allocateClassPair和objc_disposeClassPair之间调用.</p>
<ul>
<li>class_addMethod:最后一个参数,要赋值的是函数的类型。一个函数至少有两个参数(self和_cmd),这两个参数是隐式参数。函数的类型= 返回值+参数类型<br>v 表示 void<br>@ 表示 对象<br>: 表示SEL</li>
<li>objc_disposeClassPair : 如果要销毁的类的实例或者它子类的实例还存在,不能调用这个函数。所以一定要先销毁实例再去销毁类</li>
</ul>
<p>###额外补充<br>在上面的代码中,我们动态创建了类和成员变量,给类添加方法..但是还没有尝试过添加属性。因为添加属性比较麻烦,所以我打算单独给大家说明一下添加属性这个函数的具体使用.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class_addProperty(__<span class="keyword">unsafe_unretained</span> Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> objc_property_attribute_t *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount)</span><br></pre></td></tr></table></figure>
<p>上面的函数用来添加属性,但是第三个参数和第四个参数我们该怎么赋值呢。第三个参数是一个指向objc_property_attribute_t的指针,首先看下它到底是什么</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;           <span class="comment">/**&lt; The name of the attribute */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *value;          <span class="comment">/**&lt; The value of the attribute (usually empty) */</span></span><br><span class="line">&#125; objc_property_attribute_t;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>知道了这是一个结构体,看下文档说明</p>
<blockquote>
<p>attributes:An array of property attributes.<br>attributeCount:The number of attributes in attributes.</p>
</blockquote>
<p>attributes 就是一个数组,里面装着property的attributes(属性).<br>attributeCount 可以理解为数组的个数</p>
<p>知道了attributes是什么了之后,那么问题来了, property 的 attributes是什么呢? 要怎么填?</p>
<p>runtime有一个函数可以拿到property的attributes(属性).那么我们可以试试打印一下看看那是个什么东西.首先,创建一个”MyClass”文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyClass</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>然后随便找个地打印一下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取MyClass类中的name属性</span></span><br><span class="line">objc_property_t property = class_getProperty([MyClass <span class="keyword">class</span>], <span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">// 获取property的属性</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* attribute = property_getAttributes(property);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%s&quot;</span>,attribute);</span><br></pre></td></tr></table></figure>
<p>输出结果:T@”NSString”,C,N,V_name<br>看不懂,好吧..我们找官方文档看看这个字符串是什么意思</p>
<blockquote>
<p>The string starts with a T followed by the @encode type and a comma, and finishes with a V followed by the name of the backing instance variable. Between these, the attributes are specified by the following descriptors, separated by commas</p>
</blockquote>
<p>就是说这个字符串是以T跟着类型编码和逗号开头,以V成员变量的名称结束<br> @ 代表这个property是一个对象 C 代表copy N 代表nonatomic</p>
<p>看到这里我们有能明白了,attributes要赋值一个<code>objc_property_attribute_t</code>结构体类型的数组,而<code>objc_property_attribute_t</code>结构体要赋值的是property的属性。so 我们动手尝试一下吧</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">objc_property_attribute_t type1 = &#123;<span class="string">&quot;T&quot;</span>,<span class="string">&quot;@\&quot;NSString\&quot;&quot;</span>&#125;;</span><br><span class="line">objc_property_attribute_t policy = &#123;<span class="string">&quot;C&quot;</span>,<span class="string">&quot;&quot;</span>&#125;;</span><br><span class="line">objc_property_attribute_t rmw = &#123;<span class="string">&quot;N&quot;</span>,<span class="string">&quot;&quot;</span>&#125;;</span><br><span class="line">objc_property_attribute_t ivar = &#123;<span class="string">&quot;V&quot;</span>,<span class="string">&quot;_introduction&quot;</span>&#125;;</span><br><span class="line">objc_property_attribute_t att[] = &#123;type1,policy,rmw,ivar&#125;;</span><br><span class="line">class_addProperty(GirlFriend, <span class="string">&quot;introduction&quot;</span>, att, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<h3 id="了解女朋友"><a href="#了解女朋友" class="headerlink" title="了解女朋友"></a>了解女朋友</h3><p>了解自己的女朋友是必不可少的,那么我们怎么通过代码来了解呢?<br>首先，创建一个GirlFriend文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">GirlFriend</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *_nativeplace;</span><br><span class="line">    <span class="built_in">NSString</span> *_background;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> age;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>) <span class="keyword">double</span> height;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)AllIvars;</span><br><span class="line">- (<span class="keyword">void</span>)AllPropertys;</span><br><span class="line">- (<span class="keyword">void</span>)cooking;</span><br><span class="line">- (<span class="keyword">void</span>)fitness;</span><br><span class="line">- (<span class="keyword">void</span>)AllMethods;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;GirlFriend.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">GirlFriend</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有的成员变量</span></span><br><span class="line">- (<span class="keyword">void</span>)AllIvars</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    Ivar *ivars = class_copyIvarList(<span class="keyword">self</span>.class, &amp;outCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">        Ivar ivar = ivars[i];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* ivarName = ivar_getName(ivar);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ivarName--%s&quot;</span>,ivarName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(ivars);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有的property</span></span><br><span class="line">- (<span class="keyword">void</span>)AllPropertys</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    objc_property_t *propertys = class_copyPropertyList(<span class="keyword">self</span>.class, &amp;outCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">        objc_property_t property = propertys[i];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* propertyName = property_getName(property);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;propertyName--%s&quot;</span>,propertyName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(propertys);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有方法</span></span><br><span class="line">- (<span class="keyword">void</span>)AllMethods</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    Method *methods = class_copyMethodList(<span class="keyword">self</span>.class, &amp;outCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i++) &#123;</span><br><span class="line">        Method method = methods[i];</span><br><span class="line">        SEL methodName = method_getName(method);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;methodName--%@&quot;</span>,<span class="built_in">NSStringFromSelector</span>(methodName));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(methods);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        GirlFriend *gf = [[GirlFriend alloc] init];</span><br><span class="line">        [gf AllIvars];</span><br><span class="line">        [gf AllPropertys];</span><br><span class="line">        [gf AllMethods];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果:<br><img src="/images/runtime_3.jpeg"></p>
<p>以上的函数都比较简单.但是很实用,比如快速归档和解档.而且要注意一点,因为runtime是C语言的函数,所以遇到<code>copy</code>创建的对象基本上都要用<code>free()</code>函数来释放.</p>
<h3 id="关联对象的使用"><a href="#关联对象的使用" class="headerlink" title="关联对象的使用"></a>关联对象的使用</h3><p>我们可以通过关联对象给女朋友添加属性。首先创建一个女朋友的分类Extension</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;GirlFriend.h&quot;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">GirlFriend</span> (<span class="title">Extension</span>)</span></span><br><span class="line"><span class="comment">// 随便写的</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>) <span class="built_in">NSString</span> *personality;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;GirlFriend+Extension.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">GirlFriend</span> (<span class="title">Extension</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setPersonality:(<span class="built_in">NSString</span> *)personality</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 第一个参数:要给哪个对象添加关联对象</span></span><br><span class="line">    <span class="comment">// 第二个参数:关联的key,注意: void* 相当于 OC中的id类型,所以这个key不是固定的</span></span><br><span class="line">    <span class="comment">// 第三个参数:关联的value</span></span><br><span class="line">    <span class="comment">// 第四个参数:关联的策略</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(personality), personality, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)personality</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 通过key来获取value</span></span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(personality));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关联对象是比较简单的,用得场景也很多.可以看下第三方库的源码.关联对象很常用,.不仅仅是添加属性.</p>
<h3 id="字典转模型"><a href="#字典转模型" class="headerlink" title="字典转模型"></a>字典转模型</h3><p>相信大家都使用过第三方库来实现这个功能,下面我们来了解一下这个功能的具体实现<br>首先新建一个NSObject分类</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">KeyValue</span>)</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)modelWithDictonary:(<span class="built_in">NSDictionary</span> *)dict;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSObject+KeyValue.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">KeyValue</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)modelWithDictonary:(<span class="built_in">NSDictionary</span> *)dict</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> instance = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">    Ivar *ivars = class_copyIvarList(<span class="keyword">self</span>, &amp;outCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; outCount; i++) &#123;</span><br><span class="line">        Ivar ivar = ivars[i];</span><br><span class="line">        <span class="comment">// 获取成员属性名字</span></span><br><span class="line">        <span class="built_in">NSString</span> *name = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getName(ivar)];</span><br><span class="line">        <span class="comment">// 去掉下划线</span></span><br><span class="line">        <span class="built_in">NSString</span> *key = [name substringFromIndex:<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// 根据key获取value</span></span><br><span class="line">        <span class="keyword">id</span> value = dict[key];</span><br><span class="line">        <span class="keyword">if</span> (value) &#123; <span class="comment">// 如果value有值</span></span><br><span class="line">            [instance setValue:value forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>简单实现了具体功能,而且也解决了字典中的<code>key</code>找不到对应的属性也不会Crash</p>
<h3 id="method-swizzling"><a href="#method-swizzling" class="headerlink" title="method swizzling"></a>method swizzling</h3><p>之前提到了方法调用其实就是发消息给对象,那么当对象接收到了消息之后怎么调用对应的方法呢?</p>
<p>消息机制原理:对象根据方法编号SEL在”方法映射表”中找到对应的方法实现.因为<code>Objective-C</code>是动态语言,具体要调用哪个方法要到运行时才决定。所以，我们可以在运行时把<code>SEL</code>对应的方法实现改变一下.我们可以在不修改源码和继承子类覆写方法就能修改一个类本身的功能。这种方法叫method swizzling(俗称”黑魔法”)</p>
<p>回到GirlFriend.h文件,我们给女朋友添加“做家务”的功能</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)housework;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)housework</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;做家务&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)cooking</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;做饭&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需求:让女朋友做饭,她却去做家务</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)load</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 拿到“做饭”方法地址(实例方法,如果要拿到类方法使用class_getClassMethod)</span></span><br><span class="line">    Method cooking = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(cooking));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 拿到&quot;做家务&quot;方法地址</span></span><br><span class="line">    Method housework = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(housework));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 交换地址方法</span></span><br><span class="line">    method_exchangeImplementations(housework, cooking);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后随便找个地验证一下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GirlFriend *gf = [[GirlFriend alloc] init];</span><br><span class="line">[gf cooking];  <span class="comment">// 输出结果: 做家务</span></span><br></pre></td></tr></table></figure>
<p>上面的例子只是简单的交换方法。method swizzling也可以交换系统自带的方法.也能在系统原有的功能里,添加更多的功能。或者迭代开发中处理版本兼容问题也能用到</p>
<h3 id="消息转发机制"><a href="#消息转发机制" class="headerlink" title="消息转发机制"></a>消息转发机制</h3><p>上文说了消息传递机制的原理,那么我们可能还会遇到另一种情况,当发送消息给对象的时候,对象不能解析这条消息(找不到对应的方法)会方法什么情况呢?</p>
<p>当一个对象收到不能解析的消息之后,就会启动”消息转发”机制。我们可以在这个过程告诉对象应该怎么处理!</p>
<ul>
<li> 动态方法解析<br>对象在接收到无法解读的消息后，首先将调用其所属类的下列类方法</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</span><br></pre></td></tr></table></figure>
<p>其返回值是BOOL类型,表示这个是否能新增一个实例方法来处理此选择子,返回NO的话进入下一步</p>
<ul>
<li> 备援接收者<br>当前接收者还有第二次机会能处理不能解析的消息,在这一步中，运行期就会问它，能不能把这条消息转给其他接收者来处理</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</span><br></pre></td></tr></table></figure>
<p>如果返回nil的话就进入下一步</p>
<ul>
<li>完整的消息转发<br>如果已经到了这个步骤的话,就会启动”完整的转发机制”,需要创建<code>NSInvocation</code>对象来进行处理(下文详解)。这个步骤会调用下面方法来进行转发消息</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation</span><br></pre></td></tr></table></figure>
<p>看张图片加深理解<br><img src="/images/runtime_2.jpeg"></p>
<p>模拟场景:如果我们找了一个“女朋友”,谈的时候她跟你说她做饭很好吃!!,等你带回家的时候,发现她根本就不会做饭.这不是坑爹吗？那我们应该怎么办呢?<br>首先在GirlFriend.m文件 把<code>cooking</code>方法的实现给注释掉.<br>随便找块地打印</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GirlFriend *gf = [[GirlFriend alloc] init];</span><br><span class="line">[gf cooking];</span><br></pre></td></tr></table></figure>
<p>报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-[GirlFriend cooking]: unrecognized selector sent to instance 0x7fbef2e0b490</span><br><span class="line">Terminating app due to uncaught exception &#39;NSInvalidArgumentException&#39;, reason: &#39;-[GirlFriend cooking]: unrecognized selector sent to instance 0x7fbef2e0b490&#39;</span><br></pre></td></tr></table></figure>
<p>报错的原因是:你的女朋友根本就不会做饭..</p>
<h4 id="第一步-让女朋友会做饭"><a href="#第一步-让女朋友会做饭" class="headerlink" title="第一步 让女朋友会做饭"></a>第一步 让女朋友会做饭</h4><p>在GrilFriend.m文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</span><br><span class="line">&#123;</span><br><span class="line">    class_addMethod(<span class="keyword">self</span>, sel, (IMP)cooking, <span class="string">&quot;v@:&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> cooking(<span class="keyword">id</span> <span class="keyword">self</span>,SEL _cmd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;会做饭啦&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>随便找块地打印</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GirlFriend *gf = [[GirlFriend alloc] init];</span><br><span class="line">[gf cooking];   <span class="comment">// 输出结果:会做饭啦</span></span><br></pre></td></tr></table></figure>
<h4 id="第二步-让别人来做饭"><a href="#第二步-让别人来做饭" class="headerlink" title="第二步 让别人来做饭"></a>第二步 让别人来做饭</h4><p>如果你的女朋友死活不肯去做饭呢?那我们请个保姆做呗..<br>首先新建Nurse文件<br>.h文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Nurse</span> : <span class="title">NSObject</span></span></span><br><span class="line">- (<span class="keyword">void</span>)cooking;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>.m文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Nurse</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 保姆必须会做饭</span></span><br><span class="line">- (<span class="keyword">void</span>)cooking</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;保姆去做饭啦&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到GirlFriend.m文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    Nurse *n = [[Nurse alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好了,那我们随便找块地打印验证一下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GirlFriend *gf = [[GirlFriend alloc] init];</span><br><span class="line">[gf cooking];   <span class="comment">// 输出结果:保姆去做饭啦</span></span><br></pre></td></tr></table></figure>
<h4 id="第三步-完整的消息转发"><a href="#第三步-完整的消息转发" class="headerlink" title="第三步  完整的消息转发"></a>第三步  完整的消息转发</h4><p>来到这一步的话,说明就要创建并且处理<code>NSInvocation</code>对象。这个对象用起来比较麻烦。所以一般都会在前两步来处理(最好在第一步)</p>
<p>下面我们来使用一下<code>NSInvocation</code>对象<br>GirlFriend.m文件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 因为Invocation对象需要一个函数签名来创建,所以,首先会来到这一步</span></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 创建函数签名</span></span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *sig = [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="string">&quot;v@:&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> sig;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// anInvocation:根据返回的函数签名创建的</span></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">    [anInvocation setTarget:<span class="keyword">self</span>];</span><br><span class="line">    </span><br><span class="line">    [anInvocation setSelector:<span class="keyword">@selector</span>(invocation)];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 函数调用</span></span><br><span class="line">    [anInvocation invoke];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)invocation</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;通过invocation调用&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>打印一下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GirlFriend *gf = [[GirlFriend alloc] init];</span><br><span class="line">[gf cooking];   <span class="comment">// 输出结果:通过invocation调用</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>额外补充</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果方法要传参数的话,可以用这个方法</span></span><br><span class="line"><span class="comment">// 第一个参数:要传的参数</span></span><br><span class="line"><span class="comment">// 第二个参数:参数的位置(注意:要从第2个开始,0和1被self和_cmd占了)</span></span><br><span class="line">anInvocation setArgument:(<span class="keyword">nonnull</span> <span class="keyword">void</span> *) atIndex:(<span class="built_in">NSInteger</span>)</span><br></pre></td></tr></table></figure>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p><a target="_blank" rel="noopener" href="http://southpeak.github.io/blog/2014/10/25/objective-c-runtime-yun-xing-shi-zhi-lei-yu-dui-xiang/">运行时之一:类与对象</a><br><a target="_blank" rel="noopener" href="https://www.amazon.cn/Effective-Objective-C-2-0-%E7%BC%96%E5%86%99%E9%AB%98%E8%B4%A8%E9%87%8FiOS%E4%B8%8EOS-X%E4%BB%A3%E7%A0%81%E7%9A%8452%E4%B8%AA%E6%9C%89%E6%95%88%E6%96%B9%E6%B3%95-%E5%8A%A0%E6%B4%9B%E9%9F%A6/dp/B00IDSGY06/ref=sr_1_1?ie=UTF8&qid=1467204609&sr=8-1&keywords=%E7%BC%96%E5%86%99%E9%AB%98%E8%B4%A8%E9%87%8Fios%E4%BB%A3%E7%A0%81%E7%9A%8452%E4%B8%AA%E6%9C%89%E6%95%88%E6%96%B9%E6%B3%95">Effective Objective C 2.0:编写高质量iOS与OS X代码的52个有效方法</a><br><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/e071206103a4">让你快速上手Runtime</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
